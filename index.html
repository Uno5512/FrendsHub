<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –ª–µ–Ω—Ç–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'rubik': ['Rubik', 'sans-serif'],
                    },
                    backgroundImage: {
                        'dot-grid': 'radial-gradient(circle, #e5e7eb 1px, transparent 1px)',
                    },
                    backgroundSize: {
                        '12px': '12px 12px',
                    },
                    backdropBlur: {
                        xs: '2px',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-image: radial-gradient(circle, #e5e7eb 1px, transparent 1px);
            background-size: 12px 12px;
            background-color: #f8f4f2;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(6px);
            border: 1px solid rgba(225, 222, 219, 0.5);
        }
        
        .status-dot {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .create-btn {
            border: 2px dashed #383533;
            transition: all 0.3s ease;
        }

        .create-btn:hover {
            border-color: #fbede0;
            background-color: rgba(251, 237, 224, 0.1);
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="font-rubik min-h-screen text-[#383533]">
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- Header —Å –∫–Ω–æ–ø–∫–æ–π —Å–æ–∑–¥–∞–Ω–∏—è -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3 text-sm">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-red-500 status-dot" id="statusDot"></div>
                    <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                </div>
                <span class="text-[#383533]/50">|</span>
                <span id="friendCount">–î—Ä—É–∑–µ–π: 0</span>
                <span class="text-[#383533]/50">|</span>
                <span id="postCount">–ó–∞–ø–∏—Å–µ–π: 0</span>
            </div>
            
            <button id="createPostBtn" class="create-btn rounded-lg px-4 py-2 flex items-center gap-2 text-[#383533] hover:text-[#383533]/80">
                <svg width="20" height="20" viewBox="0 0 400 400" fill="none">
                    <path d="M71.8708 189.953C76.0596 179.972 67.0124 166.184 74.2179 157.188C75.8153 155.199 122.602 153.152 125.561 155.514C136.45 164.206 111.415 193.423 144.018 201.553C171.926 208.513 155.397 160.743 162.516 157.188C171.049 152.934 188.865 158.57 198.547 157.188C226.846 153.158 203.311 181.664 211.97 193.182C217.423 200.435 261.828 185.402 250.56 219.132C244.647 236.825 226.375 230.776 216.164 235.873C211.338 238.281 215.898 272.743 215.1 272.582C205.09 270.587 157.177 275.336 158.734 276.89C168.054 286.189 186.94 229.756 144.018 235.873C133.985 237.301 125.13 246.004 123.884 255.963C123.16 261.765 125.774 278.518 125.561 278.564C113.242 281.023 100.187 277.778 86.9713 281.075C84.5867 281.671 67.5038 288.431 65.9983 286.935C63.3552 284.292 66.3776 262.486 66.8373 258.788C67.5727 252.946 65.9754 240.01 71.8708 240.01C84.7533 240.01 42.0914 251.826 29.6626 235.873C17.2337 219.92 29.6626 189.953 66.8373 198.994" stroke="currentColor" stroke-width="16" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M219.962 158.69C301.398 167.678 215.1 108.884 284.641 112.13C309.301 113.281 287.258 146.158 293.857 154.973C299.085 161.97 334.878 147.654 341.615 156.653C345.643 162.039 327.578 197.327 334.074 199.496C339.004 201.142 350.98 188.742 359.204 191.096C376.15 195.952 380.691 231.713 365.907 238.979C351.123 246.245 341.747 240.521 340.777 241.5C336.129 246.154 349.597 267.685 346.642 275.102C344.754 279.832 305.714 287.83 301.398 283.503C292.4 274.481 309.369 240.976 291.344 236.459C265.56 229.998 276.039 267.893 267.046 270.902C254.301 275.16 229.326 272.582 215.1 272.582" stroke="currentColor" stroke-width="16" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="font-medium">–°–æ–∑–¥–∞—Ç—å</span>
            </button>
        </div>

        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
        <div class="relative mb-6">
            <div id="categoryContainer" class="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide py-2">
                <div id="categories" class="flex space-x-3 px-4">
                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞ -->
        <div id="createForm" class="glass rounded-2xl p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4">–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</h2>
            <div class="space-y-4">
                <input type="text" id="postTitle" 
                       placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫..." 
                       class="w-full px-4 py-3 rounded-xl border border-[#e1dedb]/50 focus:border-[#fbede0] focus:outline-none bg-white/70">
                
                <textarea id="postDescription" 
                          placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..." 
                          rows="3"
                          class="w-full px-4 py-3 rounded-xl border border-[#e1dedb]/50 focus:border-[#fbede0] focus:outline-none bg-white/70 resize-none"></textarea>
                
                <input type="text" id="postTags" 
                       placeholder="–¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é" 
                       class="w-full px-4 py-3 rounded-xl border border-[#e1dedb]/50 focus:border-[#fbede0] focus:outline-none bg-white/70">
                
                <textarea id="postContacts" 
                          placeholder="–í–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Å—Å—ã–ª–∫–∏..." 
                          rows="2"
                          class="w-full px-4 py-3 rounded-xl border border-[#e1dedb]/50 focus:border-[#fbede0] focus:outline-none bg-white/70 resize-none"></textarea>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <select id="postCity" class="px-4 py-3 rounded-xl border border-[#e1dedb]/50 focus:border-[#fbede0] focus:outline-none bg-white/70">
                        <option value="">–ì–æ—Ä–æ–¥</option>
                        <option value="moscow">–ú–æ—Å–∫–≤–∞</option>
                        <option value="spb">–°–ü–±</option>
                        <option value="ekb">–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥</option>
                        <option value="nsk">–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫</option>
                        <option value="other">–î—Ä—É–≥–æ–π</option>
                    </select>
                    
                    <select id="postGender" class="px-4 py-3 rounded-xl border border-[#e1dedb]/50 focus:border-[#fbede0] focus:outline-none bg-white/70">
                        <option value="">–ü–æ–ª</option>
                        <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                        <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                        <option value="any">–õ—é–±–æ–π</option>
                    </select>
                    
                    <select id="postAge" class="px-4 py-3 rounded-xl border border-[#e1dedb]/50 focus:border-[#fbede0] focus:outline-none bg-white/70">
                        <option value="">–í–æ–∑—Ä–∞—Å—Ç</option>
                        <option value="18-25">18-25</option>
                        <option value="26-35">26-35</option>
                        <option value="36-45">36-45</option>
                        <option value="46+">46+</option>
                    </select>

                    <select id="postType" class="px-4 py-3 rounded-xl border border-[#e1dedb]/50 focus:border-[#fbede0] focus:outline-none bg-white/70">
                        <option value="event">–°–æ–±—ã—Ç–∏–µ</option>
                        <option value="meet">–í—Å—Ç—Ä–µ—á–∞</option>
                        <option value="help">–ü–æ–º–æ—â—å</option>
                        <option value="sale">–ü—Ä–æ–¥–∞–∂–∞</option>
                        <option value="other">–î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="createPost()" 
                            class="flex-1 bg-[#383533] hover:bg-[#383533]/90 text-white font-medium py-3 px-6 rounded-xl transition-colors">
                        –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
                    </button>
                    <button onclick="cancelCreate()" 
                            class="px-6 py-3 border border-[#e1dedb]/50 rounded-xl text-[#383533] hover:bg-white/50 transition-colors">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="glass rounded-2xl p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <input type="text" id="searchBox" 
                       placeholder="üîç –ü–æ–∏—Å–∫..." 
                       oninput="filterPosts()"
                       class="md:col-span-2 px-4 py-3 rounded-xl border border-[#e1dedb]/50 focus:border-[#fbede0] focus:outline-none bg-white/70">
                
                <select id="filterCity" onchange="filterPosts()" class="px-4 py-3 rounded-xl border border-[#e1dedb]/50 focus:border-[#fbede0] focus:outline-none bg-white/70">
                    <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
                    <option value="moscow">–ú–æ—Å–∫–≤–∞</option>
                    <option value="spb">–°–ü–±</option>
                    <option value="ekb">–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥</option>
                    <option value="nsk">–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫</option>
                    <option value="other">–î—Ä—É–≥–æ–π</option>
                </select>

                <select id="filterGender" onchange="filterPosts()" class="px-4 py-3 rounded-xl border border-[#e1dedb]/50 focus:border-[#fbede0] focus:outline-none bg-white/70">
                    <option value="">–õ—é–±–æ–π –ø–æ–ª</option>
                    <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                    <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                    <option value="any">–õ—é–±–æ–π</option>
                </select>

                <select id="filterAge" onchange="filterPosts()" class="px-4 py-3 rounded-xl border border-[#e1dedb]/50 focus:border-[#fbede0] focus:outline-none bg-white/70">
                    <option value="">–õ—é–±–æ–π –≤–æ–∑—Ä–∞—Å—Ç</option>
                    <option value="18-25">18-25</option>
                    <option value="26-35">26-35</option>
                    <option value="36-45">36-45</option>
                    <option value="46+">46+</option>
                </select>
                
                <select id="filterSort" onchange="filterPosts()" class="px-4 py-3 rounded-xl border border-[#e1dedb]/50 focus:border-[#fbede0] focus:outline-none bg-white/70">
                    <option value="new">–ù–æ–≤—ã–µ</option>
                    <option value="old">–°—Ç–∞—Ä—ã–µ</option>
                    <option value="liked">–ü–æ –ª–∞–π–∫–∞–º</option>
                    <option value="my">–ú–æ–∏</option>
                    <option value="favorites">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</option>
                    <option value="hidden">–°–∫—Ä—ã—Ç—ã–µ</option>
                </select>
            </div>
            
            <button onclick="resetFilters()" 
                    class="mt-4 bg-[#383533]/10 hover:bg-[#383533]/20 text-[#383533] font-medium py-2 px-4 rounded-lg transition-colors">
                –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
            </button>
        </div>

        <!-- –õ–µ–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤ -->
        <div id="postsFeed">
            <div class="glass rounded-2xl p-8 text-center">
                <div class="text-6xl mb-4">üöÄ</div>
                <p class="text-[#383533]/60">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å –∏–ª–∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ç–∏!</p>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
        <div id="contactModal" class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-30 hidden">
            <div class="bg-[#f8f4f2] rounded-xl max-w-md w-full max-h-[80vh] shadow-2xl flex flex-col">
                <div class="p-5 pb-3">
                    <h2 class="text-lg font-semibold">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
                </div>
                <div class="flex-1 overflow-y-auto px-5">
                    <div id="contactContent" class="text-sm text-[#383533]/80"></div>
                </div>
                <div class="border-t border-[#e1dedb]/30 p-4">
                    <button id="closeContactModal" class="w-full px-4 py-2 bg-[#383533] text-white rounded-lg text-sm hover:bg-[#383533]/90 transition-colors">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CRDT –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
        class CRDT {
            constructor() {
                this.state = new Map();
                this.vectorClock = new Map();
                this.nodeId = this.generateNodeId();
            }

            generateNodeId() {
                return 'node_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
            }

            update(key, value, timestamp = Date.now()) {
                const currentClock = this.vectorClock.get(this.nodeId) || 0;
                this.vectorClock.set(this.nodeId, Math.max(currentClock, timestamp));
                
                const entry = {
                    value,
                    timestamp,
                    nodeId: this.nodeId,
                    vectorClock: new Map(this.vectorClock)
                };

                if (!this.state.has(key) || this.shouldUpdate(this.state.get(key), entry)) {
                    this.state.set(key, entry);
                    return true;
                }
                return false;
            }

            shouldUpdate(existing, incoming) {
                if (incoming.timestamp > existing.timestamp) return true;
                if (incoming.timestamp === existing.timestamp) {
                    return incoming.nodeId > existing.nodeId;
                }
                return false;
            }

            merge(otherState) {
                let updated = false;
                for (const [key, entry] of otherState) {
                    if (!this.state.has(key) || this.shouldUpdate(this.state.get(key), entry)) {
                        this.state.set(key, entry);
                        updated = true;
                    }
                    
                    const incomingClock = entry.vectorClock.get(entry.nodeId) || 0;
                    const currentClock = this.vectorClock.get(entry.nodeId) || 0;
                    this.vectorClock.set(entry.nodeId, Math.max(currentClock, incomingClock));
                }
                return updated;
            }

            get(key) {
                const entry = this.state.get(key);
                return entry ? entry.value : undefined;
            }

            getAll() {
                const result = new Map();
                for (const [key, entry] of this.state) {
                    result.set(key, entry.value);
                }
                return result;
            }

            serialize() {
                return JSON.stringify([...this.state], (key, value) => {
                    if (value instanceof Map) {
                        return [...value];
                    }
                    return value;
                });
            }

            deserialize(data) {
                const parsed = JSON.parse(data, (key, value) => {
                    if (Array.isArray(value) && value.length === 2 && typeof value[0] === 'string') {
                        return new Map(value);
                    }
                    return value;
                });
                return new Map(parsed);
            }
        }

        // P2P Network
        class P2PNetwork {
            constructor() {
                this.friends = new Map();
                this.connections = new Map();
                this.rtcConnections = new Map();
                this.myId = this.generateId();
                this.crdt = new CRDT();
                this.userActions = new Map();
                this.isConnected = false;
                this.isOnline = navigator.onLine;
                this.signalingSocket = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.categories = ['–≤—Å–µ', '—Å–æ–±—ã—Ç–∏–µ', '–≤—Å—Ç—Ä–µ—á–∞', '–ø–æ–º–æ—â—å', '–ø—Ä–æ–¥–∞–∂–∞', '–¥—Ä—É–≥–æ–µ'];
                this.activeCategory = '–≤—Å–µ';
                this.iceServers = [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' }
                ];
                
                this.initNetwork();
                this.loadFromStorage();
                this.startCleanupTimer();
                this.registerServiceWorker();
                this.setupNetworkEventListeners();
                this.initCategories();
            }

            generateId() {
                return 'user_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
            }

            initCategories() {
                const container = document.getElementById('categories');
                container.innerHTML = this.categories.map(cat => `
                    <button class="text-base font-medium snap-center px-3 py-1.5 rounded-md whitespace-nowrap transition-all ${cat === this.activeCategory ? 'bg-[#fbede0] text-[#383533]' : 'text-[#383533]/70 hover:text-[#383533]'}" data-category="${cat}">
                        ${cat.charAt(0).toUpperCase() + cat.slice(1)}
                    </button>
                `).join('');

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                container.addEventListener('click', (e) => {
                    const target = e.target.closest('[data-category]');
                    if (target) {
                        this.activeCategory = target.getAttribute('data-category');
                        this.initCategories();
                        renderPosts();
                    }
                });
            }

            async registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('./sw.js');
                        console.log('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration.scope);
                        
                        navigator.serviceWorker.addEventListener('message', event => {
                            if (event.data.type === 'SYNC_COMPLETE') {
                                console.log('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π:', event.data.posts);
                                this.updateStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                                renderPosts();
                            }
                        });
                        
                        if ('sync' in window.ServiceWorkerRegistration.prototype) {
                            registration.sync.register('sync-posts');
                        }
                        
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ Service Worker:', error);
                        await this.registerFallbackServiceWorker();
                    }
                } else {
                    console.log('Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                }
            }

            async registerFallbackServiceWorker() {
                const swCode = `
                    const CACHE_NAME = 'p2p-social-fallback-v1';
                    const urlsToCache = ['/'];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                        );
                    });
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const registration = await navigator.serviceWorker.register(URL.createObjectURL(blob));
                console.log('Fallback Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
            }

            async initNetwork() {
                try {
                    this.updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
                    await this.connectToSignalingServer();
                } catch (error) {
                    console.error('Network error:', error);
                    this.updateStatus('–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º');
                    this.isConnected = false;
                    this.startLocalMode();
                }
            }

            async connectToSignalingServer() {
                return new Promise((resolve, reject) => {
                    try {
                        const signalingUrl = 'wss://six-4xly.onrender.com';
                        
                        this.signalingSocket = new WebSocket(signalingUrl);
                        
                        this.signalingSocket.onopen = () => {
                            console.log('üîó Signaling –ø–æ–¥–∫–ª—é—á–µ–Ω');
                            this.isConnected = true;
                            this.updateStatus('live');
                            this.reconnectAttempts = 0;
                            this.announcePresence();
                            resolve();
                        };

                        this.signalingSocket.onmessage = async (event) => {
                            try {
                                const message = JSON.parse(event.data);
                                if (message.from === this.myId) return;
                                if (!message.target || message.target === this.myId || message.target === 'all') {
                                    await this.handleSignalingMessage(message);
                                }
                            } catch (error) {
                                console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ signaling —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                            }
                        };

                        this.signalingSocket.onclose = () => {
                            console.log('‚ùå Signaling —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
                            this.isConnected = false;
                            this.updateStatus('–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
                            
                            if (this.reconnectAttempts < this.maxReconnectAttempts && this.isOnline) {
                                const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);
                                this.reconnectAttempts++;
                                console.log(`üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${delay}ms (–ø–æ–ø—ã—Ç–∫–∞ ${this.reconnectAttempts})`);
                                setTimeout(() => this.connectToSignalingServer(), delay);
                            } else {
                                this.updateStatus('–û—Ñ–ª–∞–π–Ω');
                                this.startLocalMode();
                            }
                        };

                        this.signalingSocket.onerror = (error) => {
                            console.error('‚ö†Ô∏è Signaling –æ—à–∏–±–∫–∞:', error);
                            reject(error);
                        };

                        setTimeout(() => {
                            if (this.signalingSocket.readyState !== WebSocket.OPEN) {
                                console.log('‚è∞ Timeout –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ signaling —Å–µ—Ä–≤–µ—Ä—É');
                                this.signalingSocket.close();
                                reject(new Error('Connection timeout'));
                            }
                        }, 10000);

                    } catch (error) {
                        reject(error);
                    }
                });
            }

            startLocalMode() {
                setTimeout(() => {
                    this.updateStatus('–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º');
                    this.broadcastMyData();
                    this.simulateLocalFriends();
                }, 1000);
            }

            simulateLocalFriends() {
                const demoUsers = [
                    { name: '–ê–ª–µ–∫—Å–µ–π', city: 'moscow' },
                    { name: '–ú–∞—Ä–∏—è', city: 'spb' },
                    { name: '–î–º–∏—Ç—Ä–∏–π', city: 'ekb' }
                ];

                demoUsers.forEach((user, index) => {
                    const friendId = `demo_${user.name}_${index}`;
                    this.friends.set(friendId, {
                        id: friendId,
                        name: user.name,
                        connected: true,
                        lastSeen: Date.now()
                    });

                    if (Math.random() > 0.5) {
                        const demoPost = {
                            id: this.generateId(),
                            author: friendId,
                            authorName: user.name,
                            timestamp: Date.now() - Math.random() * 86400000,
                            expiresAt: Date.now() + (7 * 24 * 60 * 60 * 1000),
                            title: this.generateDemoTitle(),
                            description: this.generateDemoDescription(),
                            city: user.city,
                            type: ['event', 'meet', 'help'][Math.floor(Math.random() * 3)],
                            gender: ['male', 'female', 'any'][Math.floor(Math.random() * 3)],
                            age: ['18-25', '26-35', '36-45'][Math.floor(Math.random() * 3)],
                            tags: this.generateDemoTags(),
                            contacts: this.generateDemoContacts(),
                            likes: Math.floor(Math.random() * 10),
                            likedBy: [],
                            reports: { illegal: 0, provocation: 0, advertisement: 0 }
                        };
                        
                        this.crdt.update(demoPost.id, demoPost, demoPost.timestamp);
                    }
                });

                this.updateCounts();
                renderPosts();
            }

            generateDemoTitle() {
                const titles = [
                    '–í—Å—Ç—Ä–µ—á–∞ –ª—é–±–∏—Ç–µ–ª–µ–π –∫–æ—Ñ–µ',
                    '–ö–æ–Ω—Ü–µ—Ä—Ç –Ω–∞ –∫—Ä—ã—à–µ',
                    '–ò–∑—É—á–∞–µ–º JavaScript –≤–º–µ—Å—Ç–µ',
                    '–§–æ—Ç–æ—Å–µ—Å—Å–∏—è –≤ –ø–∞—Ä–∫–µ',
                    '–í–æ–ª–æ–Ω—Ç–µ—Ä—Å—Ç–≤–æ –≤ –ø—Ä–∏—é—Ç–µ',
                    '–ù–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã –ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º',
                    '–í–µ–ª–æ–ø—Ä–æ–≥—É–ª–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É',
                    '–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å –ø–æ –≥–æ—Ç–æ–≤–∫–µ'
                ];
                return titles[Math.floor(Math.random() * titles.length)];
            }

            generateDemoDescription() {
                const descriptions = [
                    '–ü—Ä–∏–≥–ª–∞—à–∞—é –≤—Å–µ—Ö –∂–µ–ª–∞—é—â–∏—Ö –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –Ω–∞—à–µ–º—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é!',
                    '–ë—É–¥–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –∏ –≤–µ—Å–µ–ª–æ, –ø—Ä–∏—Ö–æ–¥–∏—Ç–µ!',
                    '–î–∞–≤–∞–π—Ç–µ –≤–º–µ—Å—Ç–µ –ø—Ä–æ–≤–µ–¥–µ–º –≤—Ä–µ–º—è —Å –ø–æ–ª—å–∑–æ–π.',
                    '–ò—â—É –µ–¥–∏–Ω–æ–º—ã—à–ª–µ–Ω–Ω–∏–∫–æ–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ –≤—Ä–µ–º—è–ø—Ä–µ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è.',
                    '–û—Ç–ª–∏—á–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –Ω–æ–≤—ã–º–∏ –ª—é–¥—å–º–∏.',
                    '–í—Å–µ —É—Ä–æ–≤–Ω–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è!'
                ];
                return descriptions[Math.floor(Math.random() * descriptions.length)];
            }

            generateDemoTags() {
                const allTags = ['–º—É–∑—ã–∫–∞', '—Å–ø–æ—Ä—Ç', 'IT', '—Ñ–æ—Ç–æ', '–ø—Ä–∏—Ä–æ–¥–∞', '–¥—Ä—É–∂–±–∞', '—É—á–µ–±–∞', '—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è'];
                const count = Math.floor(Math.random() * 3) + 1;
                return allTags.sort(() => 0.5 - Math.random()).slice(0, count);
            }

            generateDemoContacts() {
                const contacts = [
                    'Telegram: @username\n–¢–µ–ª–µ—Ñ–æ–Ω: +7 999 123-45-67',
                    'WhatsApp: +7 987 654-32-10\nEmail: user@example.com',
                    '–í–ö–æ–Ω—Ç–∞–∫—Ç–µ: vk.com/id123456\n–¢–µ–ª–µ—Ñ–æ–Ω: +7 912 345-67-89'
                ];
                return contacts[Math.floor(Math.random() * contacts.length)];
            }

            setupNetworkEventListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateStatus('–°–µ—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                    this.reconnectAttempts = 0;
                    this.initNetwork();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.isConnected = false;
                    this.updateStatus('–û—Ñ–ª–∞–π–Ω');
                    this.closeAllConnections();
                });

                window.addEventListener('beforeunload', () => {
                    this.disconnect();
                });

                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && this.isOnline && !this.isConnected) {
                        this.initNetwork();
                    }
                });
            }

            closeAllConnections() {
                for (const [friendId, connection] of this.rtcConnections) {
                    connection.close();
                }
                this.rtcConnections.clear();
                
                for (const [friendId, channel] of this.connections) {
                    channel.close();
                }
                this.connections.clear();
                
                if (this.signalingSocket) {
                    this.signalingSocket.close();
                    this.signalingSocket = null;
                }
                
                this.friends.clear();
                this.updateCounts();
            }

            disconnect() {
                this.closeAllConnections();
                this.isConnected = false;
                this.updateStatus('–û—Ç–∫–ª—é—á–µ–Ω');
            }

            announcePresence() {
                this.sendSignalingMessage({
                    type: 'announce',
                    target: 'all',
                    peerId: this.myId,
                    userAgent: navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop'
                });
                
                console.log(`üì¢ –û–±—ä—è–≤–∏–ª–∏ –æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏ –≤ —Å–µ—Ç–∏ (ID: ${this.myId})`);
            }

            sendSignalingMessage(message) {
                if (this.signalingSocket && this.signalingSocket.readyState === WebSocket.OPEN) {
                    const wrappedMessage = {
                        ...message,
                        from: this.myId,
                        timestamp: Date.now()
                    };
                    
                    try {
                        this.signalingSocket.send(JSON.stringify(wrappedMessage));
                        return true;
                    } catch (error) {
                        console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ signaling —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                        return false;
                    }
                } else {
                    console.warn('‚ö†Ô∏è Signaling —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ');
                    return false;
                }
            }

            async handleSignalingMessage(message) {
                console.log(`üì® –ü–æ–ª—É—á–µ–Ω–æ signaling —Å–æ–æ–±—â–µ–Ω–∏–µ: ${message.type} –æ—Ç ${message.from}`);
                
                switch (message.type) {
                    case 'announce':
                        if (message.peerId !== this.myId) {
                            console.log(`üëã –ù–æ–≤—ã–π –¥—Ä—É–≥ –≤ —Å–µ—Ç–∏: ${message.peerId}`);
                            if (this.myId > message.peerId) {
                                setTimeout(() => {
                                    this.connectToFriend(message.peerId);
                                }, Math.random() * 2000);
                            }
                        }
                        break;
                    case 'offer':
                        await this.handleOffer(message);
                        break;
                    case 'answer':
                        await this.handleAnswer(message);
                        break;
                    case 'ice-candidate':
                        await this.handleIceCandidate(message);
                        break;
                }
            }

            async connectToFriend(friendId) {
                if (this.connections.has(friendId) || this.rtcConnections.has(friendId)) {
                    console.log(`üîÑ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${friendId} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
                    return;
                }

                try {
                    console.log(`ü§ù –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –¥—Ä—É–≥–æ–º: ${friendId}`);
                    const connection = await this.createRTCConnection(friendId);
                    
                    const offer = await connection.createOffer({
                        offerToReceiveAudio: false,
                        offerToReceiveVideo: false
                    });
                    await connection.setLocalDescription(offer);

                    this.sendSignalingMessage({
                        type: 'offer',
                        target: friendId,
                        offer: offer
                    });

                    console.log(`üì§ Offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥—Ä—É–≥—É: ${friendId}`);

                } catch (error) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –¥—Ä—É–≥—É ${friendId}:`, error);
                    this.handleFriendDisconnection(friendId);
                }
            }

            async createRTCConnection(friendId) {
                if (this.rtcConnections.has(friendId)) {
                    return this.rtcConnections.get(friendId);
                }

                const connection = new RTCPeerConnection({ iceServers: this.iceServers });
                this.rtcConnections.set(friendId, connection);
                
                const dataChannel = connection.createDataChannel('posts', {
                    ordered: true,
                    maxRetransmits: 3
                });

                this.setupDataChannel(dataChannel, friendId);
                
                connection.ondatachannel = (event) => {
                    this.setupDataChannel(event.channel, friendId);
                };

                connection.onicecandidate = (event) => {
                    if (event.candidate) {
                        this.sendSignalingMessage({
                            type: 'ice-candidate',
                            target: friendId,
                            candidate: event.candidate
                        });
                    }
                };

                connection.onconnectionstatechange = () => {
                    console.log(`RTC Connection state with ${friendId}: ${connection.connectionState}`);
                    
                    if (connection.connectionState === 'connected') {
                        this.friends.set(friendId, {
                            id: friendId,
                            connected: true,
                            lastSeen: Date.now()
                        });
                        this.updateCounts();
                    } else if (connection.connectionState === 'failed' || connection.connectionState === 'disconnected') {
                        this.handleFriendDisconnection(friendId);
                    }
                };

                return connection;
            }

            setupDataChannel(dataChannel, friendId) {
                dataChannel.onopen = () => {
                    console.log(`Data channel –æ—Ç–∫—Ä—ã—Ç —Å ${friendId}`);
                    this.connections.set(friendId, dataChannel);
                    
                    this.sendToFriend(friendId, {
                        type: 'sync',
                        data: this.crdt.serialize()
                    });
                };

                dataChannel.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        this.handleFriendMessage(friendId, message);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –¥—Ä—É–≥–∞:', error);
                    }
                };

                dataChannel.onclose = () => {
                    console.log(`Data channel –∑–∞–∫—Ä—ã—Ç —Å ${friendId}`);
                    this.handleFriendDisconnection(friendId);
                };

                dataChannel.onerror = (error) => {
                    console.error(`–û—à–∏–±–∫–∞ data channel —Å ${friendId}:`, error);
                };
            }

            handleFriendDisconnection(friendId) {
                this.connections.delete(friendId);
                this.friends.delete(friendId);
                
                const rtcConnection = this.rtcConnections.get(friendId);
                if (rtcConnection) {
                    rtcConnection.close();
                    this.rtcConnections.delete(friendId);
                }
                
                this.updateCounts();
                console.log(`–î—Ä—É–≥ ${friendId} –æ—Ç–∫–ª—é—á–µ–Ω`);
            }

            sendToFriend(friendId, message) {
                const dataChannel = this.connections.get(friendId);
                if (dataChannel && dataChannel.readyState === 'open') {
                    try {
                        dataChannel.send(JSON.stringify(message));
                        return true;
                    } catch (error) {
                        console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥—Ä—É–≥—É ${friendId}:`, error);
                        return false;
                    }
                }
                return false;
            }

            async handleOffer(message) {
                try {
                    console.log(`üì• –ü–æ–ª—É—á–µ–Ω offer –æ—Ç ${message.from}`);
                    const connection = await this.createRTCConnection(message.from);
                    
                    await connection.setRemoteDescription(new RTCSessionDescription(message.offer));
                    const answer = await connection.createAnswer();
                    await connection.setLocalDescription(answer);

                    this.sendSignalingMessage({
                        type: 'answer',
                        target: message.from,
                        answer: answer
                    });

                    console.log(`üì§ Answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥—Ä—É–≥—É: ${message.from}`);

                } catch (error) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer –æ—Ç ${message.from}:`, error);
                }
            }

            async handleAnswer(message) {
                try {
                    console.log(`üì• –ü–æ–ª—É—á–µ–Ω answer –æ—Ç ${message.from}`);
                    const connection = this.rtcConnections.get(message.from);
                    if (connection) {
                        await connection.setRemoteDescription(new RTCSessionDescription(message.answer));
                        console.log(`‚úÖ Answer –æ–±—Ä–∞–±–æ—Ç–∞–Ω –æ—Ç ${message.from}`);
                    } else {
                        console.warn(`‚ö†Ô∏è RTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –¥–ª—è ${message.from}`);
                    }
                } catch (error) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ answer –æ—Ç ${message.from}:`, error);
                }
            }

            async handleIceCandidate(message) {
                try {
                    const connection = this.rtcConnections.get(message.from);
                    if (connection && message.candidate) {
                        await connection.addIceCandidate(new RTCIceCandidate(message.candidate));
                        console.log(`üßä ICE candidate –¥–æ–±–∞–≤–ª–µ–Ω –æ—Ç ${message.from}`);
                    }
                } catch (error) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ ICE candidate –æ—Ç ${message.from}:`, error);
                }
            }

            handleFriendMessage(friendId, message) {
                switch (message.type) {
                    case 'sync':
                        this.handleSync(friendId, message.data);
                        break;
                    case 'post':
                        this.handleNewPost(friendId, message.data);
                        break;
                    case 'like':
                        this.handleLike(friendId, message.data);
                        break;
                    case 'report':
                        this.handleReport(friendId, message.data);
                        break;
                }
            }

            handleSync(fromFriendId, syncData) {
                try {
                    const remoteState = this.crdt.deserialize(syncData);
                    const updated = this.crdt.merge(remoteState);
                    
                    if (updated) {
                        console.log(`–ü–æ–ª—É—á–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç ${fromFriendId}`);
                        this.saveToStorage();
                        renderPosts();
                        this.updateCounts();
                        
                        this.sendToFriend(fromFriendId, {
                            type: 'sync-response',
                            data: this.crdt.serialize()
                        });
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
                }
            }

            handleNewPost(fromFriendId, postData) {
                try {
                    if (this.crdt.update(postData.id, postData, postData.timestamp)) {
                        console.log(`–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å –æ—Ç ${fromFriendId}: ${postData.title}`);
                        this.saveToStorage();
                        renderPosts();
                        this.updateCounts();
                        
                        this.relayMessage(fromFriendId, {
                            type: 'post',
                            data: postData
                        });
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏:', error);
                }
            }

            handleLike(fromFriendId, likeData) {
                try {
                    const post = this.crdt.get(likeData.postId);
                    if (post) {
                        let updated = false;
                        
                        if (likeData.action === 'like') {
                            if (!post.likedBy.includes(likeData.userId)) {
                                post.likes = (post.likes || 0) + 1;
                                post.likedBy = post.likedBy || [];
                                post.likedBy.push(likeData.userId);
                                updated = true;
                            }
                        } else if (likeData.action === 'unlike') {
                            if (post.likedBy.includes(likeData.userId)) {
                                post.likes = Math.max(0, (post.likes || 0) - 1);
                                post.likedBy = post.likedBy.filter(id => id !== likeData.userId);
                                updated = true;
                            }
                        }
                        
                        if (updated) {
                            this.crdt.update(post.id, post);
                            this.saveToStorage();
                            renderPosts();
                            
                            this.relayMessage(fromFriendId, {
                                type: 'like',
                                data: likeData
                            });
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ª–∞–π–∫–∞:', error);
                }
            }

            handleReport(fromFriendId, reportData) {
                try {
                    const post = this.crdt.get(reportData.postId);
                    if (post) {
                        post.reports = post.reports || { illegal: 0, provocation: 0, advertisement: 0 };
                        post.reports[reportData.reportType] = (post.reports[reportData.reportType] || 0) + 1;
                        
                        if (post.reports[reportData.reportType] >= 10) {
                            post.flagged = reportData.reportType;
                        }

                        this.crdt.update(post.id, post);
                        this.saveToStorage();
                        renderPosts();
                        
                        this.relayMessage(fromFriendId, {
                            type: 'report',
                            data: reportData
                        });
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∂–∞–ª–æ–±—ã:', error);
                }
            }

            relayMessage(excludeFriendId, message) {
                for (const [friendId, channel] of this.connections) {
                    if (friendId !== excludeFriendId && channel.readyState === 'open') {
                        this.sendToFriend(friendId, message);
                    }
                }
            }

            broadcast(message) {
                let successCount = 0;
                let totalFriends = this.connections.size;
                
                for (const [friendId, channel] of this.connections) {
                    if (this.sendToFriend(friendId, message)) {
                        successCount++;
                    }
                }
                
                console.log(`–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${successCount}/${totalFriends} –¥—Ä—É–∑—å—è–º`);
                return successCount;
            }

            broadcastMyData() {
                if (this.connections.size > 0) {
                    const syncMessage = {
                        type: 'sync',
                        data: this.crdt.serialize()
                    };
                    this.broadcast(syncMessage);
                } else {
                    console.log('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
                }
            }

            async createPost(postData) {
                const post = {
                    id: this.generateId(),
                    author: this.myId,
                    timestamp: Date.now(),
                    expiresAt: Date.now() + (7 * 24 * 60 * 60 * 1000),
                    ...postData,
                    likes: 0,
                    likedBy: [],
                    reports: { illegal: 0, provocation: 0, advertisement: 0 }
                };

                post.signature = await this.signPost(post);
                
                this.crdt.update(post.id, post);
                this.saveToStorage();
                
                this.broadcast({
                    type: 'post',
                    data: post
                });
                
                return post;
            }

            async signPost(post) {
                if (window.crypto && window.crypto.subtle) {
                    try {
                        const encoder = new TextEncoder();
                        const data = encoder.encode(JSON.stringify({
                            author: post.author,
                            title: post.title,
                            description: post.description,
                            timestamp: post.timestamp
                        }));
                        
                        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                        const hashArray = Array.from(new Uint8Array(hashBuffer));
                        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').slice(0, 16);
                    } catch (error) {
                        console.error('Crypto signing error:', error);
                    }
                }
                
                return btoa(JSON.stringify({
                    author: post.author,
                    title: post.title,
                    timestamp: post.timestamp
                })).slice(0, 16);
            }

            likePost(postId) {
                const post = this.crdt.get(postId);
                if (!post) return;

                const userActions = this.getUserActions(postId);
                const action = userActions.liked ? 'unlike' : 'like';
                
                if (action === 'like') {
                    post.likes = (post.likes || 0) + 1;
                    post.likedBy = post.likedBy || [];
                    if (!post.likedBy.includes(this.myId)) {
                        post.likedBy.push(this.myId);
                    }
                    userActions.liked = true;
                } else {
                    post.likes = Math.max(0, (post.likes || 0) - 1);
                    post.likedBy = (post.likedBy || []).filter(id => id !== this.myId);
                    userActions.liked = false;
                }

                this.crdt.update(postId, post);
                this.saveUserAction(postId, userActions);
                this.saveToStorage();

                this.broadcast({
                    type: 'like',
                    data: {
                        postId,
                        userId: this.myId,
                        action
                    }
                });
            }

            reportPost(postId, type) {
                const post = this.crdt.get(postId);
                if (!post) return;

                post.reports = post.reports || { illegal: 0, provocation: 0, advertisement: 0 };
                post.reports[type] = (post.reports[type] || 0) + 1;
                
                if (post.reports[type] >= 10) {
                    post.flagged = type;
                }

                this.crdt.update(postId, post);
                this.saveToStorage();
                
                this.broadcast({
                    type: 'report',
                    data: {
                        postId,
                        reportType: type,
                        userId: this.myId
                    }
                });
            }

            getUserActions(postId) {
                if (!this.userActions.has(postId)) {
                    this.userActions.set(postId, {
                        liked: false,
                        hidden: false,
                        favorite: false
                    });
                }
                return this.userActions.get(postId);
            }

            saveUserAction(postId, actions) {
                this.userActions.set(postId, actions);
                localStorage.setItem('p2p_user_actions', JSON.stringify([...this.userActions]));
            }

            hidePost(postId) {
                const userActions = this.getUserActions(postId);
                userActions.hidden = !userActions.hidden;
                this.saveUserAction(postId, userActions);
            }

            favoritePost(postId) {
                const userActions = this.getUserActions(postId);
                userActions.favorite = !userActions.favorite;
                this.saveUserAction(postId, userActions);
            }

            getAllPosts() {
                const posts = [];
                for (const [id, post] of this.crdt.getAll()) {
                    if (post.expiresAt > Date.now()) {
                        posts.push(post);
                    }
                }
                return posts;
            }

            getMyPosts() {
                return this.getAllPosts().filter(post => post.author === this.myId);
            }

            updateStatus(text) {
                document.getElementById('statusText').textContent = text;
                const statusDot = document.getElementById('statusDot');
                statusDot.className = `w-2 h-2 rounded-full status-dot ${this.isConnected ? 'bg-green-500' : 'bg-red-500'}`;
                this.updateCounts();
            }

            updateCounts() {
                document.getElementById('friendCount').textContent = `–î—Ä—É–∑–µ–π: ${this.friends.size}`;
                document.getElementById('postCount').textContent = `–ó–∞–ø–∏—Å–µ–π: ${this.getAllPosts().length}`;
            }

            saveToStorage() {
                localStorage.setItem('p2p_crdt_state', this.crdt.serialize());
                localStorage.setItem('p2p_my_id', this.myId);
            }

            loadFromStorage() {
                const savedState = localStorage.getItem('p2p_crdt_state');
                if (savedState) {
                    const state = this.crdt.deserialize(savedState);
                    this.crdt.merge(state);
                }

                const savedId = localStorage.getItem('p2p_my_id');
                if (savedId) {
                    this.myId = savedId;
                }

                const savedActions = localStorage.getItem('p2p_user_actions');
                if (savedActions) {
                    this.userActions = new Map(JSON.parse(savedActions));
                }
            }

            startCleanupTimer() {
                setInterval(() => {
                    const now = Date.now();
                    let cleaned = false;
                    
                    for (const [id, post] of this.crdt.getAll()) {
                        if (post.expiresAt <= now) {
                            if (post.author === this.myId) {
                                post.status = 'draft';
                                post.note = '–ó–∞–ø–∏—Å—å –∏—Å—Ç–µ–∫–ª–∞ (7 –¥–Ω–µ–π)';
                                this.crdt.update(id, post);
                            }
                            cleaned = true;
                        }
                    }
                    
                    if (cleaned) {
                        this.saveToStorage();
                        renderPosts();
                        this.updateCounts();
                    }
                }, 10 * 60 * 1000);
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å–µ—Ç—å
        const network = new P2PNetwork();

        // UI —Ñ—É–Ω–∫—Ü–∏–∏
        function showCreateForm() {
            document.getElementById('createForm').classList.remove('hidden');
            document.getElementById('createPostBtn').style.display = 'none';
        }

        function hideCreateForm() {
            document.getElementById('createForm').classList.add('hidden');
            document.getElementById('createPostBtn').style.display = 'flex';
        }

        async function createPost() {
            const title = document.getElementById('postTitle').value.trim();
            const description = document.getElementById('postDescription').value.trim();
            
            if (!title || !description) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ');
                return;
            }

            const postData = {
                title,
                description,
                tags: document.getElementById('postTags').value.split(',').map(t => t.trim()).filter(t => t),
                contacts: document.getElementById('postContacts').value.trim(),
                city: document.getElementById('postCity').value,
                type: network.activeCategory === '–≤—Å–µ' ? 'event' : network.activeCategory,
                gender: document.getElementById('postGender').value,
                age: document.getElementById('postAge').value
            };

            await network.createPost(postData);
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('postTitle').value = '';
            document.getElementById('postDescription').value = '';
            document.getElementById('postTags').value = '';
            document.getElementById('postContacts').value = '';
            
            hideCreateForm();
            renderPosts();
            network.updateCounts();
        }

        function cancelCreate() {
            hideCreateForm();
        }

        function renderPosts() {
            const container = document.getElementById('postsFeed');
            let posts = getFilteredPosts();
            
            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="glass rounded-2xl p-8 text-center">
                        <div class="text-6xl mb-4">üì≠</div>
                        <p class="text-[#383533]/60">–ó–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = posts.map(post => {
                const userActions = network.getUserActions(post.id);
                const isMyPost = post.author === network.myId;
                const timeLeft = Math.max(0, post.expiresAt - Date.now());
                const daysLeft = Math.ceil(timeLeft / (24 * 60 * 60 * 1000));
                
                return `
                    <div class="glass rounded-2xl p-6 mb-4">
                        ${post.flagged ? `
                            <div class="bg-yellow-100 border border-yellow-400 text-yellow-800 px-4 py-2 rounded-lg mb-4">
                                ‚ö†Ô∏è –ó–∞–ø–∏—Å—å –ø–æ–º–µ—á–µ–Ω–∞: ${getReportTypeName(post.flagged)}
                            </div>
                        ` : ''}
                        
                        <div class="flex justify-between items-start mb-3">
                            <div class="text-sm text-[#383533]/60">
                                ${isMyPost ? 'üë§ –í–∞—à–∞ –∑–∞–ø–∏—Å—å' : 'üë• –î—Ä—É–≥'} ‚Ä¢ 
                                ${new Date(post.timestamp).toLocaleDateString()} ‚Ä¢ 
                                ‚è±Ô∏è ${daysLeft}–¥
                                ${post.city ? ` ‚Ä¢ üìç ${getCityName(post.city)}` : ''}
                                ${post.type ? ` ‚Ä¢ üè∑Ô∏è ${getTypeName(post.type)}` : ''}
                                ${post.gender ? ` ‚Ä¢ ${getGenderName(post.gender)}` : ''}
                                ${post.age ? ` ‚Ä¢ ${post.age}` : ''}
                            </div>
                        </div>
                        
                        <h3 class="text-xl font-semibold text-[#383533] mb-2">${escapeHtml(post.title)}</h3>
                        <p class="text-[#383533]/80 mb-4 leading-relaxed">${escapeHtml(post.description)}</p>
                        
                        ${post.tags && post.tags.length > 0 ? `
                            <div class="flex flex-wrap gap-2 mb-4">
                                ${post.tags.map(tag => `
                                    <span class="px-3 py-1 bg-[#fbede0] text-[#383533] text-sm rounded-full">#${escapeHtml(tag)}</span>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="flex flex-wrap gap-2 items-center">
                            <button onclick="likePost('${post.id}')" 
                                    class="flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${userActions.liked ? 'bg-red-100 text-red-700' : 'bg-[#383533]/10 hover:bg-[#383533]/20 text-[#383533]'}">
                                ${userActions.liked ? '‚ù§Ô∏è' : 'ü§ç'} ${post.likes || 0}
                            </button>
                            
                            <button onclick="favoritePost('${post.id}')" 
                                    class="px-3 py-2 rounded-lg transition-colors ${userActions.favorite ? 'bg-yellow-100 text-yellow-700' : 'bg-[#383533]/10 hover:bg-[#383533]/20 text-[#383533]'}">
                                ${userActions.favorite ? '‚≠ê' : '‚òÜ'}
                            </button>
                            
                            <button onclick="hidePost('${post.id}')" 
                                    class="px-3 py-2 rounded-lg bg-[#383533]/10 hover:bg-[#383533]/20 text-[#383533] transition-colors">
                                ${userActions.hidden ? 'üëÅÔ∏è' : 'üôà'}
                            </button>

                            ${post.contacts ? `
                                <button onclick="showContacts('${post.id}')" 
                                        class="px-3 py-2 rounded-lg bg-[#fbede0] hover:bg-[#fbede0]/80 text-[#383533] transition-colors">
                                    üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã
                                </button>
                            ` : ''}
                            
                            ${!isMyPost ? `
                                <div class="relative">
                                    <button onclick="toggleReportMenu('${post.id}')" 
                                            class="px-3 py-2 rounded-lg bg-red-100 hover:bg-red-200 text-red-700 transition-colors">
                                        üö©
                                    </button>
                                    <div class="absolute right-0 top-full mt-1 bg-white rounded-lg shadow-lg border hidden z-10" id="reportMenu_${post.id}">
                                        <button onclick="reportPost('${post.id}', 'illegal')" 
                                                class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">–ù–µ–∑–∞–∫–æ–Ω–Ω–æ</button>
                                        <button onclick="reportPost('${post.id}', 'provocation')" 
                                                class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">–ü—Ä–æ–≤–æ–∫–∞—Ü–∏—è</button>
                                        <button onclick="reportPost('${post.id}', 'advertisement')" 
                                                class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">–†–µ–∫–ª–∞–º–∞</button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getFilteredPosts() {
            let posts = network.getAllPosts();
            const search = document.getElementById('searchBox').value.toLowerCase();
            const cityFilter = document.getElementById('filterCity').value;
            const genderFilter = document.getElementById('filterGender').value;
            const ageFilter = document.getElementById('filterAge').value;
            const sortFilter = document.getElementById('filterSort').value;

            // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if (network.activeCategory !== '–≤—Å–µ') {
                posts = posts.filter(post => post.type === network.activeCategory);
            }

            // –ü–æ–∏—Å–∫
            if (search) {
                posts = posts.filter(post => 
                    post.title.toLowerCase().includes(search) ||
                    post.description.toLowerCase().includes(search) ||
                    (post.tags && post.tags.some(tag => tag.toLowerCase().includes(search)))
                );
            }

            // –§–∏–ª—å—Ç—Ä—ã
            if (cityFilter) {
                posts = posts.filter(post => post.city === cityFilter);
            }

            if (genderFilter) {
                posts = posts.filter(post => post.gender === genderFilter);
            }

            if (ageFilter) {
                posts = posts.filter(post => post.age === ageFilter);
            }

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            switch (sortFilter) {
                case 'my':
                    posts = posts.filter(post => post.author === network.myId);
                    break;
                case 'favorites':
                    posts = posts.filter(post => network.getUserActions(post.id).favorite);
                    break;
                case 'hidden':
                    posts = posts.filter(post => network.getUserActions(post.id).hidden);
                    break;
                case 'liked':
                    posts.sort((a, b) => (b.likes || 0) - (a.likes || 0));
                    break;
                case 'old':
                    posts.sort((a, b) => a.timestamp - b.timestamp);
                    break;
                default: // 'new'
                    posts.sort((a, b) => b.timestamp - a.timestamp);
            }

            return posts;
        }

        function filterPosts() {
            renderPosts();
        }

        function resetFilters() {
            document.getElementById('searchBox').value = '';
            document.getElementById('filterCity').value = '';
            document.getElementById('filterGender').value = '';
            document.getElementById('filterAge').value = '';
            document.getElementById('filterSort').value = 'new';
            renderPosts();
        }

        function likePost(postId) {
            network.likePost(postId);
            renderPosts();
        }

        function hidePost(postId) {
            network.hidePost(postId);
            renderPosts();
        }

        function favoritePost(postId) {
            network.favoritePost(postId);
            renderPosts();
        }

        function reportPost(postId, type) {
            network.reportPost(postId, type);
            document.getElementById(`reportMenu_${postId}`).classList.add('hidden');
            alert('–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
            renderPosts();
        }

        function toggleReportMenu(postId) {
            const menu = document.getElementById(`reportMenu_${postId}`);
            menu.classList.toggle('hidden');
            
            document.querySelectorAll('[id^="reportMenu_"]').forEach(dropdown => {
                if (dropdown.id !== `reportMenu_${postId}`) {
                    dropdown.classList.add('hidden');
                }
            });
        }

        function showContacts(postId) {
            const post = network.crdt.get(postId);
            if (post && post.contacts) {
                document.getElementById('contactContent').innerHTML = 
                    post.contacts.split('\n').map(line => `<p class="mb-2">${escapeHtml(line)}</p>`).join('');
                document.getElementById('contactModal').classList.remove('hidden');
            }
        }

        function getCityName(city) {
            const cities = {
                'moscow': '–ú–æ—Å–∫–≤–∞',
                'spb': '–°–ü–±',
                'ekb': '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥',
                'nsk': '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫',
                'other': '–î—Ä—É–≥–æ–π'
            };
            return cities[city] || city;
        }

        function getTypeName(type) {
            const types = {
                'event': '–°–æ–±—ã—Ç–∏–µ',
                'meet': '–í—Å—Ç—Ä–µ—á–∞',
                'help': '–ü–æ–º–æ—â—å',
                'sale': '–ü—Ä–æ–¥–∞–∂–∞',
                'other': '–î—Ä—É–≥–æ–µ'
            };
            return types[type] || type;
        }

        function getGenderName(gender) {
            const genders = {
                'male': '–ú—É–∂—Å–∫–æ–π',
                'female': '–ñ–µ–Ω—Å–∫–∏–π',
                'any': '–õ—é–±–æ–π'
            };
            return genders[gender] || gender;
        }

        function getReportTypeName(type) {
            const reportTypes = {
                'illegal': '–ù–µ–∑–∞–∫–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç',
                'provocation': '–ü—Ä–æ–≤–æ–∫–∞—Ü–∏—è',
                'advertisement': '–†–µ–∫–ª–∞–º–∞'
            };
            return reportTypes[type] || type;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listeners
        document.getElementById('createPostBtn').addEventListener('click', showCreateForm);
        document.getElementById('closeContactModal').addEventListener('click', () => {
            document.getElementById('contactModal').classList.add('hidden');
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
        document.getElementById('contactModal').addEventListener('click', (e) => {
            if (e.target.id === 'contactModal') {
                document.getElementById('contactModal').classList.add('hidden');
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
        document.addEventListener('click', (e) => {
            const createForm = document.getElementById('createForm');
            if (!createForm.classList.contains('hidden') && 
                !createForm.contains(e.target) && 
                !document.getElementById('createPostBtn').contains(e.target)) {
                hideCreateForm();
            }

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –∂–∞–ª–æ–±
            if (!e.target.closest('[id^="reportMenu_"]') && !e.target.closest('button')) {
                document.querySelectorAll('[id^="reportMenu_"]').forEach(dropdown => {
                    dropdown.classList.add('hidden');
                });
            }
        });

        // Escape –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–æ–∫
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('contactModal').classList.add('hidden');
                hideCreateForm();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        renderPosts();
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        setInterval(() => {
            renderPosts();
            network.updateCounts();
        }, 30000);

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –¥—Ä—É–∑—å—è–º–∏ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            if (network.isConnected) {
                network.broadcastMyData();
            }
        }, 10000);
    </script>
</body>
</html>
