<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fibonacci Poetry</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/react@18.3.1/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.3.1/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.26.9/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="data:application/manifest+json,{}">
  <style>
    body {
      font-family: 'Rubik', sans-serif;
    }
    .modal-backdrop {
      backdrop-filter: blur(5px);
      background-color: rgba(0, 0, 0, 0.5);
    }
    .announcement-expanded {
      transition: max-height 0.3s ease-in-out;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <template id="city-options">
    <option value="Москва">Москва</option>
    <option value="Казань">Казань</option>
    <option value="Санкт-Петербург">Санкт-Петербург</option>
  </template>
  <template id="type-options">
    <option value="Прогулка">Прогулка</option>
    <option value="Общение">Общение</option>
    <option value="Игры">Игры</option>
  </template>
  <template id="date-options">
    <option value="Сегодня">Сегодня</option>
    <option value="Завтра">Завтра</option>
    <option value="На неделе">На неделе</option>
  </template>
  <template id="gender-options">
    <option value="Мужской">Мужской</option>
    <option value="Женский">Женский</option>
    <option value="Не важно">Не важно</option>
  </template>
  <template id="sort-options">
    <option value="По рейтингу">По рейтингу</option>
    <option value="Верифицированные">Верифицированные</option>
    <option value="Новые">Новые</option>
    <option value="Старые">Старые</option>
  </template>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Modal Component
    function Modal({ children, onClose }) {
      return (
        <div className="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-3xl shadow-lg max-w-md w-full">
            {children}
            <button onClick={onClose} className="mt-4 text-gray-500 hover:text-gray-700">Закрыть</button>
          </div>
        </div>
      );
    }

    // Registration Modal
    function RegistrationModal({ onRegister }) {
      const [name, setName] = useState('');
      const [birthdate, setBirthdate] = useState('');
      const [gender, setGender] = useState('Не важно');
      const [about, setAbout] = useState('');
      const [avatar, setAvatar] = useState('https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/cf5343120913219.60bb24ccb2f89.jpg');
      const [error, setError] = useState('');

      const handleNext = () => {
        if (!name || !birthdate || !about) {
          setError('Пожалуйста, заполните все обязательные поля');
          return;
        }
        onRegister({ name, birthdate, gender, about, avatar });
      };

      return (
        <Modal onClose={() => {}}>
          <h2 className="text-xl font-bold mb-4">Регистрация</h2>
          <div className="flex flex-col gap-4">
            <div className="flex gap-4">
              <img src={avatar} alt="Аватар" className="w-16 h-16 rounded-full" loading="lazy" />
              <input
                type="text"
                placeholder="Имя *"
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="p-2 rounded-lg border"
                required
                aria-label="Имя"
              />
            </div>
            <input
              type="date"
              value={birthdate}
              onChange={(e) => setBirthdate(e.target.value)}
              className="p-2 rounded-lg border"
              required
              aria-label="Дата рождения"
            />
            <select
              value={gender}
              onChange={(e) => setGender(e.target.value)}
              className="p-2 rounded-lg border"
              aria-label="Пол"
            >
              <option value="Мужской">Мужской</option>
              <option value="Женский">Женский</option>
              <option value="Не важно">Не важно</option>
            </select>
            <textarea
              placeholder="О себе *"
              value={about}
              onChange={(e) => setAbout(e.target.value)}
              className="p-2 rounded-lg border w-full"
              required
              aria-label="О себе"
            />
            {error && <p className="text-red-500">{error}</p>}
            <div className="flex gap-4">
              <button className="bg-gray-300 px-4 py-2 rounded-lg">Отмена</button>
              <button onClick={handleNext} className="bg-blue-500 text-white px-4 py-2 rounded-lg">Далее</button>
            </div>
          </div>
        </Modal>
      );
    }

    // Search Bar Component
    function SearchBar({ onSearch }) {
      const [query, setQuery] = useState('');
      const [filters, setFilters] = useState({
        city: 'Москва',
        type: 'Прогулка',
        date: 'Сегодня',
        gender: 'Не важно',
        sort: 'По рейтингу'
      });

      const handleFilterChange = (e) => {
        const { name, value } = e.target;
        setFilters(prev => ({ ...prev, [name]: value }));
        onSearch(query, { ...filters, [name]: value });
      };

      return (
        <section className="p-4">
          <input
            type="search"
            placeholder="Поиск..."
            value={query}
            onChange={(e) => {
              setQuery(e.target.value);
              onSearch(e.target.value, filters);
            }}
            className="w-full p-2 mb-4 rounded-[22px] border"
            aria-label="Поиск объявлений"
          />
          <fieldset className="flex flex-wrap gap-2">
            <legend className="sr-only">Фильтры</legend>
            <select name="city" onChange={handleFilterChange} className="p-2 rounded-lg border" aria-label="Город">
              <option value="Москва">Москва</option>
              <option value="Казань">Казань</option>
              <option value="Санкт-Петербург">Санкт-Петербург</option>
            </select>
            <select name="type" onChange={handleFilterChange} className="p-2 rounded-lg border" aria-label="Вид">
              <option value="Прогулка">Прогулка</option>
              <option value="Общение">Общение</option>
              <option value="Игры">Игры</option>
            </select>
            <select name="date" onChange={handleFilterChange} className="p-2 rounded-lg border" aria-label="Дата">
              <option value="Сегодня">Сегодня</option>
              <option value="Завтра">Завтра</option>
              <option value="На неделе">На неделе</option>
            </select>
            <select name="gender" onChange={handleFilterChange} className="p-2 rounded-lg border" aria-label="Пол">
              <option value="Мужской">Мужской</option>
              <option value="Женский">Женский</option>
              <option value="Не важно">Не важно</option>
            </select>
            <select name="sort" onChange={handleFilterChange} className="p-2 rounded-lg border" aria-label="Сортировка">
              <option value="По рейтингу">По рейтингу</option>
              <option value="Верифицированные">Верифицированные</option>
              <option value="Новые">Новые</option>
              <option value="Старые">Старые</option>
            </select>
          </fieldset>
        </section>
      );
    }

    // Announcement Component
    function Announcement({ data, isOwn, onLike, onDislike, onParticipate, onEdit, onDelete }) {
      const [expanded, setExpanded] = useState(false);
      const [showOptions, setShowOptions] = useState(false);

      return (
        <article
          onClick={(e) => {
            if (!e.target.closest('button') && !e.target.closest('a')) setExpanded(!expanded);
          }}
          className={`p-4 rounded-[22px] border ${isOwn ? 'border-blue-500' : 'border-gray-300'} bg-white cursor-pointer announcement-expanded`}
          style={{ maxHeight: expanded ? '500px' : '150px', overflow: 'hidden' }}
        >
          <h3 className="font-bold">{data.title}</h3>
          {expanded && (
            <div className="mt-2">
              <p>{data.description}</p>
              <div className="text-sm text-gray-500">{data.metatags.join(', ')} • {data.createdAt}</div>
              <div className="flex items-center gap-2 mt-2">
                <img src={data.creatorAvatar} alt="Аватар создателя" className="w-8 h-8 rounded-full" loading="lazy" />
              </div>
            </div>
          )}
          <div className="flex justify-between items-center mt-2">
            <a href="#" className="text-blue-500">{data.creatorName}</a>
            <span>{data.age} лет</span>
            <span>{data.participants} участник(ов)</span>
            <div className="flex gap-2">
              <button onClick={() => onLike(data.id)} className="text-green-500" aria-label="Лайк">👍 {data.likes}</button>
              <button onClick={() => onDislike(data.id)} className="text-red-500" aria-label="Дизлайк">👎 {data.dislikes}</button>
              <button onClick={() => onParticipate(data.id)} className="bg-blue-500 text-white px-2 py-1 rounded" aria-label="Участвовать">Участвовать</button>
              <div className="relative">
                <button onClick={() => setShowOptions(!showOptions)} className="text-gray-500" aria-label="Опции">⋯</button>
                {showOptions && (
                  <div className="absolute right-0 mt-2 bg-white border rounded shadow-lg p-2">
                    {isOwn ? (
                      <>
                        <button onClick={() => onEdit(data)} className="block w-full text-left">Редактировать</button>
                        <button onClick={() => onDelete(data.id)} className="block w-full text-left">Удалить</button>
                        <button className="block w-full text-left">Поделиться</button>
                      </>
                    ) : (
                      <>
                        <button className="block w-full text-left">Поделиться</button>
                        <button className="block w-full text-left">В избранное</button>
                        <button className="block w-full text-left">Не показывать</button>
                        <button className="block w-full text-left">Пожаловаться</button>
                      </>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
        </article>
      );
    }

    // Account Modal
    function AccountModal({ user, announcements, applications, onClose }) {
      return (
        <Modal onClose={onClose}>
          <h2 className="text-xl font-bold mb-4">Аккаунт</h2>
          <div className="flex flex-col gap-4">
            <img src={user.avatar} alt="Аватар" className="w-16 h-16 rounded-full" loading="lazy" />
            <p><strong>Имя:</strong> {user.name}</p>
            <p><strong>Дата рождения:</strong> {user.birthdate}</p>
            <p><strong>Пол:</strong> {user.gender}</p>
            <p><strong>О себе:</strong> {user.about}</p>
            <h3 className="font-bold">Избранное</h3>
            <ul>{/* Placeholder for favorites */}</ul>
            <h3 className="font-bold">Заявки</h3>
            {applications.map(app => (
              <div key={app.id}>
                <p>{app.announcementTitle}</p>
                {app.participants.map(p => (
                  <div key={p.id} className="flex items-center gap-2">
                    <img src={p.avatar} alt="Участник" className="w-8 h-8 rounded-full" loading="lazy" />
                    <a href="#" className="text-blue-500">{p.name}</a>
                    <button className="bg-blue-500 text-white px-2 py-1 rounded">Выбрать</button>
                  </div>
                ))}
              </div>
            ))}
          </div>
        </Modal>
      );
    }

    // Create Announcement Modal
    function CreateAnnouncementModal({ onCreate, onClose }) {
      const [title, setTitle] = useState('');
      const [description, setDescription] = useState('');
      const [filters, setFilters] = useState({ city: 'Москва', type: 'Прогулка', date: 'Сегодня', gender: 'Не важно' });

      const handleCreate = () => {
        onCreate({ title, description, metatags: Object.values(filters), createdAt: new Date().toLocaleDateString() });
        onClose();
      };

      return (
        <Modal onClose={onClose}>
          <h2 className="text-xl font-bold mb-4">Создать объявление</h2>
          <input
            type="text"
            placeholder="Заголовок"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            className="p-2 rounded-lg border w-full mb-4"
            aria-label="Заголовок"
          />
          <textarea
            placeholder="Описание"
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            className="p-2 rounded-lg border w-full mb-4"
            aria-label="Описание"
          />
          <div className="flex flex-wrap gap-2">
            <select name="city" onChange={(e) => setFilters(f => ({ ...f, city: e.target.value }))} className="p-2 rounded-lg border" aria-label="Город">
              <option value="Москва">Москва</option>
              <option value="Казань">Казань</option>
              <option value="Санкт-Петербург">Санкт-Петербург</option>
            </select>
            <select name="type" onChange={(e) => setFilters(f => ({ ...f, type: e.target.value }))} className="p-2 rounded-lg border" aria-label="Вид">
              <option value="Прогулка">Прогулка</option>
              <option value="Общение">Общение</option>
              <option value="Игры">Игры</option>
            </select>
            <select name="date" onChange={(e) => setFilters(f => ({ ...f, date: e.target.value }))} className="p-2 rounded-lg border" aria-label="Дата">
              <option value="Сегодня">Сегодня</option>
              <option value="Завтра">Завтра</option>
              <option value="На неделе">На неделе</option>
            </select>
            <select name="gender" onChange={(e) => setFilters(f => ({ ...f, gender: e.target.value }))} className="p-2 rounded-lg border" aria-label="Пол">
              <option value="Мужской">Мужской</option>
              <option value="Женский">Женский</option>
              <option value="Не важно">Не важно</option>
            </select>
          </div>
          <div className="flex gap-4 mt-4">
            <button onClick={onClose} className="bg-gray-300 px-4 py-2 rounded-lg">Отмена</button>
            <button onClick={handleCreate} className="bg-blue-500 text-white px-4 py-2 rounded-lg">Отправить</button>
          </div>
        </Modal>
      );
    }

    // Main App Component
    function App() {
      const [user, setUser] = useState(null);
      const [isSynced, setIsSynced] = useState(null);
      const [announcements, setAnnouncements] = useState([
        { id: 1, title: 'Прогулка в парке', description: 'Присоединяйтесь к прогулке!', metatags: ['Москва', 'Прогулка'], creatorName: 'Алексей', creatorAvatar: 'https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/cf5343120913219.60bb24ccb2f89.jpg', age: 25, participants: 3, likes: 5, dislikes: 2, createdAt: '01.11.2023' }
      ]);
      const [filteredAnnouncements, setFilteredAnnouncements] = useState(announcements);
      const [showAccount, setShowAccount] = useState(false);
      const [showCreate, setShowCreate] = useState(false);
      const [applications, setApplications] = useState([]);

      useEffect(() => {
        setTimeout(() => setIsSynced(Math.random() > 0.5), 1000); // Simulate Telegram sync
      }, []);

      const handleRegister = (userData) => {
        setUser(userData);
        setIsSynced(true);
      };

      const handleSearch = (query, filters) => {
        let result = [...announcements];
        if (query) {
          const lowerQuery = query.toLowerCase();
          result = result.filter(a => 
            a.title.toLowerCase().includes(lowerQuery) ||
            a.description.toLowerCase().includes(lowerQuery) ||
            a.metatags.some(tag => tag.toLowerCase().includes(lowerQuery))
          );
        }
        result = result.filter(a => 
          (!filters.city || a.metatags.includes(filters.city)) &&
          (!filters.type || a.metatags.includes(filters.type)) &&
          (!filters.date || a.metatags.includes(filters.date)) &&
          (!filters.gender || a.metatags.includes(filters.gender))
        );
        if (filters.sort === 'По рейтингу') result.sort((a, b) => (b.likes - b.dislikes) - (a.likes - a.dislikes));
        setFilteredAnnouncements(result);
      };

      const handleLike = (id) => {
        setAnnouncements(prev => prev.map(a => a.id === id ? { ...a, likes: a.likes + 1 } : a));
      };

      const handleDislike = (id) => {
        setAnnouncements(prev => prev.map(a => a.id === id ? { ...a, dislikes: a.dislikes + 1 } : a));
      };

      const handleParticipate = (id) => {
        setApplications(prev => [...prev, { id: Date.now(), announcementTitle: announcements.find(a => a.id === id).title, participants: [{ id: 1, name: user.name, avatar: user.avatar }] }]);
        setAnnouncements(prev => prev.map(a => a.id === id ? { ...a, participants: a.participants + 1 } : a));
      };

      const handleCreate = (data) => {
        const newAnnouncement = { ...data, id: Date.now(), creatorName: user.name, creatorAvatar: user.avatar, age: 25, participants: 0, likes: 0, dislikes: 0 };
        setAnnouncements(prev => [...prev, newAnnouncement]);
      };

      const handleDelete = (id) => {
        setAnnouncements(prev => prev.filter(a => a.id !== id));
      };

      if (isSynced === null) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="flex gap-2">
              <span className="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></span>
              <span className="w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-100"></span>
              <span className="w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-200"></span>
            </div>
          </div>
        );
      }

      if (!isSynced) {
        return (
          <Modal onClose={() => setIsSynced(true)}>
            <p className="mb-4">Синхронизация Telegram не удалась, войдите обычным путем</p>
            <button onClick={() => setIsSynced(true)} className="bg-blue-500 text-white px-4 py-2 rounded-lg">Зарегистрироваться</button>
          </Modal>
        );
      }

      if (!user) {
        return <RegistrationModal onRegister={handleRegister} />;
      }

      return (
        <div className="min-h-screen bg-gray-100">
          <header className="p-4 flex justify-center">
            <img src="https://uno5512.github.io/FrendsHub/3.png" alt="Логотип" className="w-[100px] h-[100px]" loading="lazy" />
          </header>
          <main className="p-4">
            <SearchBar onSearch={handleSearch} />
            <section className="space-y-4">
              {filteredAnnouncements.map(a => (
                <Announcement
                  key={a.id}
                  data={a}
                  isOwn={a.creatorName === user.name}
                  onLike={handleLike}
                  onDislike={handleDislike}
                  onParticipate={handleParticipate}
                  onEdit={() => {}}
                  onDelete={handleDelete}
                />
              ))}
            </section>
          </main>
          <footer className="fixed bottom-4 right-4 flex gap-4">
            <button onClick={() => setShowCreate(true)} className="bg-blue-500 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" aria-label="Создать объявление">+</button>
            <button onClick={() => setShowAccount(true)} className="bg-gray-500 text-white w-12 h-12 rounded-full flex items-center justify-center" aria-label="Открыть аккаунт">↑</button>
          </footer>
          {showAccount && <AccountModal user={user} announcements={announcements} applications={applications} onClose={() => setShowAccount(false)} />}
          {showCreate && <CreateAnnouncementModal onCreate={handleCreate} onClose={() => setShowCreate(false)} />}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
