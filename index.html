<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FriendsHub</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rubik', sans-serif;
            background: #eedfc8;
            color: #1A2A44;
            padding: 16px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 600px;
            width: 100%;
        }

        .image-container {
            display: flex;
            justify-content: center;
            margin-top: 16px;
            margin-bottom: 10px;
        }

        .header-image {
            width: 100px;
            height: 100px;
            object-fit: contain;
        }

        .search-filter-container {
            background: #f1d299;
            border: 2px solid #f6e1bc;
            border-radius: 22px;
            padding: 8px;
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: sticky;
            top: 16px;
            z-index: 100;
        }

        .refresh-loader {
            display: none;
            text-align: center;
            padding: 12px;
            background: #f1d299;
            border-radius: 22px;
        }

        .refresh-loader.active {
            display: block;
        }

        .refresh-loader .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #987eeb;
            border-radius: 50%;
            margin: 0 4px;
            animation: bounce 0.6s infinite alternate;
        }

        .refresh-loader .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .refresh-loader .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            to {
                transform: translateY(-6px);
            }
        }

        .search-filter-container input {
            padding: 8px;
            font-size: 22px;
            border-radius: 8px;
            background: #f1d299;
            border: none;
            width: 100%;
        }

        .search-filter-container input:focus {
            outline: none;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin-top: 4px;
        }

        .filters select {
            padding: 4px;
            font-size: 18px;
            background: #f1d299;
            border: 1px solid #f6e1bc;
            border-radius: 22px;
            cursor: pointer;
            flex: 1;
            min-width: 60px;
        }

        .filters select:focus {
            outline: none;
        }

        button[data-modal-open="createDialog"] {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            width: 160px;
            height: 80px;
            background: #987eeb;
            opacity: 0.5;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: #fff;
            border: none;
            border-radius: 24px;
            font-size: 16px;
            cursor: pointer;
            z-index: 1002;
            transition: bottom 0.3s ease;
            bottom: 0;
        }

        button[data-modal-open="createDialog"].hidden {
            bottom: -60px;
        }

        dialog {
            border: none;
            border-radius: 8px;
            background: #fff;
            padding: 16px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1003;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
        }

        dialog form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        dialog h2 {
            font-size: 18px;
            margin-bottom: 16px;
        }

        dialog select,
        dialog input,
        dialog textarea {
            padding: 8px;
            font-size: 16px;
            background: #f1d299;
            border: none;
            border-radius: 8px;
        }

        dialog select:focus,
        dialog input:focus,
        dialog textarea:focus {
            outline: none;
        }

        dialog textarea {
            min-height: 100px;
            resize: vertical;
        }

        dialog button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
        }

        dialog button[type="button"] {
            background: #E5E7EB;
            color: #1A2A44;
            border: none;
        }

        dialog button[type="submit"],
        dialog button.close-btn {
            background: #987eeb;
            color: #fff;
            border: none;
        }

        .select-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .select-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #F5F5F5;
            border-radius: 8px;
            cursor: pointer;
        }

        .counter {
            font-size: 12px;
            color: #555;
            margin-top: 4px;
        }

        .ad-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 80px;
            scroll-behavior: smooth;
            position: relative;
        }

        .ad-item {
            background: #efefef;
            padding: 16px;
            padding-bottom: 14px;
            border-radius: 22px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: transform 0.5s ease, opacity 0.5s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100%;
        }

        .ad-item.removing {
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }

        .ad-item.own {
            border: 1px solid #ff6200;
        }

        .ad-item.expanded .ad-content {
            max-height: 1000px;
            opacity: 1;
        }

        .ad-item h3 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #41494e;
            hyphens: auto;
            word-wrap: break-word;
            white-space: normal;
            max-width: 100%;
            cursor: pointer;
        }

        .ad-item p.description {
            font-size: 18px;
            line-height: 1.5;
            color: #555;
            hyphens: auto;
            word-wrap: break-word;
            white-space: normal;
            cursor: pointer;
        }

        .ad-item p.tags {
            font-size: 12px;
            color: #555;
        }

        .ad-content {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.7s ease-in-out, opacity 0.7s ease-in-out;
            margin-bottom: 16px;
        }

        .creator-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            margin: 8px 0 4px 0;
        }

        .ad-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
        }

        .join-btn {
            width: 48px;
            height: 48px;
            background: #987eeb;
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: width 0.3s ease;
        }

        .join-btn .participant-count {
            font-size: 12px;
            color: #fff;
            position: relative;
            z-index: 10;
        }

        .join-btn .participant-avatars {
            display: flex;
            flex-direction: row;
            position: absolute;
            right: 8px;
            height: 24px;
            align-items: center;
        }

        .join-btn .participant-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #f6e1bc;
        }

        .ad-item .user {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: auto;
            gap: 12px;
        }

        .ad-item .user .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ad-item .user .name {
            font-size: 16px;
            font-weight: 500;
            color: #007bff;
            cursor: pointer;
        }

        .ad-item .user .age {
            font-size: 14px;
            color: #555;
        }

        .ad-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ad-actions .action {
            cursor: pointer;
            position: relative;
        }

        .ad-actions .action img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .ad-actions .liked::after,
        .ad-actions .disliked::after {
            content: '';
            position: absolute;
            top: calc(50% - 2px);
            left: 50%;
            transform: translate(-50%, -50%);
            width: 32px;
            height: 32px;
            background: #987eeb;
            border-radius: 50%;
            z-index: -1;
        }

        .ad-actions .action.share,
        .ad-actions .action.favorite,
        .ad-actions .action.like,
        .ad-actions .action.dislike {
            position: relative;
            top: 4px;
        }

        .menu {
            cursor: pointer;
            font-size: 20px;
        }

        .menu-options {
            display: none;
            position: absolute;
            top: 40px;
            right: 12px;
            background: #fff;
            border: 1px solid #E6E6E6;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .menu-options.show {
            display: block;
        }

        .menu-options button {
            display: block;
            width: 100%;
            padding: 8px 16px;
            border: none;
            background: none;
            color: #000;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
        }

        .menu-options button:hover {
            background: #f1d299;
        }

        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #987eeb;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .floating-btn.hidden {
            display: none;
        }

        .floating-btn::before {
            content: '←';
            font-size: 24px;
        }

        .profile {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 8px;
            background: #f1d299;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }

        .profile img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile .info {
            display: flex;
            flex-direction: column;
        }

        .profile .info .name {
            font-size: 16px;
            font-weight: 500;
        }

        .profile .info .age {
            font-size: 14px;
            color: #555;
        }

        .age-picker {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .age-picker input {
            width: 60px;
            padding: 4px;
            font-size: 16px;
            text-align: center;
            background: #f1d299;
            border: none;
            border-radius: 8px;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        .age-picker input::-webkit-inner-spin-button,
        .age-picker input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .favorites-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .favorites-list .favorite-item {
            background: #f1d299;
            padding: 8px;
            border-radius: 8px;
            font-size: 14px;
        }

        .reset-btn {
            background: #987eeb;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background: #987eeb;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 1004;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <main class="container">
        <div class="image-container">
            <img class="header-image" src="https://uno5512.github.io/FrendsHub/3.png" alt="Логотип FriendsHub">
        </div>

        <section class="search-filter-container">
            <form id="filter-form">
                <input type="text" id="search" placeholder="Поиск" aria-label="Поиск объявлений">
                <div class="filters">
                    <select id="city" name="city" aria-label="Выберите город">
                        <option value="">Город</option>
                        <option value="Москва">Москва</option>
                        <option value="Санкт-Петербург">Санкт-Петербург</option>
                        <option value="Казань">Казань</option>
                    </select>
                    <select id="type" name="type" aria-label="Выберите вид активности">
                        <option value="">Вид</option>
                        <option value="Встреча">Встреча</option>
                        <option value="Чат">Чат</option>
                        <option value="Событие">Событие</option>
                    </select>
                    <select id="date" name="date" aria-label="Выберите дату">
                        <option value="">Дата</option>
                        <option value="Сегодня">Сегодня</option>
                        <option value="Завтра">Завтра</option>
                        <option value="На неделе">На неделе</option>
                    </select>
                    <select id="gender" name="gender" aria-label="Выберите пол">
                        <option value="">Пол</option>
                        <option value="Мужской">Мужской</option>
                        <option value="Женский">Женский</option>
                        <option value="Любой">Любой</option>
                    </select>
                    <select id="sort" name="sort" aria-label="Сортировка">
                        <option value="rating">По рейтингу</option>
                        <option value="newest">Новые</option>
                        <option value="oldest">Старые</option>
                    </select>
                </div>
            </form>
            <div class="refresh-loader" id="refreshLoader">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        </section>

        <section class="ad-list" id="adList" aria-label="Список объявлений"></section>

        <button type="button" data-modal-open="createDialog" aria-label="Создать объявление">+ Создать</button>

        <button class="floating-btn" onclick="openFavoritesDialog()" aria-label="Открыть избранное"></button>
    </main>

    <dialog id="createDialog" aria-labelledby="dialogTitle">
        <form method="dialog" id="create-ad-form">
            <h2 id="dialogTitle">Создать объявление</h2>
            <input type="text" id="adTitle" placeholder="Заголовок" maxlength="63" aria-label="Заголовок объявления">
            <span class="counter" id="titleCounter">63/63</span>
            <textarea id="adDescription" placeholder="Описание" maxlength="500" aria-label="Описание объявления"></textarea>
            <span class="counter" id="descriptionCounter">500/500</span>
            <fieldset>
                <legend>Город</legend>
                <select id="adCity" name="city" aria-label="Выберите город">
                    <option value="Москва">Москва</option>
                    <option value="Санкт-Петербург">Санкт-Петербург</option>
                    <option value="Казань">Казань</option>
                </select>
            </fieldset>
            <fieldset>
                <legend>Вид</legend>
                <select id="adType" name="type" aria-label="Выберите вид активности">
                    <option value="Встреча">Встреча</option>
                    <option value="Чат">Чат</option>
                    <option value="Событие">Событие</option>
                </select>
            </fieldset>
            <fieldset>
                <legend>Дата</legend>
                <select id="adDate" name="date" aria-label="Выберите дату">
                    <option value="Сегодня">Сегодня</option>
                    <option value="Завтра">Завтра</option>
                    <option value="На неделе">На неделе</option>
                </select>
            </fieldset>
            <fieldset>
                <legend>Пол</legend>
                <select id="adGender" name="gender" aria-label="Выберите пол">
                    <option value="Мужской">Мужской</option>
                    <option value="Женский">Женский</option>
                    <option value="Любой">Любой</option>
                </select>
            </fieldset>
            <fieldset>
                <legend>Возраст</legend>
                <input type="number" id="adAge" min="1" max="120" placeholder="Возраст" aria-label="Укажите возраст">
            </fieldset>
            <button type="button" onclick="document.getElementById('createDialog').close()" aria-label="Закрыть диалог">Закрыть</button>
            <button type="submit">Опубликовать</button>
        </form>
    </dialog>

    <dialog id="complaintDialog" aria-labelledby="complaintTitle">
        <form method="dialog" id="complaint-form">
            <h2 id="complaintTitle">Пожаловаться</h2>
            <textarea id="complaintText" placeholder="Опишите причину жалобы" aria-label="Причина жалобы"></textarea>
            <button type="button" onclick="document.getElementById('complaintDialog').close()" aria-label="Отменить жалобу">Отменить</button>
            <button type="submit">Отправить</button>
        </form>
    </dialog>

    <dialog id="cityDialog" aria-labelledby="cityTitle">
        <form method="dialog" id="city-form">
            <h2 id="cityTitle">Выберите город</h2>
            <div class="select-options">
                <label><input type="radio" name="cityOption" value="Москва"> Москва</label>
                <label><input type="radio" name="cityOption" value="Санкт-Петербург"> Санкт-Петербург</label>
                <label><input type="radio" name="cityOption" value="Казань"> Казань</label>
            </div>
            <button type="button" onclick="document.getElementById('cityDialog').close()" aria-label="Отменить выбор города">Отменить</button>
            <button type="submit">Применить</button>
        </form>
    </dialog>

    <dialog id="typeDialog" aria-labelledby="typeTitle">
        <form method="dialog" id="type-form">
            <h2 id="typeTitle">Выберите вид</h2>
            <div class="select-options">
                <label><input type="radio" name="typeOption" value="Встреча"> Встреча</label>
                <label><input type="radio" name="typeOption" value="Чат"> Чат</label>
                <label><input type="radio" name="typeOption" value="Событие"> Событие</label>
            </div>
            <button type="button" onclick="document.getElementById('typeDialog').close()" aria-label="Отменить выбор вида">Отменить</button>
            <button type="submit">Применить</button>
        </form>
    </dialog>

    <dialog id="dateDialog" aria-labelledby="dateTitle">
        <form method="dialog" id="date-form">
            <h2 id="dateTitle">Выберите дату</h2>
            <div class="select-options">
                <label><input type="radio" name="dateOption" value="Сегодня"> Сегодня</label>
                <label><input type="radio" name="dateOption" value="Завтра"> Завтра</label>
                <label><input type="radio" name="dateOption" value="На неделе"> На неделе</label>
            </div>
            <button type="button" onclick="document.getElementById('dateDialog').close()" aria-label="Отменить выбор даты">Отменить</button>
            <button type="submit">Применить</button>
        </form>
    </dialog>

    <dialog id="genderDialog" aria-labelledby="genderTitle">
        <form method="dialog" id="gender-form">
            <h2 id="genderTitle">Выберите пол</h2>
            <div class="select-options">
                <label><input type="radio" name="genderOption" value="Мужской"> Мужской</label>
                <label><input type="radio" name="genderOption" value="Женский"> Женский</label>
                <label><input type="radio" name="genderOption" value="Любой"> Любой</label>
            </div>
            <button type="button" onclick="document.getElementById('genderDialog').close()" aria-label="Отменить выбор пола">Отменить</button>
            <button type="submit">Применить</button>
        </form>
    </dialog>

    <dialog id="favoritesDialog" aria-labelledby="favoritesTitle">
        <div class="modal-content">
            <h2 id="favoritesTitle">Избранное</h2>
            <div class="profile" onclick="openTelegramProfile('user-1')" aria-label="Профиль TONI">
                <img src="https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/51174a180992325.6514258f750ff.jpg" alt="Аватар TONI">
                <div class="info">
                    <span class="name">TONI</span>
                    <span class="age" id="profileAge">15 лет</span>
                    <div class="age-picker">
                        <input type="number" id="birthDay" min="1" max="31" placeholder="День" aria-label="День рождения">
                        <input type="number" id="birthMonth" min="1" max="12" placeholder="Месяц" aria-label="Месяц рождения">
                        <input type="number" id="birthYear" min="1900" max="2025" placeholder="Год" aria-label="Год рождения">
                    </div>
                </div>
            </div>
            <input type="text" id="favoritesSearch" placeholder="Поиск по избранному" aria-label="Поиск по избранным объявлениям">
            <div class="favorites-list" id="favoritesList"></div>
            <button class="reset-btn" onclick="resetApp()">Сбросить</button>
            <button class="close-btn" onclick="document.getElementById('favoritesDialog').close()">Закрыть</button>
        </div>
    </dialog>

    <div class="notification" id="notification"></div>

    <script>
        // Глобальная переменная для хранения ID объявления для жалобы/редактирования
        let complaintAdId = null;

        // Размер пакета для ленивой загрузки
        const lazyLoadBatchSize = 10;

        // Состояние приложения
        const appState = {
            ads: JSON.parse(localStorage.getItem('ads')) || [],
            users: JSON.parse(localStorage.getItem('users')) || [],
            userId: localStorage.getItem('userId') || 'user-' + Date.now(),
            userName: 'TONI',
            filters: {
                search: '',
                city: '',
                type: '',
                date: '',
                gender: '',
                sort: 'rating'
            },
            likesDislikes: JSON.parse(localStorage.getItem('likesDislikes')) || {},
            favorites: JSON.parse(localStorage.getItem('favorites')) || [],
            hiddenAds: JSON.parse(localStorage.getItem('hiddenAds')) || [],
            participants: JSON.parse(localStorage.getItem('participants')) || {},
        };

        localStorage.setItem('userId', appState.userId);

        // Утилитные функции
        const utils = {
            createElement: (tag, attrs = {}, ...children) => {
                try {
                    const el = document.createElement(tag);
                    Object.keys(attrs).forEach(key => {
                        if (key === 'className') el.className = attrs[key];
                        else if (key === 'innerHTML') el.innerHTML = attrs[key];
                        else el.setAttribute(key, attrs[key]);
                    });
                    children.forEach(child => {
                        if (typeof child === 'string') {
                            el.appendChild(document.createTextNode(child));
                        } else if (child) {
                            el.appendChild(child);
                        }
                    });
                    return el;
                } catch (error) {
                    console.error(`Ошибка создания элемента ${tag}:`, error);
                    return document.createElement('div');
                }
            },

            showNotification: (message, duration = 2000) => {
                try {
                    const notification = document.getElementById('notification');
                    notification.textContent = message;
                    notification.classList.add('show');
                    setTimeout(() => notification.classList.remove('show'), duration);
                } catch (error) {
                    console.error('Ошибка отображения уведомления:', error);
                }
            },

            openDialog: (dialogId) => {
                try {
                    document.getElementById(dialogId).showModal();
                } catch (error) {
                    console.error(`Ошибка открытия диалога ${dialogId}:`, error);
                    utils.showNotification('Не удалось открыть диалог');
                }
            },

            closeDialog: (dialogId) => {
                try {
                    document.getElementById(dialogId).close();
                } catch (error) {
                    console.error(`Ошибка закрытия диалога ${dialogId}:`, error);
                    utils.showNotification('Не удалось закрыть диалог');
                }
            },

            toggleElementVisibility: (elementId, isVisible) => {
                try {
                    const element = document.getElementById(elementId);
                    element.style.display = isVisible ? 'block' : 'none';
                } catch (error) {
                    console.error(`Ошибка переключения видимости ${elementId}:`, error);
                }
            },

            debounce: (func, delay) => {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func(...args), delay);
                };
            },

            isElementInViewport: (el) => {
                try {
                    const rect = el.getBoundingClientRect();
                    return (
                        rect.top >= 0 &&
                        rect.left >= 0 &&
                        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
                    );
                } catch (error) {
                    console.error('Ошибка проверки видимости:', error);
                    return false;
                }
            },

            animateElement: (element, animationName, callback) => {
                try {
                    element.classList.add('animate__animated', 'animate__' + animationName);
                    element.addEventListener('animationend', () => {
                        element.classList.remove('animate__animated', 'animate__' + animationName);
                        if (callback) callback();
                    }, { once: true });
                } catch (error) {
                    console.error(`Ошибка анимации элемента:`, error);
                }
            },

            filterAds: (ads, filters, userId, hiddenAds) => {
                try {
                    return ads.filter(ad => {
                        if (hiddenAds.includes(ad.id)) return false;
                        if (filters.search && !ad.title.toLowerCase().includes(filters.search.toLowerCase()) && !ad.description.toLowerCase().includes(filters.search.toLowerCase())) return false;
                        if (filters.city && ad.city !== filters.city) return false;
                        if (filters.type && ad.type !== filters.type) return false;
                        if (filters.date) {
                            const today = new Date();
                            const adDate = new Date(ad.createdAt);
                            if (filters.date === 'Сегодня' && adDate.toDateString() !== today.toDateString()) return false;
                            if (filters.date === 'Завтра' && adDate.toDateString() !== new Date(today.setDate(today.getDate() + 1)).toDateString()) return false;
                            if (filters.date === 'На неделе' && (adDate < today || adDate > new Date(today.setDate(today.getDate() + 7)))) return false;
                        }
                        if (filters.gender && ad.gender !== filters.gender && filters.gender !== 'Любой') return false;
                        return true;
                    }).sort((a, b) => {
                        if (filters.sort === 'newest') return new Date(b.createdAt) - new Date(a.createdAt);
                        if (filters.sort === 'oldest') return new Date(a.createdAt) - new Date(b.createdAt);
                        const ratingA = (appState.likesDislikes[a.id]?.likes?.length || 0) - (appState.likesDislikes[a.id]?.dislikes?.length || 0);
                        const ratingB = (appState.likesDislikes[b.id]?.likes?.length || 0) - (appState.likesDislikes[b.id]?.dislikes?.length || 0);
                        return ratingB - ratingA;
                    });
                } catch (error) {
                    console.error('Ошибка фильтрации:', error);
                    utils.showNotification('Ошибка при фильтрации объявлений');
                    return ads;
                }
            }
        };

        // Рендеринг объявлений
        const adRenderer = {
            createAdElement: (ad, userId, likesDislikes, favorites, participants,
                toggleAdExpansion, openTelegramProfile, shareAd, toggleFavorite,
                toggleLike, toggleDislike, toggleMenu, editAd, deleteAd, hideAd,
                openComplaintDialog, joinEvent) => {
                try {
                    const isLiked = likesDislikes[ad.id]?.likes?.includes(userId) || false;
                    const isDisliked = likesDislikes[ad.id]?.dislikes?.includes(userId) || false;
                    const isFavorited = favorites.includes(ad.id);
                    const avatarSrc = ad.userId === userId ? 'https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/51174a180992325.6514258f750ff.jpg' : 'https://mir-s3-cdn-cf.behance.net/project_modules/fs/90e60f125956251.6123f46744b17.jpg';
                    const participantCount = participants[ad.id]?.length || 0;
                    const rating = (likesDislikes[ad.id]?.likes?.length || 0) - (likesDislikes[ad.id]?.dislikes?.length || 0);

                    let participantAvatarsHtml = '';
                    participants[ad.id]?.forEach((pUserId, pIndex) => {
                        const pAvatarSrc = pUserId === userId ? 'https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/51174a180992325.6514258f750ff.jpg' : 'https://mir-s3-cdn-cf.behance.net/project_modules/fs/90e60f125956251.6123f46744b17.jpg';
                        participantAvatarsHtml += `<img class="participant-avatar" src="${pAvatarSrc}" alt="Аватар участника ${pUserId}" style="z-index: ${pIndex}; transform: translateX(${pIndex * -8}px);">`;
                    });

                    return utils.createElement('article', {
                        className: `ad-item ${ad.userId === userId ? 'own' : ''}`,
                        'data-ad-id': ad.id,
                        'aria-label': `Объявление от ${ad.userName || 'Аноним'}`
                    }, [
                        utils.createElement('h3', { onclick: () => toggleAdExpansion(ad.id) }, ad.title),
                        utils.createElement('div', { className: 'ad-content' }, [
                            utils.createElement('p', { className: 'description', onclick: () => toggleAdExpansion(ad.id) }, ad.description),
                            utils.createElement('p', { className: 'tags' }, `<small>Город: ${ad.city} | Вид: ${ad.type} | Дата: ${ad.date} | Пол: ${ad.gender} | ${new Date(ad.createdAt).toLocaleDateString()}</small>`),
                            utils.createElement('div', { className: 'creator-container' }, [
                                utils.createElement('img', { className: 'ad-avatar', src: avatarSrc, alt: `Аватар ${ad.userName || 'Аноним'}`, onclick: () => openTelegramProfile(ad.userId) }),
                                utils.createElement('div', { className: 'join-btn', onclick: () => joinEvent(ad.id), style: `width: calc(48px + ${participantCount * 24}px)` }, [
                                    utils.createElement('span', { className: 'participant-count' }, participantCount.toString()),
                                    utils.createElement('div', { className: 'participant-avatars', innerHTML: participantAvatarsHtml })
                                ])
                            ])
                        ]),
                        utils.createElement('div', { className: 'user' }, [
                            utils.createElement('div', { className: 'user-info' }, [
                                utils.createElement('span', { className: 'name', onclick: () => openTelegramProfile(ad.userId) }, ad.userName || 'Аноним'),
                                utils.createElement('span', { className: 'age' }, ad.age || 'Не указан')
                            ]),
                            utils.createElement('div', { className: 'ad-actions' }, [
                                utils.createElement('span', { className: 'counter' }, rating.toString()),
                                utils.createElement('span', { className: 'action share', onclick: () => shareAd(ad.id) }, `<img src="https://uno5512.github.io/FrendsHub/5.png" alt="Поделиться">`),
                                utils.createElement('span', { className: `action favorite ${isFavorited ? 'favorited' : ''}`, onclick: () => toggleFavorite(ad.id) }, `<img src="https://uno5512.github.io/FrendsHub/4.png" alt="Избранное">`),
                                utils.createElement('span', { className: `action like ${isLiked ? 'liked' : ''}`, onclick: () => toggleLike(ad.id) }, `<img src="https://uno5512.github.io/FrendsHub/2.png" alt="Лайк">`),
                                utils.createElement('span', { className: `action dislike ${isDisliked ? 'disliked' : ''}`, onclick: () => toggleDislike(ad.id) }, `<img src="https://uno5512.github.io/FrendsHub/1.png" alt="Дизлайк">`),
                                utils.createElement('span', { className: 'menu', onclick: (e) => toggleMenu(ad.id, e) }, '•••')
                            ])
                        ]),
                        utils.createElement('div', { className: 'menu-options', id: `menu-${ad.id}` }, [
                            ...(ad.userId === userId ? [
                                utils.createElement('button', { onclick: () => editAd(ad.id) }, 'Редактировать'),
                                utils.createElement('button', { onclick: () => deleteAd(ad.id) }, 'Удалить')
                            ] : [
                                utils.createElement('button', { onclick: () => hideAd(ad.id) }, 'Не показывать'),
                                utils.createElement('button', { onclick: () => openComplaintDialog(ad.id) }, 'Пожаловаться')
                            ])
                        ])
                    ]);
                } catch (error) {
                    console.error(`Ошибка рендеринга объявления ${ad.id}:`, error);
                    utils.showNotification('Ошибка при отображении объявления');
                    return utils.createElement('div', {}, 'Ошибка отображения');
                }
            },

            renderAdBatch: (filteredAds, adList, appState, adActions) => {
                try {
                    const start = adList.children.length;
                    const end = Math.min(start + lazyLoadBatchSize, filteredAds.length);
                    const batch = filteredAds.slice(start, end);

                    batch.forEach((ad, index) => {
                        const adElement = adRenderer.createAdElement(ad, appState.userId, appState.likesDislikes, appState.favorites, appState.participants,
                            adActions.toggleAdExpansion, adActions.openTelegramProfile, adActions.shareAd, adActions.toggleFavorite,
                            adActions.toggleLike, adActions.toggleDislike, adActions.toggleMenu, adActions.editAd, adActions.deleteAd, adActions.hideAd,
                            adActions.openComplaintDialog, adActions.joinAd);
                        adList.appendChild(adElement);
                        setTimeout(() => {
                            adElement.style.opacity = '1';
                            adElement.style.transform = 'translateY(0)';
                        }, index * 100);
                    });

                    if (end < filteredAds.length) {
                        window.addEventListener('scroll', adRenderer.handleScroll);
                    } else {
                        window.removeEventListener('scroll', adRenderer.handleScroll);
                    }
                } catch (error) {
                    console.error('Ошибка рендеринга списка объявлений:', error);
                    utils.showNotification('Не удалось отобразить объявления');
                }
            },

            handleScroll: () => {
                try {
                    const adList = document.getElementById('adList');
                    const filteredAds = utils.filterAds(appState.ads, appState.filters, appState.userId, appState.hiddenAds);
                    if (adList.children.length < filteredAds.length && window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
                        window.removeEventListener('scroll', adRenderer.handleScroll);
                        adRenderer.renderAdBatch(filteredAds, adList, appState, adActions);
                    }
                } catch (error) {
                    console.error('Ошибка обработки прокрутки:', error);
                    utils.showNotification('Ошибка при загрузке объявлений');
                }
            },

            renderFavorites: () => {
                try {
                    const favoritesList = document.getElementById('favoritesList');
                    const favoritesSearch = document.getElementById('favoritesSearch').value.toLowerCase();
                    favoritesList.innerHTML = '';

                    const filteredFavorites = appState.favorites.filter(id => {
                        const ad = appState.ads.find(ad => ad.id === id);
                        return ad && ad.title.toLowerCase().includes(favoritesSearch);
                    });

                    if (filteredFavorites.length === 0) {
                        favoritesList.innerHTML = '<p>Нет избранных объявлений</p>';
                        return;
                    }

                    filteredFavorites.forEach(id => {
                        const ad = appState.ads.find(ad => ad.id === id);
                        if (ad) {
                            const favoriteItem = utils.createElement('div', { className: 'favorite-item' }, ad.title);
                            favoritesList.appendChild(favoriteItem);
                        }
                    });
                } catch (error) {
                    console.error('Ошибка рендеринга избранного:', error);
                    utils.showNotification('Ошибка при отображении избранного');
                }
            }
        };

        // Действия с объявлениями
        const adActions = {
            toggleAdExpansion: (adId) => {
                try {
                    const adItem = document.querySelector(`.ad-item[data-ad-id="${adId}"]`);
                    if (adItem) {
                        adItem.classList.toggle('expanded');
                    }
                } catch (error) {
                    console.error(`Ошибка развертывания ${adId}:`, error);
                    utils.showNotification('Ошибка при развертывании объявления');
                }
            },

            openTelegramProfile: (userId) => {
                try {
                    const user = appState.users.find(user => user.id === userId);
                    if (user && user.telegram) {
                        window.open(`https://t.me/${user.telegram}`, '_blank');
                    } else {
                        console.log(`Открыть профиль ${userId}`);
                    }
                } catch (error) {
                    console.error(`Ошибка открытия профиля ${userId}:`, error);
                    utils.showNotification('Ошибка при открытии профиля');
                }
            },

            shareAd: (adId) => {
                try {
                    const ad = appState.ads.find(ad => ad.id === adId);
                    if (ad) {
                        const shareText = `Check out this ad: ${ad.title} - ${ad.description}`;
                        if (navigator.share) {
                            navigator.share({ title: ad.title, text: shareText, url: window.location.href })
                                .then(() => utils.showNotification('Поделился объявлением'))
                                .catch(() => utils.showNotification('Ошибка при шаринге'));
                        } else {
                            navigator.clipboard.writeText(shareText).then(() => utils.showNotification('Ссылка скопирована'));
                        }
                    }
                } catch (error) {
                    console.error(`Ошибка шаринга ${adId}:`, error);
                    utils.showNotification('Ошибка при шаринге');
                }
            },

            toggleFavorite: (adId) => {
                try {
                    if (appState.favorites.includes(adId)) {
                        appState.favorites = appState.favorites.filter(id => id !== adId);
                    } else {
                        appState.favorites.push(adId);
                    }
                    localStorage.setItem('favorites', JSON.stringify(appState.favorites));
                    renderAds();
                    adRenderer.renderFavorites();
                } catch (error) {
                    console.error(`Ошибка избранного ${adId}:`, error);
                    utils.showNotification('Ошибка при добавлении в избранное');
                }
            },

            toggleLike: (adId) => {
                try {
                    appState.likesDislikes[adId] = appState.likesDislikes[adId] || { likes: [], dislikes: [] };
                    const likes = appState.likesDislikes[adId].likes;
                    if (likes.includes(appState.userId)) {
                        likes.splice(likes.indexOf(appState.userId), 1);
                    } else {
                        likes.push(appState.userId);
                        appState.likesDislikes[adId].dislikes = appState.likesDislikes[adId].dislikes.filter(id => id !== appState.userId);
                    }
                    localStorage.setItem('likesDislikes', JSON.stringify(appState.likesDislikes));
                    renderAds();
                } catch (error) {
                    console.error(`Ошибка лайка ${adId}:`, error);
                    utils.showNotification('Ошибка при установке лайка');
                }
            },

            toggleDislike: (adId) => {
                try {
                    appState.likesDislikes[adId] = appState.likesDislikes[adId] || { likes: [], dislikes: [] };
                    const dislikes = appState.likesDislikes[adId].dislikes;
                    if (dislikes.includes(appState.userId)) {
                        dislikes.splice(dislikes.indexOf(appState.userId), 1);
                    } else {
                        dislikes.push(appState.userId);
                        appState.likesDislikes[adId].likes = appState.likesDislikes[adId].likes.filter(id => id !== appState.userId);
                    }
                    localStorage.setItem('likesDislikes', JSON.stringify(appState.likesDislikes));
                    renderAds();
                } catch (error) {
                    console.error(`Ошибка дизлайка ${adId}:`, error);
                    utils.showNotification('Ошибка при установке дизлайка');
                }
            },

            toggleMenu: (adId, event) => {
                try {
                    event.stopPropagation();
                    const menu = document.getElementById(`menu-${adId}`);
                    menu.classList.toggle('show');
                } catch (error) {
                    console.error(`Ошибка меню ${adId}:`, error);
                    utils.showNotification('Ошибка при открытии меню');
                }
            },

            editAd: (adId) => {
                try {
                    const ad = appState.ads.find(ad => ad.id === adId);
                    if (ad) {
                        document.getElementById('adTitle').value = ad.title;
                        document.getElementById('adDescription').value = ad.description;
                        document.getElementById('adCity').value = ad.city;
                        document.getElementById('adType').value = ad.type;
                        document.getElementById('adDate').value = ad.date;
                        document.getElementById('adGender').value = ad.gender;
                        document.getElementById('adAge').value = ad.age || '';
                        complaintAdId = adId;
                        utils.openDialog('createDialog');
                        const form = document.getElementById('create-ad-form');
                        form.onsubmit = (e) => updateAd(e, adId);
                    }
                } catch (error) {
                    console.error(`Ошибка редактирования ${adId}:`, error);
                    utils.showNotification('Ошибка при редактировании');
                }
            },

            deleteAd: async (adId) => {
                try {
                    const adItem = document.querySelector(`.ad-item[data-ad-id="${adId}"]`);
                    if (adItem) {
                        adItem.classList.add('removing');
                        await new Promise(resolve => setTimeout(resolve, 500));
                        adItem.remove();
                    }
                    appState.ads = appState.ads.filter(ad => ad.id !== adId);
                    appState.favorites = appState.favorites.filter(id => id !== adId);
                    delete appState.likesDislikes[adId];
                    delete appState.participants[adId];
                    localStorage.setItem('ads', JSON.stringify(appState.ads));
                    localStorage.setItem('favorites', JSON.stringify(appState.favorites));
                    localStorage.setItem('likesDislikes', JSON.stringify(appState.likesDislikes));
                    localStorage.setItem('participants', JSON.stringify(appState.participants));
                    renderAds();
                    adRenderer.renderFavorites();
                } catch (error) {
                    console.error(`Ошибка удаления ${adId}:`, error);
                    utils.showNotification('Ошибка при удалении');
                }
            },

            hideAd: (adId) => {
                try {
                    if (!appState.hiddenAds.includes(adId)) {
                        appState.hiddenAds.push(adId);
                        localStorage.setItem('hiddenAds', JSON.stringify(appState.hiddenAds));
                        renderAds();
                    }
                } catch (error) {
                    console.error(`Ошибка скрытия ${adId}:`, error);
                    utils.showNotification('Ошибка при скрытии объявления');
                }
            },

            openComplaintDialog: (adId) => {
                try {
                    complaintAdId = adId;
                    utils.openDialog('complaintDialog');
                } catch (error) {
                    console.error(`Ошибка открытия жалобы ${adId}:`, error);
                    utils.showNotification('Ошибка при открытии формы жалобы');
                }
            },

            joinAd: (adId) => {
                try {
                    if (!appState.participants[adId]) {
                        appState.participants[adId] = [];
                    }
                    if (!appState.participants[adId].includes(appState.userId)) {
                        appState.participants[adId].push(appState.userId);
                        localStorage.setItem('participants', JSON.stringify(appState.participants));
                        renderAds();
                    }
                } catch (error) {
                    console.error(`Ошибка участия ${adId}:`, error);
                    utils.showNotification('Ошибка при присоединении к событию');
                }
            }
        };

        // Загрузка данных
        const loadCloudData = async () => {
            try {
                const response = await fetch('https://my-json-server.typicode.com/uno5512/FrendsHub/db');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                appState.ads = data.ads;
                appState.users = data.users;
                localStorage.setItem('ads', JSON.stringify(appState.ads));
                localStorage.setItem('users', JSON.stringify(appState.users));
                renderAds();
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                utils.showNotification('Ошибка при загрузке данных. Используются локальные данные.');
                appState.ads = JSON.parse(localStorage.getItem('ads') || '[]');
                appState.users = JSON.parse(localStorage.getItem('users') || '[]');
                renderAds();
            }
        };

        // Рендеринг объявлений
        const renderAds = () => {
            try {
                const adList = document.getElementById('adList');
                adList.innerHTML = '';
                appState.filters.search = document.getElementById('search').value;
                appState.filters.city = document.getElementById('city').value;
                appState.filters.type = document.getElementById('type').value;
                appState.filters.date = document.getElementById('date').value;
                appState.filters.gender = document.getElementById('gender').value;
                appState.filters.sort = document.getElementById('sort').value;

                const filteredAds = utils.filterAds(appState.ads, appState.filters, appState.userId, appState.hiddenAds);
                adRenderer.renderAdBatch(filteredAds, adList, appState, adActions);
            } catch (error) {
                console.error('Ошибка рендеринга объявлений:', error);
                utils.showNotification('Ошибка при отображении объявлений');
            }
        };

        // Обновление счётчиков
        const updateCounters = () => {
            try {
                const titleLength = document.getElementById('adTitle').value.length;
                const descriptionLength = document.getElementById('adDescription').value.length;
                document.getElementById('titleCounter').textContent = `${63 - titleLength}/63`;
                document.getElementById('descriptionCounter').textContent = `${500 - descriptionLength}/500`;
            } catch (error) {
                console.error('Ошибка обновления счётчиков:', error);
            }
        };

        // Открытие диалога фильтра
        const openFilterDialog = (filterType) => {
            try {
                const dialogId = `${filterType}Dialog`;
                utils.openDialog(dialogId);
            } catch (error) {
                console.error(`Ошибка открытия диалога фильтра ${filterType}:`, error);
                utils.showNotification('Ошибка при открытии фильтра');
            }
        };

        // Обработка фильтров
        const handleFilterSubmit = (filterType, event) => {
            try {
                event.preventDefault();
                const selectedValue = document.querySelector(`input[name="${filterType}Option"]:checked`)?.value || '';
                document.getElementById(filterType).value = selectedValue;
                appState.filters[filterType] = selectedValue;
                renderAds();
                utils.closeDialog(`${filterType}Dialog`);
            } catch (error) {
                console.error(`Ошибка применения фильтра ${filterType}:`, error);
                utils.showNotification('Ошибка при применении фильтра');
            }
        };

        // Обновление возраста профиля
        const updateProfileAge = () => {
            try {
                const birthDay = document.getElementById('birthDay').value;
                const birthMonth = document.getElementById('birthMonth').value;
                const birthYear = document.getElementById('birthYear').value;

                if (birthDay && birthMonth && birthYear) {
                    const birthDate = new Date(birthYear, birthMonth - 1, birthDay);
                    const ageDiffMs = Date.now() - birthDate.getTime();
                    const ageDate = new Date(ageDiffMs);
                    const age = Math.abs(ageDate.getUTCFullYear() - 1970);
                    document.getElementById('profileAge').textContent = `${age} лет`;
                }
            } catch (error) {
                console.error('Ошибка обновления возраста:', error);
                utils.showNotification('Ошибка при обновлении возраста');
            }
        };

        // Открытие диалога избранного
        const openFavoritesDialog = () => {
            try {
                utils.openDialog('favoritesDialog');
                adRenderer.renderFavorites();
            } catch (error) {
                console.error('Ошибка открытия избранного:', error);
                utils.showNotification('Ошибка при открытии избранного');
            }
        };

        // Переключение видимости кнопок
        const toggleSearchButtons = () => {
            try {
                const searchInput = document.getElementById('search').value.trim();
                const createButton = document.querySelector('button[data-modal-open="createDialog"]');
                createButton.classList.toggle('hidden', !!searchInput);
            } catch (error) {
                console.error('Ошибка переключения кнопок:', error);
            }
        };

        // Закрытие меню
        const closeMenus = (event) => {
            try {
                if (!event.target.classList.contains('menu')) {
                    document.querySelectorAll('.menu-options').forEach(menu => menu.classList.remove('show'));
                }
            } catch (error) {
                console.error('Ошибка закрытия меню:', error);
            }
        };

        // Вибрация
        const triggerVibration = () => {
            try {
                if ("vibrate" in navigator) {
                    navigator.vibrate(50);
                }
            } catch (error) {
                console.error('Ошибка вибрации:', error);
            }
        };

        // Создание объявления
        const createAd = (e) => {
            try {
                e.preventDefault();
                const title = document.getElementById('adTitle').value.trim();
                const description = document.getElementById('adDescription').value.trim();
                if (!title || !description) {
                    utils.showNotification('Заголовок и описание обязательны');
                    return;
                }
                const newAd = {
                    id: Date.now().toString(),
                    title,
                    description,
                    city: document.getElementById('adCity').value,
                    type: document.getElementById('adType').value,
                    date: document.getElementById('adDate').value,
                    gender: document.getElementById('adGender').value,
                    age: document.getElementById('adAge').value,
                    userId: appState.userId,
                    userName: appState.userName,
                    createdAt: new Date().toISOString()
                };
                appState.ads.push(newAd);
                localStorage.setItem('ads', JSON.stringify(appState.ads));
                utils.closeDialog('createDialog');
                document.getElementById('create-ad-form').reset();
                updateCounters();
                renderAds();
            } catch (error) {
                console.error('Ошибка создания объявления:', error);
                utils.showNotification('Ошибка при создании объявления');
            }
        };

        // Обновление объявления
        const updateAd = (e, adId) => {
            try {
                e.preventDefault();
                const adIndex = appState.ads.findIndex(ad => ad.id === adId);
                if (adIndex === -1) return;
                const title = document.getElementById('adTitle').value.trim();
                const description = document.getElementById('adDescription').value.trim();
                if (!title || !description) {
                    utils.showNotification('Заголовок и описание обязательны');
                    return;
                }
                appState.ads[adIndex] = {
                    ...appState.ads[adIndex],
                    title,
                    description,
                    city: document.getElementById('adCity').value,
                    type: document.getElementById('adType').value,
                    date: document.getElementById('adDate').value,
                    gender: document.getElementById('adGender').value,
                    age: document.getElementById('adAge').value,
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('ads', JSON.stringify(appState.ads));
                utils.closeDialog('createDialog');
                document.getElementById('create-ad-form').reset();
                updateCounters();
                renderAds();
                document.getElementById('create-ad-form').onsubmit = createAd;
                complaintAdId = null;
            } catch (error) {
                console.error(`Ошибка обновления ${adId}:`, error);
                utils.showNotification('Ошибка при сохранении изменений');
            }
        };

        // Отправка жалобы
        const submitComplaint = (e) => {
            try {
                e.preventDefault();
                const reason = document.getElementById('complaintText').value.trim();
                if (!reason) {
                    utils.showNotification('Укажите причину жалобы');
                    return;
                }
                console.log(`Жалоба на ${complaintAdId}: ${reason}`);
                utils.showNotification('Жалоба отправлена');
                utils.closeDialog('complaintDialog');
                document.getElementById('complaint-form').reset();
                complaintAdId = null;
            } catch (error) {
                console.error(`Ошибка отправки жалобы ${complaintAdId}:`, error);
                utils.showNotification('Ошибка при отправке жалобы');
            }
        };

        // Сброс приложения
        const resetApp = () => {
            try {
                appState.favorites = [];
                appState.hiddenAds = [];
                appState.participants = {};
                appState.likesDislikes = {};
                localStorage.setItem('favorites', JSON.stringify(appState.favorites));
                localStorage.setItem('hiddenAds', JSON.stringify(appState.hiddenAds));
                localStorage.setItem('participants', JSON.stringify(appState.participants));
                localStorage.setItem('likesDislikes', JSON.stringify(appState.likesDislikes));
                adRenderer.renderFavorites();
                renderAds();
                utils.showNotification('Данные сброшены');
            } catch (error) {
                console.error('Ошибка сброса приложения:', error);
                utils.showNotification('Ошибка при сбросе данных');
            }
        };

        // Инициализация
        async function init() {
            try {
                await loadCloudData();

                // Обработчики фильтров
                document.getElementById('city').addEventListener('click', () => openFilterDialog('city'));
                document.getElementById('type').addEventListener('click', () => openFilterDialog('type'));
                document.getElementById('date').addEventListener('click', () => openFilterDialog('date'));
                document.getElementById('gender').addEventListener('click', () => openFilterDialog('gender'));
                document.getElementById('sort').addEventListener('change', renderAds);

                // Обработчик поиска
                document.getElementById('search').addEventListener('input', () => {
                    renderAds();
                    toggleSearchButtons();
                });

                // Обработчики счётчиков
                document.getElementById('adTitle').addEventListener('input', updateCounters);
                document.getElementById('adDescription').addEventListener('input', updateCounters);

                // Обработчик поиска по избранному
                document.getElementById('favoritesSearch').addEventListener('input', adRenderer.renderFavorites);

                // Обработчик создания объявления
                document.getElementById('create-ad-form').addEventListener('submit', createAd);

                // Обработчик жалобы
                document.getElementById('complaint-form').addEventListener('submit', submitComplaint);

                // Обработчики фильтров
                document.getElementById('city-form').addEventListener('submit', (e) => handleFilterSubmit('city', e));
                document.getElementById('type-form').addEventListener('submit', (e) => handleFilterSubmit('type', e));
                document.getElementById('date-form').addEventListener('submit', (e) => handleFilterSubmit('date', e));
                document.getElementById('gender-form').addEventListener('submit', (e) => handleFilterSubmit('gender', e));

                // Обработчик кнопки создания
                document.querySelector('button[data-modal-open="createDialog"]').addEventListener('click', () => {
                    document.getElementById('create-ad-form').onsubmit = createAd;
                    document.getElementById('create-ad-form').reset();
                    updateCounters();
                    utils.openDialog('createDialog');
                });

                // Обработчики возраста
                document.getElementById('birthDay').addEventListener('input', updateProfileAge);
                document.getElementById('birthMonth').addEventListener('input', updateProfileAge);
                document.getElementById('birthYear').addEventListener('input', updateProfileAge);

                // Глобальные обработчики
                document.addEventListener('click', closeMenus);
                document.addEventListener('click', triggerVibration);

                renderAds();
            } catch (error) {
                console.error('Ошибка инициализации:', error);
                utils.showNotification('Приложение не запустилось', 5000);
            }
        }

        init();
    </script>
</body>
</html>
