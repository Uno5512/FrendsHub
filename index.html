<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FriendsHub</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Rubik', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 15px;
        }
        .image-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .header-image {
            max-width: 100%;
            height: auto;
        }
        .search-filter-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }
        #filter-form {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #search {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }
        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        select, button {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: #fff;
            cursor: pointer;
        }
        button {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        .ad-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .ad-item {
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .ad-item.own {
            border-left: 5px solid #007bff;
        }
        .ad-item.expanded .ad-content {
            display: block;
        }
        .ad-content {
            display: none;
            margin-top: 10px;
        }
        .description {
            margin: 10px 0;
            color: #666;
        }
        .tags {
            color: #888;
            font-size: 12px;
        }
        .user {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        .user-info {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .ad-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
        }
        .name {
            font-weight: 500;
            cursor: pointer;
        }
        .age {
            color: #888;
        }
        .ad-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .action img {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .action.liked, .action.disliked, .action.favorited {
            opacity: 1;
            filter: brightness(1.2);
        }
        .counter {
            font-size: 14px;
            color: #333;
        }
        .menu {
            cursor: pointer;
            font-size: 20px;
        }
        .menu-options {
            display: none;
            position: absolute;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border-radius: 5px;
            padding: 10px;
            z-index: 10;
        }
        .menu-options button {
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            color: #333;
            padding: 5px 10px;
            border: none;
            cursor: pointer;
        }
        .menu-options button:hover {
            background-color: #f0f0f0;
        }
        .dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 100;
            width: 90%;
            max-width: 400px;
        }
        .dialog.open {
            display: block;
        }
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 99;
        }
        .dialog-overlay.open {
            display: block;
        }
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }
        .notification.show {
            opacity: 1;
        }
        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: url('https://uno5512.github.io/FrendsHub/4.png') no-repeat center;
            background-size: 60%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .creator-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .join-btn {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            background-color: #28a745;
            color: #fff;
            border-radius: 20px;
            cursor: pointer;
            transition: width 0.3s ease;
        }
        .participant-count {
            margin-right: 10px;
        }
        .participant-avatars {
            display: flex;
        }
        .participant-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid #fff;
        }
        .refresh-loader {
            display: flex;
            gap: 5px;
        }
        .dot {
            width: 8px;
            height: 8px;
            background-color: #007bff;
            border-radius: 50%;
            animation: bounce 1.2s infinite;
        }
        .dot:nth-child(2) {
            animation-delay: 0.4s;
        }
        .dot:nth-child(3) {
            animation-delay: 0.8s;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <main class="container">
        <div class="image-container">
            <img class="header-image" src="https://uno5512.github.io/FrendsHub/3.png" alt="Логотип FriendsHub">
        </div>

        <section class="search-filter-container">
            <form id="filter-form">
                <input type="text" id="search" placeholder="Поиск" aria-label="Поиск объявлений">
                <div class="filters">
                    <select id="city" name="city" aria-label="Выберите город">
                        <option value="">Город</option>
                        <option value="Москва">Москва</option>
                        <option value="Санкт-Петербург">Санкт-Петербург</option>
                        <option value="Казань">Казань</option>
                    </select>
                    <select id="type" name="type" aria-label="Выберите вид активности">
                        <option value="">Вид</option>
                        <option value="Встреча">Встреча</option>
                        <option value="Чат">Чат</option>
                        <option value="Событие">Событие</option>
                    </select>
                    <select id="date" name="date" aria-label="Выберите дату">
                        <option value="">Дата</option>
                        <option value="Сегодня">Сегодня</option>
                        <option value="Завтра">Завтра</option>
                        <option value="На неделе">На неделе</option>
                    </select>
                    <select id="gender" name="gender" aria-label="Выберите пол">
                        <option value="">Пол</option>
                        <option value="Мужской">Мужской</option>
                        <option value="Женский">Женский</option>
                        <option value="Любой">Любой</option>
                    </select>
                    <select id="sort" name="sort" aria-label="Сортировка">
                        <option value="rating">По рейтингу</option>
                        <option value="newest">Новые</option>
                        <option value="oldest">Старые</option>
                    </select>
                </div>
            </form>
            <div class="refresh-loader" id="refreshLoader">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        </section>

        <section class="ad-list" id="adList" aria-label="Список объявлений"></section>

        <button type="button" data-modal-open="createDialog" aria-label="Создать объявление">+ Создать</button>

        <button class="floating-btn" onclick="openFavoritesDialog()" aria-label="Открыть избранное"></button>
    </main>

    <div class="dialog-overlay" id="dialogOverlay"></div>

    <dialog class="dialog" id="createDialog">
        <h2>Создать объявление</h2>
        <input type="text" id="createTitle" placeholder="Заголовок" required>
        <textarea id="createDescription" placeholder="Описание" required></textarea>
        <select id="createCity">
            <option value="Москва">Москва</option>
            <option value="Санкт-Петербург">Санкт-Петербург</option>
            <option value="Казань">Казань</option>
        </select>
        <select id="createType">
            <option value="Встреча">Встреча</option>
            <option value="Чат">Чат</option>
            <option value="Событие">Событие</option>
        </select>
        <select id="createDate">
            <option value="Сегодня">Сегодня</option>
            <option value="Завтра">Завтра</option>
            <option value="На неделе">На неделе</option>
        </select>
        <select id="createGender">
            <option value="Мужской">Мужской</option>
            <option value="Женский">Женский</option>
            <option value="Любой">Любой</option>
        </select>
        <input type="text" id="createAge" placeholder="Возраст (опционально)">
        <button onclick="submitCreateAd()">Создать</button>
        <button onclick="closeDialog('createDialog')">Отмена</button>
    </dialog>

    <dialog class="dialog" id="editDialog">
        <h2>Редактировать объявление</h2>
        <input type="text" id="editTitle" placeholder="Заголовок" required>
        <textarea id="editDescription" placeholder="Описание" required></textarea>
        <select id="editCity">
            <option value="Москва">Москва</option>
            <option value="Санкт-Петербург">Санкт-Петербург</option>
            <option value="Казань">Казань</option>
        </select>
        <select id="editType">
            <option value="Встреча">Встреча</option>
            <option value="Чат">Чат</option>
            <option value="Событие">Событие</option>
        </select>
        <select id="editDate">
            <option value="Сегодня">Сегодня</option>
            <option value="Завтра">Завтра</option>
            <option value="На неделе">На неделе</option>
        </select>
        <select id="editGender">
            <option value="Мужской">Мужской</option>
            <option value="Женский">Женский</option>
            <option value="Любой">Любой</option>
        </select>
        <input type="text" id="editAge" placeholder="Возраст (опционально)">
        <button onclick="submitEditAd()">Сохранить</button>
        <button onclick="closeDialog('editDialog')">Отмена</button>
    </dialog>

    <dialog class="dialog" id="favoritesDialog">
        <h2>Избранное</h2>
        <div id="favoritesList"></div>
        <button onclick="closeDialog('favoritesDialog')">Закрыть</button>
    </dialog>

    <dialog class="dialog" id="complaintDialog">
        <h2>Пожаловаться</h2>
        <textarea id="complaintReason" placeholder="Причина жалобы" required></textarea>
        <button onclick="submitComplaint()">Отправить</button>
        <button onclick="closeDialog('complaintDialog')">Отмена</button>
    </dialog>

    <div class="notification" id="notification"></div>

    <script>
        // Centralized State
        const state = {
            ads: [],
            hiddenAds: [],
            favorites: [],
            likesDislikes: {},
            participants: {},
            userId: 'user-1',
            userName: 'TONI',
            isTelegramMode: false,
            editAdId: null,
            renderedAdsCount: 0,
            lazyLoadBatchSize: 10
        };

        // Utility Functions
        function createElement(tag, attributes = {}, children = []) {
            const element = document.createElement(tag);
            Object.assign(element, attributes);
            if (Array.isArray(children)) {
                children.forEach(child => element.append(child));
            } else if (children) {
                element.append(children);
            }
            return element;
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 2000);
        }

        function openDialog(dialogId) {
            document.getElementById(dialogId).classList.add('open');
            document.getElementById('dialogOverlay').classList.add('open');
        }

        function closeDialog(dialogId) {
            document.getElementById(dialogId).classList.remove('open');
            document.getElementById('dialogOverlay').classList.remove('open');
        }

        // Ad Renderer
        const adRenderer = {
            createAdElement: (ad) => {
                const isLiked = state.likesDislikes[ad.id]?.likes.includes(state.userId);
                const isDisliked = state.likesDislikes[ad.id]?.dislikes.includes(state.userId);
                const isFavorited = state.favorites.includes(ad.id);
                const avatarSrc = ad.userId === state.userId ? 'https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/51174a180992325.6514258f750ff.jpg' : 'https://mir-s3-cdn-cf.behance.net/project_modules/fs/90e60f125956251.6123f46744b17.jpg';
                const participantCount = state.participants[ad.id]?.length || 0;
                const rating = (state.likesDislikes[ad.id]?.likes?.length || 0) - (state.likesDislikes[ad.id]?.dislikes?.length || 0);

                let participantAvatarsHtml = '';
                state.participants[ad.id]?.forEach((pUserId, pIndex) => {
                    const pAvatarSrc = pUserId === state.userId ? 'https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/51174a180992325.6514258f750ff.jpg' : 'https://mir-s3-cdn-cf.behance.net/project_modules/fs/90e60f125956251.6123f46744b17.jpg';
                    participantAvatarsHtml += `<img class="participant-avatar" src="${pAvatarSrc}" alt="Аватар участника ${pUserId}" style="z-index: ${pIndex}; transform: translateX(${pIndex * -8}px);">`;
                });

                const adItem = createElement('article', {
                    className: `ad-item ${ad.userId === state.userId ? 'own' : ''}`,
                    'data-ad-id': ad.id,
                    style: 'opacity: 0; transform: translateY(50px);'
                }, [
                    createElement('h3', { onclick: () => toggleAdExpansion(ad.id) }, ad.title),
                    createElement('div', { className: 'ad-content' }, [
                        createElement('p', { className: 'description', onclick: () => toggleAdExpansion(ad.id) }, ad.description),
                        createElement('p', { className: 'tags' }, `<small>Город: ${ad.city} | Вид: ${ad.type} | Дата: ${ad.date} | Пол: ${ad.gender} | ${new Date(ad.createdAt).toLocaleDateString()}</small>`),
                        createElement('div', { className: 'creator-container' }, [
                            createElement('img', { className: 'ad-avatar', src: avatarSrc, alt: `Аватар ${ad.userName}`, onclick: () => openTelegramProfile(ad.userId) }),
                            createElement('div', { className: 'join-btn', onclick: () => joinEvent(ad.id), style: `width: calc(48px + ${participantCount * 24}px)` }, [
                                createElement('span', { className: 'participant-count' }, participantCount),
                                createElement('div', { className: 'participant-avatars' }, participantAvatarsHtml)
                            ])
                        ])
                    ]),
                    createElement('div', { className: 'user' }, [
                        createElement('div', { className: 'user-info' }, [
                            createElement('span', { className: 'name', onclick: () => openTelegramProfile(ad.userId) }, ad.userName),
                            createElement('span', { className: 'age' }, ad.age || 'Не указан')
                        ]),
                        createElement('div', { className: 'ad-actions' }, [
                            createElement('span', { className: 'counter' }, rating),
                            createElement('span', { className: 'action share', onclick: () => shareAd(ad.id) }, `<img src="https://uno5512.github.io/FrendsHub/5.png" alt="Поделиться">`),
                            createElement('span', { className: `action favorite ${isFavorited ? 'favorited' : ''}`, onclick: () => toggleFavorite(ad.id) }, `<img src="https://uno5512.github.io/FrendsHub/4.png" alt="Избранное">`),
                            createElement('span', { className: `action like ${isLiked ? 'liked' : ''}`, onclick: () => toggleLike(ad.id) }, `<img src="https://uno5512.github.io/FrendsHub/2.png" alt="Лайк">`),
                            createElement('span', { className: `action dislike ${isDisliked ? 'disliked' : ''}`, onclick: () => toggleDislike(ad.id) }, `<img src="https://uno5512.github.io/FrendsHub/1.png" alt="Дизлайк">`),
                            createElement('span', { className: 'menu', onclick: () => toggleMenu(ad.id) }, '•••')
                        ])
                    ]),
                    createElement('div', { className: 'menu-options', id: `menu-${ad.id}` }, [
                        ...(ad.userId === state.userId ? [
                            createElement('button', { onclick: () => editAd(ad.id) }, 'Редактировать'),
                            createElement('button', { onclick: () => deleteAd(ad.id) }, 'Удалить')
                        ] : [
                            createElement('button', { onclick: () => hideAd(ad.id) }, 'Не показывать'),
                            createElement('button', { onclick: () => openComplaintDialog(ad.id) }, 'Пожаловаться')
                        ])
                    ])
                ]);

                return adItem;
            },

            renderAds: () => {
                const adList = document.getElementById('adList');
                const filteredAds = filterAds(state.ads.filter(ad => !state.hiddenAds.includes(ad.id)));
                adList.innerHTML = '';
                state.renderedAdsCount = 0;

                const start = state.renderedAdsCount;
                const end = Math.min(start + state.lazyLoadBatchSize, filteredAds.length);
                const batch = filteredAds.slice(start, end);

                batch.forEach((ad, index) => {
                    const adElement = adRenderer.createAdElement(ad);
                    adList.appendChild(adElement);
                    setTimeout(() => {
                        adElement.style.opacity = '1';
                        adElement.style.transform = 'translateY(0)';
                    }, index * 100);
                });

                state.renderedAdsCount = end;
            },

            updateAdActions: (adId) => {
                const adItem = document.querySelector(`.ad-item[data-ad-id="${adId}"]`);
                if (!adItem) return;

                const isLiked = state.likesDislikes[adId]?.likes.includes(state.userId);
                const isDisliked = state.likesDislikes[adId]?.dislikes.includes(state.userId);
                const isFavorited = state.favorites.includes(adId);
                const rating = (state.likesDislikes[adId]?.likes?.length || 0) - (state.likesDislikes[adId]?.dislikes?.length || 0);

                const likeButton = adItem.querySelector('.action.like');
                const dislikeButton = adItem.querySelector('.action.dislike');
                const favoriteButton = adItem.querySelector('.action.favorite');
                const counter = adItem.querySelector('.counter');

                likeButton.classList.toggle('liked', isLiked);
                dislikeButton.classList.toggle('disliked', isDisliked);
                favoriteButton.classList.toggle('favorited', isFavorited);
                counter.textContent = rating;

                if (document.getElementById('sort').value === 'rating') {
                    adRenderer.renderAds();
                }
            }
        };

        // State Management
        function saveState() {
            try {
                localStorage.setItem('ads', JSON.stringify(state.ads));
                localStorage.setItem('hiddenAds', JSON.stringify(state.hiddenAds));
                localStorage.setItem('favorites', JSON.stringify(state.favorites));
                localStorage.setItem('likesDislikes', JSON.stringify(state.likesDislikes));
                localStorage.setItem('participants', JSON.stringify(state.participants));

                if (state.isTelegramMode && Telegram?.WebApp?.CloudStorage) {
                    Telegram.WebApp.CloudStorage.setItem('ads', JSON.stringify(state.ads));
                    Telegram.WebApp.CloudStorage.setItem('hiddenAds', JSON.stringify(state.hiddenAds));
                    Telegram.WebApp.CloudStorage.setItem('favorites', JSON.stringify(state.favorites));
                    Telegram.WebApp.CloudStorage.setItem('likesDislikes', JSON.stringify(state.likesDislikes));
                    Telegram.WebApp.CloudStorage.setItem('participants', JSON.stringify(state.participants));
                }
            } catch (error) {
                showNotification('Ошибка сохранения данных');
                console.error('Save state error:', error);
            }
        }

        async function loadState() {
            try {
                const ads = JSON.parse(localStorage.getItem('ads')) || [];
                const hiddenAds = JSON.parse(localStorage.getItem('hiddenAds')) || [];
                const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
                const likesDislikes = JSON.parse(localStorage.getItem('likesDislikes')) || {};
                const participants = JSON.parse(localStorage.getItem('participants')) || {};

                state.ads = ads;
                state.hiddenAds = hiddenAds;
                state.favorites = favorites;
                state.likesDislikes = likesDislikes;
                state.participants = participants;

                if (state.isTelegramMode && Telegram?.WebApp?.CloudStorage) {
                    await loadCloudData();
                }
            } catch (error) {
                showNotification('Ошибка загрузки данных');
                console.error('Load state error:', error);
            }
        }

        async function loadCloudData() {
            if (!state.isTelegramMode || !Telegram?.WebApp?.CloudStorage) return;

            try {
                document.getElementById('refreshLoader').style.display = 'flex';
                const keys = ['ads', 'hiddenAds', 'favorites', 'likesDislikes', 'participants'];
                const promises = keys.map(key => new Promise((resolve, reject) => {
                    Telegram.WebApp.CloudStorage.getItem(key, (error, result) => {
                        if (error) reject(error);
                        else resolve({ key, result });
                    });
                }));

                const results = await Promise.all(promises);
                results.forEach(({ key, result }) => {
                    if (result) state[key] = JSON.parse(result);
                });
            } catch (error) {
                showNotification('Не удалось загрузить данные из облака');
                console.error('Cloud load error:', error);
            } finally {
                document.getElementById('refreshLoader').style.display = 'none';
            }
        }

        // Event Handlers
        function toggleAdExpansion(adId) {
            const adItem = document.querySelector(`.ad-item[data-ad-id="${adId}"]`);
            adItem.classList.toggle('expanded');
        }

        function openTelegramProfile(userId) {
            if (state.isTelegramMode && Telegram?.WebApp) {
                Telegram.WebApp.openTelegramLink(`https://t.me/${userId}`);
            } else {
                showNotification(`Профиль: ${userId}`);
            }
        }

        function shareAd(adId) {
            const ad = state.ads.find(ad => ad.id === adId);
            const text = `${ad.title}\n${ad.description}\n${ad.city} | ${ad.type} | ${ad.date}`;
            if (state.isTelegramMode && Telegram?.WebApp) {
                Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(text)}`);
            } else {
                navigator.clipboard.writeText(text);
                showNotification('Скопировано в буфер обмена');
            }
        }

        function toggleFavorite(adId) {
            try {
                const index = state.favorites.indexOf(adId);
                if (index === -1) state.favorites.push(adId);
                else state.favorites.splice(index, 1);
                adRenderer.updateAdActions(adId);
                saveState();
            } catch (error) {
                showNotification('Ошибка при изменении избранного');
                console.error('Toggle favorite error:', error);
            }
        }

        function toggleLike(adId) {
            try {
                state.likesDislikes[adId] = state.likesDislikes[adId] || { likes: [], dislikes: [] };
                const likes = state.likesDislikes[adId].likes;
                const dislikes = state.likesDislikes[adId].dislikes;

                if (likes.includes(state.userId)) {
                    likes.splice(likes.indexOf(state.userId), 1);
                } else {
                    likes.push(state.userId);
                    if (dislikes.includes(state.userId)) {
                        dislikes.splice(dislikes.indexOf(state.userId), 1);
                    }
                }
                adRenderer.updateAdActions(adId);
                saveState();
            } catch (error) {
                showNotification('Ошибка при постановке лайка');
                console.error('Toggle like error:', error);
            }
        }

        function toggleDislike(adId) {
            try {
                state.likesDislikes[adId] = state.likesDislikes[adId] || { likes: [], dislikes: [] };
                const likes = state.likesDislikes[adId].likes;
                const dislikes = state.likesDislikes[adId].dislikes;

                if (dislikes.includes(state.userId)) {
                    dislikes.splice(dislikes.indexOf(state.userId), 1);
                } else {
                    dislikes.push(state.userId);
                    if (likes.includes(state.userId)) {
                        likes.splice(likes.indexOf(state.userId), 1);
                    }
                }
                adRenderer.updateAdActions(adId);
                saveState();
            } catch (error) {
                showNotification('Ошибка при постановке дизлайка');
                console.error('Toggle dislike error:', error);
            }
        }

        function toggleMenu(adId) {
            const menu = document.getElementById(`menu-${adId}`);
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function editAd(adId) {
            const ad = state.ads.find(ad => ad.id === adId);
            state.editAdId = adId;
            document.getElementById('editTitle').value = ad.title;
            document.getElementById('editDescription').value = ad.description;
            document.getElementById('editCity').value = ad.city;
            document.getElementById('editType').value = ad.type;
            document.getElementById('editDate').value = ad.date;
            document.getElementById('editGender').value = ad.gender;
            document.getElementById('editAge').value = ad.age || '';
            openDialog('editDialog');
            toggleMenu(adId);
        }

        function deleteAd(adId) {
            try {
                state.ads = state.ads.filter(ad => ad.id !== adId);
                state.favorites = state.favorites.filter(id => id !== adId);
                delete state.likesDislikes[adId];
                delete state.participants[adId];
                adRenderer.renderAds();
                saveState();
                toggleMenu(adId);
                showNotification('Объявление удалено');
            } catch (error) {
                showNotification('Ошибка при удалении объявления');
                console.error('Delete ad error:', error);
            }
        }

        function hideAd(adId) {
            try {
                if (!state.hiddenAds.includes(adId)) {
                    state.hiddenAds.push(adId);
                    adRenderer.renderAds();
                    saveState();
                    showNotification('Объявление скрыто');
                }
                toggleMenu(adId);
            } catch (error) {
                showNotification('Ошибка при скрытии объявления');
                console.error('Hide ad error:', error);
            }
        }

        function joinEvent(adId) {
            try {
                state.participants[adId] = state.participants[adId] || [];
                if (!state.participants[adId].includes(state.userId)) {
                    state.participants[adId].push(state.userId);
                    adRenderer.renderAds();
                    saveState();
                    showNotification('Вы присоединились к событию');
                }
            } catch (error) {
                showNotification('Ошибка при присоединении к событию');
                console.error('Join event error:', error);
            }
        }

        function filterAds(ads) {
            const search = document.getElementById('search').value.toLowerCase();
            const city = document.getElementById('city').value;
            const type = document.getElementById('type').value;
            const date = document.getElementById('date').value;
            const gender = document.getElementById('gender').value;
            const sort = document.getElementById('sort').value;

            let filtered = ads.filter(ad =>
                ad.title.toLowerCase().includes(search) ||
                ad.description.toLowerCase().includes(search)
            );

            if (city) filtered = filtered.filter(ad => ad.city === city);
            if (type) filtered = filtered.filter(ad => ad.type === type);
            if (date) filtered = filtered.filter(ad => ad.date === date);
            if (gender) filtered = filtered.filter(ad => ad.gender === gender);

            if (sort === 'rating') {
                filtered.sort((a, b) => {
                    const ratingA = (state.likesDislikes[a.id]?.likes?.length || 0) - (state.likesDislikes[a.id]?.dislikes?.length || 0);
                    const ratingB = (state.likesDislikes[b.id]?.likes?.length || 0) - (state.likesDislikes[b.id]?.dislikes?.length || 0);
                    return ratingB - ratingA;
                });
            } else if (sort === 'newest') {
                filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            } else if (sort === 'oldest') {
                filtered.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            }

            return filtered;
        }

        // Dialog Handlers
        document.querySelector('[data-modal-open="createDialog"]').addEventListener('click', () => openDialog('createDialog'));

        function submitCreateAd() {
            try {
                const ad = {
                    id: Date.now().toString(),
                    userId: state.userId,
                    userName: state.userName,
                    title: document.getElementById('createTitle').value,
                    description: document.getElementById('createDescription').value,
                    city: document.getElementById('createCity').value,
                    type: document.getElementById('createType').value,
                    date: document.getElementById('createDate').value,
                    gender: document.getElementById('createGender').value,
                    age: document.getElementById('createAge').value || '',
                    createdAt: new Date().toISOString()
                };
                state.ads.push(ad);
                adRenderer.renderAds();
                saveState();
                closeDialog('createDialog');
                showNotification('Объявление создано');
            } catch (error) {
                showNotification('Ошибка при создании объявления');
                console.error('Create ad error:', error);
            }
        }

        function submitEditAd() {
            try {
                const adIndex = state.ads.findIndex(ad => ad.id === state.editAdId);
                state.ads[adIndex] = {
                    ...state.ads[adIndex],
                    title: document.getElementById('editTitle').value,
                    description: document.getElementById('editDescription').value,
                    city: document.getElementById('editCity').value,
                    type: document.getElementById('editType').value,
                    date: document.getElementById('editDate').value,
                    gender: document.getElementById('editGender').value,
                    age: document.getElementById('editAge').value || ''
                };
                adRenderer.renderAds();
                saveState();
                closeDialog('editDialog');
                showNotification('Объявление обновлено');
            } catch (error) {
                showNotification('Ошибка при редактировании объявления');
                console.error('Edit ad error:', error);
            }
        }

        function openFavoritesDialog() {
            const favoritesList = document.getElementById('favoritesList');
            favoritesList.innerHTML = '';
            const favoriteAds = state.ads.filter(ad => state.favorites.includes(ad.id));
            favoriteAds.forEach(ad => {
                const item = createElement('div', {}, ad.title);
                favoritesList.appendChild(item);
            });
            openDialog('favoritesDialog');
        }

        function openComplaintDialog(adId) {
            state.editAdId = adId;
            openDialog('complaintDialog');
            toggleMenu(adId);
        }

        function submitComplaint() {
            try {
                const reason = document.getElementById('complaintReason').value;
                showNotification(`Жалоба на объявление ${state.editAdId} отправлена: ${reason}`);
                closeDialog('complaintDialog');
            } catch (error) {
                showNotification('Ошибка при отправке жалобы');
                console.error('Submit complaint error:', error);
            }
        }

        // Filter and Sort Listeners
        document.getElementById('filter-form').addEventListener('input', () => adRenderer.renderAds());

        // Initialization
        async function init() {
            state.isTelegramMode = !!window.Telegram?.WebApp?.initData;
            await loadState();
            adRenderer.renderAds();

            if (state.ads.length === 0) {
                state.ads.push({
                    id: '1',
                    userId: 'user-2',
                    userName: 'Alex',
                    title: 'Встреча в парке',
                    description: 'Приглашаю на прогулку в парке!',
                    city: 'Москва',
                    type: 'Встреча',
                    date: 'Сегодня',
                    gender: 'Любой',
                    age: '25',
                    createdAt: new Date().toISOString()
                });
                saveState();
                adRenderer.renderAds();
            }
        }

        init();
    </script>
</body>
</html>
