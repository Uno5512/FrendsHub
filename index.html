<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FriendsHub</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* Ваш CSS остается БЕЗ ИЗМЕНЕНИЙ  */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rubik', sans-serif;
            background: #eedfc8;
            color: #1A2A44;
            padding: 16px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 600px;
            width: 100%;
        }

        .image-container {
            display: flex;
            justify-content: center;
            margin-top: 16px;
            margin-bottom: 10px;
        }

        .header-image {
            width: 100px;
            height: 100px;
            object-fit: contain;
        }

        .search-filter-container {
            background: #f1d299;
            border: 2px solid #f6e1bc;
            border-radius: 22px;
            padding: 8px;
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: sticky;
            top: 16px;
            z-index: 100;
        }

        .refresh-loader {
            display: none;
            text-align: center;
            padding: 12px;
            background: #f1d299;
            border-radius: 22px;
        }

        .refresh-loader.active {
            display: block;
        }

        .refresh-loader .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #987eeb;
            border-radius: 50%;
            margin: 0 4px;
            animation: bounce 0.6s infinite alternate;
        }

        .refresh-loader .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .refresh-loader .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            to {
                transform: translateY(-6px);
            }
        }

        .search-filter-container input {
            padding: 8px;
            font-size: 22px;
            border-radius: 8px;
            background: #f1d299;
            border: none;
            width: 100%;
        }

        .search-filter-container input:focus {
            outline: none;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin-top: 4px;
        }

        .filters select {
            padding: 4px;
            font-size: 18px;
            background: #f1d299;
            border: 1px solid #f6e1bc;
            border-radius: 22px;
            cursor: pointer;
            flex: 1;
            min-width: 60px;
        }

        .filters select:focus {
            outline: none;
        }

        button[data-modal-open="createDialog"] {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            width: 160px;
            height: 80px;
            background: #987eeb;
            opacity: 0.5;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: #fff;
            border: none;
            border-radius: 24px;
            font-size: 16px;
            cursor: pointer;
            z-index: 1002;
            transition: bottom 0.3s ease;
            bottom: 0;
        }

        button[data-modal-open="createDialog"].hidden {
            bottom: -60px;
        }

        dialog {
            border: none;
            border-radius: 8px;
            background: #fff;
            padding: 16px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1003;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
        }

        dialog form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        dialog h2 {
            font-size: 18px;
            margin-bottom: 16px;
        }

        dialog select,
        dialog input,
        dialog textarea {
            padding: 8px;
            font-size: 16px;
            background: #f1d299;
            border: none;
            border-radius: 8px;
        }

        dialog select:focus,
        dialog input:focus,
        dialog textarea:focus {
            outline: none;
        }

        dialog textarea {
            min-height: 100px;
            resize: vertical;
        }

        dialog button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
        }

        dialog button[type="button"] {
            background: #E5E7EB;
            color: #1A2A44;
            border: none;
        }

        dialog button[type="submit"],
        dialog button.close-btn {
            background: #987eeb;
            color: #fff;
            border: none;
        }

        .select-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .select-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #F5F5F5;
            border-radius: 8px;
            cursor: pointer;
        }

        .counter {
            font-size: 12px;
            color: #555;
            margin-top: 4px;
        }

        .ad-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 80px;
            scroll-behavior: smooth;
            position: relative;
        }

        .ad-item {
            background: #efefef;
            padding: 16px;
            padding-bottom: 14px;
            border-radius: 22px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: transform 0.5s ease, opacity 0.5s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100%;
        }

        .ad-item.removing {
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }

        .ad-item.own {
            border: 1px solid #ff6200;
        }

        .ad-item.expanded .ad-content {
            max-height: 1000px;
            opacity: 1;
        }

        .ad-item h3 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #41494e;
            hyphens: auto;
            word-wrap: break-word;
            white-space: normal;
            max-width: 100%;
            cursor: pointer;
        }

        .ad-item p.description {
            font-size: 18px;
            line-height: 1.5;
            color: #555;
            hyphens: auto;
            word-wrap: break-word;
            white-space: normal;
            cursor: pointer;
        }

        .ad-item p.tags {
            font-size: 12px;
            color: #555;
        }

        .ad-content {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.7s ease-in-out, opacity 0.7s ease-in-out;
            margin-bottom: 16px;
        }

        .creator-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            margin: 8px 0 4px 0;
        }

        .ad-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
        }

        .join-btn {
            width: 48px;
            height: 48px;
            background: #987eeb;
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: width 0.3s ease;
        }

        .join-btn .participant-count {
            font-size: 12px;
            color: #fff;
            position: relative;
            z-index: 10;
        }

        .join-btn .participant-avatars {
            display: flex;
            flex-direction: row;
            position: absolute;
            right: 8px;
            height: 24px;
            align-items: center;
        }

        .join-btn .participant-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #f6e1bc;
        }

        .ad-item .user {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: auto;
            gap: 12px;
        }

        .ad-item .user .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ad-item .user .name {
            font-size: 16px;
            font-weight: 500;
            color: #007bff;
            cursor: pointer;
        }

        .ad-item .user .age {
            font-size: 14px;
            color: #555;
        }

        .ad-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ad-actions .action {
            cursor: pointer;
            position: relative;
        }

        .ad-actions .action img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .ad-actions .liked::after,
        .ad-actions .disliked::after {
            content: '';
            position: absolute;
            top: calc(50% - 2px);
            left: 50%;
            transform: translate(-50%, -50%);
            width: 32px;
            height: 32px;
            background: #987eeb;
            border-radius: 50%;
            z-index: -1;
        }

        .ad-actions .action.share,
        .ad-actions .action.favorite,
        .ad-actions .action.like,
        .ad-actions .action.dislike {
            position: relative;
            top: 4px;
        }

        .menu {
            cursor: pointer;
            font-size: 20px;
        }

        .menu-options {
            display: none;
            position: absolute;
            top: 40px;
            right: 12px;
            background: #fff;
            border: 1px solid #E6E6E6;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .menu-options button {
            display: block;
            width: 100%;
            padding: 8px 16px;
            border: none;
            background: none;
            color: #000;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
        }

        .menu-options button:hover {
            background: #f1d299;
        }

        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #987eeb;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .floating-btn.hidden {
            display: none;
        }

        .floating-btn::before {
            content: '←';
            font-size: 24px;
        }

        .profile {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 8px;
            background: #f1d299;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }

        .profile img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile .info {
            display: flex;
            flex-direction: column;
        }

        .profile .info .name {
            font-size: 16px;
            font-weight: 500;
        }

        .profile .info .age {
            font-size: 14px;
            color: #555;
        }

        .age-picker {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .age-picker input {
            width: 60px;
            padding: 4px;
            font-size: 16px;
            text-align: center;
            background: #f1d299;
            border: none;
            border-radius: 8px;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        .age-picker input::-webkit-inner-spin-button,
        .age-picker input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .favorites-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .favorites-list .favorite-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #F5F5F5;
            border-radius: 8px;
            cursor: pointer;
        }

        .favorites-list .favorite-item img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }

        #notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1001;
        }

        #notification.show {
            opacity: 1;
        }

        #complaintDialog textarea {
            min-height: 80px;
            resize: vertical;
        }

        #complaintDialog button[type="submit"] {
            background-color: #f44336;
        }

        @media (max-width: 600px) {
            .container {
                width: 100%;
                padding: 8px;
            }

            .search-filter-container {
                position: static;
            }

            .filters {
                flex-direction: column;
                gap: 8px;
            }

            .filters select {
                width: 100%;
            }

            .ad-item {
                padding: 12px;
            }

            .ad-item h3 {
                font-size: 16px;
            }

            .ad-item p {
                font-size: 14px;
            }

            .ad-avatar {
                width: 40px;
                height: 40px;
            }

            .join-btn {
                width: 40px;
                height: 40px;
            }

            .ad-actions {
                gap: 8px;
            }

            .ad-actions img {
                width: 20px;
                height: 20px;
            }

            .menu {
                font-size: 16px;
            }

            .menu-options {
                top: 32px;
                right: 8px;
            }

            .menu-options button {
                padding: 6px 12px;
            }

            .floating-btn {
                bottom: 10px;
                right: 10px;
                width: 50px;
                height: 50px;
            }

            .floating-btn::before {
                font-size: 20px;
            }

            dialog {
                width: 95%;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body>

    <div class="container">
        <div class="image-container">
            <img src="https://uno5512.github.io/FrendsHub/3.png" alt="FriendsHub" class="header-image">
        </div>

        <div class="search-filter-container">
            <input type="text" id="search" placeholder="Поиск...">
            <div class="filters">
                <select id="city">
                    <option value="">Город</option>
                </select>
                <select id="type">
                    <option value="">Вид</option>
                </select>
                <select id="date">
                    <option value="">Дата</option>
                </select>
                <select id="gender">
                    <option value="">Пол</option>
                </select>
                <select id="sort">
                    <option value="date">Сначала новые</option>
                    <option value="rating">По рейтингу</option>
                </select>
            </div>
        </div>

        <div class="refresh-loader">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>

        <div class="profile">
            <img src="https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/51174a180992325.6514258f750ff.jpg"
                alt="User Avatar" id="profileAvatar">
            <div class="info">
                <span class="name" id="profileName">User Name</span>
                <div class="age-picker">
                    <input type="number" id="birthDay" placeholder="ДД" min="1" max="31">
                    <input type="number" id="birthMonth" placeholder="ММ" min="1" max="12">
                    <input type="number" id="birthYear" placeholder="ГГГГ" min="1900"
                        max="2024">
                </div>
                <span class="age" id="profileAge">Возраст не указан</span>
            </div>
        </div>

        <div class="favorites-list">
            <h2>Избранное</h2>
            <input type="text" id="favoritesSearch" placeholder="Поиск в избранном...">
            <div id="favoritesContainer"></div>
        </div>

        <div id="adList" class="ad-list"></div>

        <button data-modal-open="createDialog" class="floating-button">
            <span>+</span>
        </button>

        <dialog id="createDialog">
            <form id="adForm">
                <h2>Создать объявление</h2>
                <input type="text" id="adTitle" placeholder="Заголовок" maxlength="100" required>
                <textarea id="adDescription" placeholder="Описание" maxlength="500" required></textarea>
                <div class="select-options">
                    <select id="adCity" required>
                        <option value="">Выберите город</option>
                    </select>
                    <select id="adType" required>
                        <option value="">Выберите вид</option>
                    </select>
                    <select id="adDate" required>
                        <option value="">Выберите дату</option>
                    </select>
                    <select id="adGender" required>
                        <option value="">Выберите пол</option>
                    </select>
                </div>
                <button type="submit">Опубликовать</button>
                <button type="button" class="close-btn" data-modal-close="createDialog">Отмена</button>
                <span class="counter" id="titleCounter">0/100</span>
                <span class="counter" id="descriptionCounter">0/500</span>
            </form>
        </dialog>

        <dialog id="complaintDialog">
            <form id="complaintForm">
                <h2>Пожаловаться на объявление</h2>
                <textarea id="complaintText" placeholder="Причина жалобы" required></textarea>
                <button type="submit">Отправить жалобу</button>
                <button type="button" class="close-btn" data-modal-close="complaintDialog">Отмена</button>
            </form>
        </dialog>

        <div id="notification"></div>

    </div>

    <script>
        // utils.js (вспомогательные функции)
        const utils = {
            createElement: (tag, attributes, children) => {
                const element = document.createElement(tag);
                Object.assign(element, attributes);
                if (Array.isArray(children)) {
                    children.forEach(child => element.append(child));
                } else if (children) {
                    element.append(child);
                }
                return element;
            },

            showNotification: (message) => {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 2000);
            },

            openDialog: (dialogId) => {
                document.getElementById(dialogId).showModal();
            },

            closeDialog: (dialogId) => {
                document.getElementById(dialogId).close();
            },

            toggleElementVisibility: (elementId, isVisible) => {
                const element = document.getElementById(elementId);
                element.style.display = isVisible ? 'block' : 'none';
            },

            debounce: (func, delay) => {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func(...args), delay);
                };
            },

            isElementInViewport: (el) => {
                const rect = el.getBoundingClientRect();
                return (
                    rect.top >= 0 &&
                    rect.left >= 0 &&
                    rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                    rect.right <= (window.innerWidth || document.documentElement.clientWidth)
                );
            },

            animateElement: (element, animationName, callback) => {
                element.classList.add('animate__animated', 'animate__' + animationName);
                element.addEventListener('animationend', () => {
                    element.classList.remove('animate__animated', 'animate__' + animationName);
                    if (callback) callback();
                }, { once: true });
            }
        };

        // ad-renderer.js (рендеринг объявлений)
        const adRenderer = {
            createAdElement: (ad, userId, likesDislikes, favorites, participants,
                toggleAdExpansion, openTelegramProfile, shareAd, toggleFavorite,
                toggleLike, toggleDislike, toggleMenu, editAd, deleteAd, hideAd,
                openComplaintDialog, joinEvent) => {
                const isLiked = likesDislikes[ad.id]?.likes.includes(userId);
                const isDisliked = likesDislikes[ad.id]?.dislikes.includes(userId);
                const isFavorited = favorites.includes(ad.id);
                const avatarSrc = ad.userId === 'user-1' ? 'https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/51174a180992325.6514258f750ff.jpg' : 'https://mir-s3-cdn-cf.behance.net/project_modules/fs/90e60f125956251.6123f46744b17.jpg';
                const participantCount = participants[ad.id]?.length || 0;
                const rating = (likesDislikes[ad.id]?.likes?.length || 0) - (likesDislikes[ad.id]?.dislikes?.length || 0);

                let participantAvatarsHtml = '';
                participants[ad.id]?.forEach((pUserId, pIndex) => {
                    const pAvatarSrc = pUserId === 'user-1' ? 'https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/51174a180992325.6514258f750ff.jpg' : 'https://mir-s3-cdn-cf.behance.net/project_modules/fs/90e60f125956251.6123f46744b17.jpg';
                    participantAvatarsHtml += `<img class="participant-avatar" src="${pAvatarSrc}" alt="Аватар участника ${pUserId}" style="z-index: ${pIndex}; transform: translateX(${pIndex * -8}px);">`;
                });

                const adItem = utils.createElement('article', {
                    className: `ad-item ${ad.userId === userId ? 'own' : ''}`,
                    'aria-label': `Объявление от ${ad.userName}`,
                    'data-ad-id': ad.id,
                    style: 'opacity: 0; transform: translateY(50px);'
                }, [
                    utils.createElement('h3', { onclick: () => toggleAdExpansion(ad.id) }, ad.title),
                    utils.createElement('div', { className: 'ad-content' }, [
                        utils.createElement('p', { className: 'description', onclick: () => toggleAdExpansion(ad.id) }, ad.description),
                        utils.createElement('p', { className: 'tags' }, `<small>Город: ${ad.city} | Вид: ${ad.type} | Дата: ${ad.date} | Пол: ${ad.gender} | ${new Date(ad.createdAt).toLocaleDateString()}</small>`),
                        utils.createElement('div', { className: 'creator-container' }, [
                            utils.createElement('img', { className: 'ad-avatar', src: avatarSrc, alt: `Аватар ${ad.userName}`, onclick: () => openTelegramProfile(ad.userId) }),
                            utils.createElement('div', { className: 'join-btn', onclick: () => joinEvent(ad.id), style: `width: calc(48px + ${participantCount * 24}px)` }, [
                                utils.createElement('span', { className: 'participant-count' }, participantCount),
                                utils.createElement('div', { className: 'participant-avatars' }, participantAvatarsHtml)
                            ])
                        ])
                    ]),
                    utils.createElement('div', { className: 'user' }, [
                        utils.createElement('div', { className: 'user-info' }, [
                            utils.createElement('span', { className: 'name', onclick: () => openTelegramProfile(ad.userId) }, ad.userName),
                            utils.createElement('span', { className: 'age' }, ad.age || 'Не указан')
                        ]),
                        utils.createElement('div', { className: 'ad-actions' }, [
                            utils.createElement('span', { className: 'counter' }, rating),
                            utils.createElement('span', { className: 'action share', onclick: () => shareAd(ad.id) }, `<img src="https://uno5512.github.io/FrendsHub/5.png" alt="Поделиться">`),
                            utils.createElement('span', { className: `action favorite ${isFavorited ? 'favorited' : ''}`, onclick: () => toggleFavorite(ad.id) }, `<img src="https://uno5512.github.io/FrendsHub/4.png" alt="Избранное">`),
                            utils.createElement('span', { className: `action like ${isLiked ? 'liked' : ''}`, onclick: () => toggleLike(ad.id) }, `<img src="https://uno5512.github.io/FrendsHub/2.png" alt="Лайк">`),
                            utils.createElement('span', { className: `action dislike ${isDisliked ? 'disliked' : ''}`, onclick: () => toggleDislike(ad.id) }, `<img src="https://uno5512.github.io/FrendsHub/1.png" alt="Дизлайк">`),
                            utils.createElement('span', { className: 'menu', onclick: () => toggleMenu(ad.id) }, '•••')
                        ]),
                    ]),
                    utils.createElement('div', { className: 'menu-options', id: `menu-${ad.id}` }, [
                        ...(ad.userId === userId ? [
                            utils.createElement('button', { onclick: () => editAd(ad.id) }, 'Редактировать'),
                            utils.createElement('button', { onclick: () => deleteAd(ad.id) }, 'Удалить')
                        ] : [
                            utils.createElement('button', { onclick: () => hideAd(ad.id) }, 'Не показывать'),
                            utils.createElement('button', { onclick: () => openComplaintDialog(complaintAdId) }, 'Пожаловаться') // Используем complaintAdId
                        ])
                    ])
                ]);

                adItem.addEventListener('click', (e) => {
                    if (!e.target.closest('h3') && !e.target.closest('.description')) {
                        hideAd(ad.id);
                    }
                });

                return adItem;
            },

            renderAdBatch: (filteredAds, adList, appState, adActions) => {
                const start = adList.children.length;
                const end = Math.min(start + lazyLoadBatchSize, filteredAds.length);
                const batch = filteredAds.slice(start, end);

                batch.forEach((ad, index) => {
                    const adElement = adRenderer.createAdElement(ad, appState.userId, appState.likesDislikes, appState.favorites, appState.participants,
                        adActions.toggleAdExpansion, adActions.openTelegramProfile, adActions.shareAd, adActions.toggleFavorite,
                        adActions.toggleLike, adActions.toggleDislike, adActions.toggleMenu, adActions.editAd, adActions.deleteAd, adActions.hideAd,
                        adActions.openComplaintDialog, adActions.joinAd);
                adList.appendChild(adElement);
            });

            if (end < filteredAds.length) {
                window.addEventListener('scroll', adRenderer.handleScroll);
            }
        },

        handleScroll: () => {
            const adList = document.getElementById('adList');
            const filteredAds = utils.filterAds(appState.ads, appState.filters, appState.userId, appState.hiddenAds);
            if (adList.children.length < filteredAds.length && window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
                window.removeEventListener('scroll', adRenderer.handleScroll);
                adRenderer.renderAdBatch(filteredAds, adList, appState, adActions);
            }
        },

        renderFavorites: () => {
            const favoritesList = document.getElementById('favoritesList');
            const favoritesSearch = document.getElementById('favoritesSearch').value.toLowerCase();
            favoritesList.innerHTML = '';

            const filteredFavorites = appState.favorites.filter(id => {
                const ad = appState.ads.find(ad => ad.id === id);
                return ad && ad.title.toLowerCase().includes(favoritesSearch);
            });

            if (filteredFavorites.length === 0) {
                favoritesList.innerHTML = '<p>Нет избранных объявлений</p>';
                return;
            }

            filteredFavorites.forEach(id => {
                const ad = appState.ads.find(ad => ad.id === id);
                if (ad) {
                    const favoriteItem = utils.createElement('div', { class: 'favorite-item' }, ad.title);
                    favoritesList.appendChild(favoriteItem);
                }
            });
        }
    };

    const adActions = {
        toggleAdExpansion: (adId) => {
            const adItem = document.querySelector(`.ad-item[data-id="${adId}"]`);
            if (adItem) {
                adItem.classList.toggle('expanded');
            }
        },

        openTelegramProfile: (userId) => {
            const user = appState.users.find(user => user.id === userId);
            if (user && user.telegram) {
                window.open(`https://t.me/${user.telegram}`, '_blank');
            }
        },

        shareAd: (adId) => {
            const ad = appState.ads.find(ad => ad.id === adId);
            if (ad) {
                const shareText = `Check out this ad: ${ad.title} - ${ad.description}`;
                navigator.share ? navigator.share({ title: ad.title, text: shareText, url: window.location.href }) : navigator.clipboard.writeText(shareText);
                showNotification('Ссылка скопирована', 2000);
            }
        },

        toggleFavorite: (adId) => {
            if (appState.favorites.includes(adId)) {
                appState.favorites = appState.favorites.filter(id => id !== adId);
            } else {
                appState.favorites.push(adId);
            }
            localStorage.setItem('favorites', JSON.stringify(appState.favorites));
            renderAds();
            adRenderer.renderFavorites();
        },

        toggleLike: (adId) => {
            const key = `like_${adId}`;
            if (appState.likesDislikes[key]) {
                delete appState.likesDislikes[key];
            } else {
                appState.likesDislikes[key] = true;
            }
            localStorage.setItem('likesDislikes', JSON.stringify(appState.likesDislikes));
            renderAds();
        },

        toggleDislike: (adId) => {
            const key = `dislike_${adId}`;
            if (appState.likesDislikes[key]) {
                delete appState.likesDislikes[key];
            } else {
                appState.likesDislikes[key] = true;
            }
            localStorage.setItem('likesDislikes', JSON.stringify(appState.likesDislikes));
            renderAds();
        },

        toggleMenu: (adId, event) => {
            event.stopPropagation();
            const menu = document.querySelector(`.ad-item[data-id="${adId}"] .menu-options`);
            if (menu) {
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            }
        },

        editAd: (adId) => {
            const ad = appState.ads.find(ad => ad.id === adId);
            if (ad) {
                document.getElementById('adTitle').value = ad.title;
                document.getElementById('adDescription').value = ad.description;
                document.getElementById('adCity').value = ad.city;
                document.getElementById('adType').value = ad.type;
                document.getElementById('adDate').value = ad.date;
                document.getElementById('adGender').value = ad.gender;
                document.getElementById('adAge').value = ad.age;

                complaintAdId = adId;
                document.getElementById('createDialog').showModal();
            }
        },

        deleteAd: async (adId) => {
            const adItem = document.querySelector(`.ad-item[data-id="${adId}"]`);
            if (adItem) {
                adItem.classList.add('removing');
                await new Promise(resolve => setTimeout(resolve, 500));
                adItem.remove();
            }

            appState.ads = appState.ads.filter(ad => ad.id !== adId);
            localStorage.setItem('ads', JSON.stringify(appState.ads));
            renderAds();
        },

        hideAd: (adId) => {
            appState.hiddenAds.push(adId);
            localStorage.setItem('hiddenAds', JSON.stringify(appState.hiddenAds));
            renderAds();
        },

        openComplaintDialog: (adId) => {
            complaintAdId = adId;
            document.getElementById('complaintDialog').showModal();
        },

        joinAd: (adId) => {
            if (!appState.participants[adId]) {
                appState.participants[adId] = [];
            }
            if (!appState.participants[adId].includes(appState.userId)) {
                appState.participants[adId].push(appState.userId);
                localStorage.setItem('participants', JSON.stringify(appState.participants));
                renderAds();
            }
        }
    };

    const utils = {
        createElement: (tag, attrs = {}, ...children) => {
            const el = document.createElement(tag);
            Object.keys(attrs).forEach(key => el.setAttribute(key, attrs[key]));
            children.forEach(child => {
                if (typeof child === 'string') {
                    el.appendChild(document.createTextNode(child));
                } else {
                    el.appendChild(child);
                }
            });
            return el;
        },

        filterAds: (ads, filters, userId, hiddenAds) => {
            return ads.filter(ad => {
                if (hiddenAds.includes(ad.id)) return false;
                if (filters.search && !ad.title.toLowerCase().includes(filters.search.toLowerCase())) return false;
                if (filters.city && ad.city !== filters.city) return false;
                if (filters.type && ad.type !== filters.type) return false;
                if (filters.date) {
                    const today = new Date();
                    const adDate = new Date(ad.createdAt);
                    if (filters.date === 'Сегодня' && adDate.toDateString() !== today.toDateString()) return false;
                    if (filters.date === 'Завтра' && adDate.toDateString() !== new Date(today.setDate(today.getDate() + 1)).toDateString()) return false;
                    if (filters.date === 'На неделе' && (adDate < today || adDate > new Date(today.setDate(today.getDate() + 7)))) return false;
                }
                if (filters.gender && ad.gender !== filters.gender && filters.gender !== 'Любой') return false;
                return true;
            }).sort((a, b) => {
                if (filters.sort === 'newest') return new Date(b.createdAt) - new Date(a.createdAt);
                if (filters.sort === 'oldest') return new Date(a.createdAt) - new Date(b.createdAt);
                return 0;
            });
        }
    };

    const appState = {
        ads: JSON.parse(localStorage.getItem('ads')) || [],
        users: JSON.parse(localStorage.getItem('users')) || [],
        userId: localStorage.getItem('userId') || 'user-' + Date.now(),
        filters: {
            search: '',
            city: '',
            type: '',
            date: '',
            gender: '',
            sort: 'rating'
        },
        likesDislikes: JSON.parse(localStorage.getItem('likesDislikes')) || {},
        favorites: JSON.parse(localStorage.getItem('favorites')) || [],
        hiddenAds: JSON.parse(localStorage.getItem('hiddenAds')) || [],
        participants: JSON.parse(localStorage.getItem('participants')) || {},
    };

    localStorage.setItem('userId', appState.userId);

    const loadCloudData = async () => {
        try {
            const response = await fetch('https://my-json-server.typicode.com/uno5512/FrendsHub/db');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            appState.ads = data.ads;
            appState.users = data.users;
            localStorage.setItem('ads', JSON.stringify(appState.ads));
            localStorage.setItem('users', JSON.stringify(appState.users));
        } catch (error) {
            console.error('Error fetching data:', error);
            showNotification('Ошибка при загрузке данных', 3000);
        }
    };

    const renderAds = () => {
        const adList = document.getElementById('adList');
        adList.innerHTML = '';
        const searchInput = document.getElementById('search').value;
        appState.filters.search = searchInput;

        const cityFilter = document.getElementById('city').value;
        appState.filters.city = cityFilter;

        const typeFilter = document.getElementById('type').value;
        appState.filters.type = typeFilter;

        const dateFilter = document.getElementById('date').value;
        appState.filters.date = dateFilter;

        const genderFilter = document.getElementById('gender').value;
        appState.filters.gender = genderFilter;

        const sortFilter = document.getElementById('sort').value;
        appState.filters.sort = sortFilter;

        const filteredAds = utils.filterAds(appState.ads, appState.filters, appState.userId, appState.hiddenAds);
        adRenderer.renderAdBatch(filteredAds, adList, appState, adActions);
    };

    const updateCounters = () => {
        const titleLength = document.getElementById('adTitle').value.length;
        const descriptionLength = document.getElementById('adDescription').value.length;
        document.getElementById('titleCounter').textContent = `${63 - titleLength}/63`;
        document.getElementById('descriptionCounter').textContent = `${500 - descriptionLength}/500`;
    };

    const openFilterDialog = (filterType) => {
        document.getElementById(`${filterType}Dialog`).showModal();

        const form = document.getElementById(`${filterType}-form`);
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            const selectedValue = document.querySelector(`input[name="${filterType}Option"]:checked`).value;
            document.getElementById(filterType).value = selectedValue;
            appState.filters[filterType] = selectedValue;
            renderAds();
            document.getElementById(`${filterType}Dialog`).close();
        });
    };

    const updateProfileAge = () => {
        const birthDay = document.getElementById('birthDay').value;
        const birthMonth = document.getElementById('birthMonth').value;
        const birthYear = document.getElementById('birthYear').value;

        if (birthDay && birthMonth && birthYear) {
            const birthDate = new Date(birthYear, birthMonth - 1, birthDay);
            const ageDiffMs = Date.now() - birthDate.getTime();
            const ageDate = new Date(ageDiffMs);
            const age = Math.abs(ageDate.getUTCFullYear() - 1970);

            document.getElementById('profileAge').textContent = `Возраст: ${age}`;
        }
    };

    const openFavoritesDialog = () => {
        document.getElementById('favoritesDialog').showModal();
        adRenderer.renderFavorites();
    };

    const showNotification = (message, duration) => {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
        }, duration);
    };

    const toggleSearchButtons = () => {
        const searchInput = document.getElementById('search').value.trim();
        const createButton = document.querySelector('button[data-modal-open="createDialog"]');

        if (searchInput) {
            createButton.classList.add('hidden');
        } else {
            createButton.classList.remove('hidden');
        }
    };

    const closeMenus = (event) => {
        if (!event.target.classList.contains('menu')) {
            document.querySelectorAll('.menu-options').forEach(menu => menu.style.display = 'none');
        }
    };

    const triggerVibration = () => {
        if ("vibrate" in navigator) {
            navigator.vibrate(50);
        }
    };

    async function init() {
        try {
            await loadCloudData();
            renderAds();

            document.getElementById('search').addEventListener('input', () => {
                renderAds();
                toggleSearchButtons();
            });

            document.getElementById('city').addEventListener('click', () => openFilterDialog('city'));
            document.getElementById('type').addEventListener('click', () => openFilterDialog('type'));
            document.getElementById('date').addEventListener('click', () => openFilterDialog('date'));
            document.getElementById('gender').addEventListener('click', () => openFilterDialog('gender'));
            document.getElementById('sort').addEventListener('change', renderAds);

            document.getElementById('adTitle').addEventListener('input', updateCounters);
            document.getElementById('adDescription').addEventListener('input', updateCounters);

            document.getElementById('favoritesSearch').addEventListener('input', adRenderer.renderFavorites);

            document.getElementById('birthDay').addEventListener('input', updateProfileAge);
            document.getElementById('birthMonth').addEventListener('input', updateProfileAge);
            document.getElementById('birthYear').addEventListener('input', updateProfileAge);

            document.addEventListener('click', closeMenus);
            document.addEventListener('click', triggerVibration);

        } catch (error) {
            console.error("Initialization failed:", error);
            showNotification("Приложение не запустилось", 5000);
        }
    }

    init();
</script>
</body>

</html>
