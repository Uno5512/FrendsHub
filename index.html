<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FriendsHub</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rubik', sans-serif;
            background: #eedfc8;
            color: #1A2A44;
            padding: 16px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 600px;
            width: 100%;
        }

        .image-container {
            display: flex;
            justify-content: center;
            margin-top: 16px;
            margin-bottom: 10px;
        }

        .header-image {
            width: 100px;
            height: 100px;
            object-fit: contain;
        }

        .search-filter-container {
            background: #f1d299;
            border: 2px solid #f6e1bc;
            border-radius: 22px;
            padding: 8px;
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: sticky;
            top: 16px;
            z-index: 100;
        }

        .refresh-loader {
            display: none;
            text-align: center;
            padding: 12px;
            background: #f1d299;
            border-radius: 22px;
        }

        .refresh-loader.active {
            display: block;
        }

        .refresh-loader .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #987eeb;
            border-radius: 50%;
            margin: 0 4px;
            animation: bounce 0.6s infinite alternate;
        }

        .refresh-loader .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .refresh-loader .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            to {
                transform: translateY(-6px);
            }
        }

        .search-filter-container input {
            padding: 8px;
            font-size: 22px;
            border-radius: 8px;
            background: #f1d299;
            border: none;
            width: 100%;
        }

        .search-filter-container input:focus {
            outline: none;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin-top: 4px;
        }

        .filters select {
            padding: 4px;
            font-size: 18px;
            background: #f1d299;
            border: 1px solid #f6e1bc;
            border-radius: 22px;
            cursor: pointer;
            flex: 1;
            min-width: 60px;
        }

        .filters select:focus {
            outline: none;
        }

        button[data-modal-open="createDialog"] {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            width: 160px;
            height: 80px;
            background: #987eeb;
            opacity: 0.5;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: #fff;
            border: none;
            border-radius: 24px;
            font-size: 16px;
            cursor: pointer;
            z-index: 1002;
            transition: bottom 0.3s ease;
            bottom: 0;
        }

        button[data-modal-open="createDialog"].hidden {
            bottom: -60px;
        }

        dialog {
            border: none;
            border-radius: 8px;
            background: #fff;
            padding: 16px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1003;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
        }

        dialog form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        dialog h2 {
            font-size: 18px;
            margin-bottom: 16px;
        }

        dialog select,
        dialog input,
        dialog textarea {
            padding: 8px;
            font-size: 16px;
            background: #f1d299;
            border: none;
            border-radius: 8px;
        }

        dialog select:focus,
        dialog input:focus,
        dialog textarea:focus {
            outline: none;
        }

        dialog textarea {
            min-height: 100px;
            resize: vertical;
        }

        dialog button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
        }

        dialog button[type="button"] {
            background: #E5E7EB;
            color: #1A2A44;
            border: none;
        }

        dialog button[type="submit"],
        dialog button.close-btn {
            background: #987eeb;
            color: #fff;
            border: none;
        }

        .select-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .select-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #F5F5F5;
            border-radius: 8px;
            cursor: pointer;
        }

        .counter {
            font-size: 12px;
            color: #555;
            margin-top: 4px;
        }

        .ad-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 80px;
            scroll-behavior: smooth;
            position: relative;
        }

        .ad-item {
            background: #efefef;
            padding: 16px;
            padding-bottom: 14px;
            border-radius: 22px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: transform 0.5s ease, opacity 0.5s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100%;
        }

        .ad-item.removing {
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }

        .ad-item.own {
            border: 1px solid #ff6200;
        }

        .ad-item.expanded .ad-content {
            max-height: 1000px;
            opacity: 1;
        }

        .ad-item h3 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #41494e;
            hyphens: auto;
            word-wrap: break-word;
            white-space: normal;
            max-width: 100%;
            cursor: pointer;
        }

        .ad-item p.description {
            font-size: 18px;
            line-height: 1.5;
            color: #555;
            hyphens: auto;
            word-wrap: break-word;
            white-space: normal;
            cursor: pointer;
        }

        .ad-item p.tags {
            font-size: 12px;
            color: #555;
        }

        .ad-content {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.7s ease-in-out, opacity 0.7s ease-in-out;
            margin-bottom: 16px;
        }

        .creator-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            margin: 8px 0 4px 0;
        }

        .ad-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
        }

        .join-btn {
            width: 48px;
            height: 48px;
            background: #987eeb;
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: width 0.3s ease;
        }

        .join-btn .participant-count {
            font-size: 12px;
            color: #fff;
            position: relative;
            z-index: 10;
        }

        .join-btn .participant-avatars {
            display: flex;
            flex-direction: row;
            position: absolute;
            right: 8px;
            height: 24px;
            align-items: center;
        }

        .join-btn .participant-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #f6e1bc;
        }

        .ad-item .user {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: auto;
            gap: 12px;
        }

        .ad-item .user .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ad-item .user .name {
            font-size: 16px;
            font-weight: 500;
            color: #007bff;
            cursor: pointer;
        }

        .ad-item .user .age {
            font-size: 14px;
            color: #555;
        }

        .ad-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ad-actions .action {
            cursor: pointer;
            position: relative;
        }

        .ad-actions .action img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .ad-actions .liked::after,
        .ad-actions .disliked::after {
            content: '';
            position: absolute;
            top: calc(50% - 2px);
            left: 50%;
            transform: translate(-50%, -50%);
            width: 32px;
            height: 32px;
            background: #987eeb;
            border-radius: 50%;
            z-index: -1;
        }

        .ad-actions .action.share,
        .ad-actions .action.favorite,
        .ad-actions .action.like,
        .ad-actions .action.dislike {
            position: relative;
            top: 4px;
        }

        .menu {
            cursor: pointer;
            font-size: 20px;
        }

        .menu-options {
            display: none;
            position: absolute;
            top: 40px;
            right: 12px;
            background: #fff;
            border: 1px solid #E6E6E6;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .menu-options button {
            display: block;
            width: 100%;
            padding: 8px 16px;
            border: none;
            background: none;
            color: #000;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
        }

        .menu-options button:hover {
            background: #f1d299;
        }

        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #987eeb;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .floating-btn.hidden {
            display: none;
        }

        .floating-btn::before {
            content: '←';
            font-size: 24px;
        }

        .profile {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 8px;
            background: #f1d299;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }

        .profile img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile .info {
            display: flex;
            flex-direction: column;
        }

        .profile .info .name {
            font-size: 16px;
            font-weight: 500;
        }

        .profile .info .age {
            font-size: 14px;
            color: #555;
        }

        .age-picker {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .age-picker input {
            width: 60px;
            padding: 4px;
            font-size: 16px;
            text-align: center;
            background: #f1d299;
            border: none;
            border-radius: 8px;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        .age-picker input::-webkit-inner-spin-button,
        .age-picker input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .favorites-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .favorites-list .favorite-item {
            background: #f1d299;
            padding: 8px;
            border-radius: 8px;
            font-size: 14px;
        }

        .reset-btn {
            background: #987eeb;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background: #987eeb;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 1004;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <main>
        <section class="filters">
            <input type="search" id="searchFilter" placeholder="Поиск...">
            <select id="cityFilter">
                <option value="">Город</option>
                <option value="Москва">Москва</option>
                <option value="Санкт-Петербург">Санкт-Петербург</option>
                <option value="Казань">Казань</option>
            </select>
            <select id="typeFilter">
                <option value="">Вид</option>
                <option value="Встреча">Встреча</option>
                <option value="Чат">Чат</option>
                <option value="Событие">Событие</option>
            </select>
            <select id="dateFilter">
                <option value="">Дата</option>
                <option value="Сегодня">Сегодня</option>
                <option value="Завтра">Завтра</option>
                <option value="На неделе">На неделе</option>
            </select>
            <select id="genderFilter">
                <option value="">Пол</option>
                <option value="Мужской">Мужской</option>
                <option value="Женский">Женский</option>
                <option value="Любой">Любой</option>
            </select>
            <select id="sort">
                <option value="">По рейтингу</option>
                <option value="new">Новые</option>
                <option value="old">Старые</option>
            </select>
        </section>

        <section id="adList"></section>

        <button id="createAdBtn">+ Создать</button>

        <dialog id="createAdDialog">
            <h2>Создать объявление</h2>
            <form id="createAdForm">
                <textarea id="title" maxlength="63" placeholder="63/63"></textarea>
                <textarea id="description" maxlength="500" placeholder="500/500"></textarea>
                <select id="city">
                    <option value="Москва">Москва</option>
                    <option value="Санкт-Петербург">Санкт-Петербург</option>
                    <option value="Казань">Казань</option>
                </select>
                <select id="type">
                    <option value="Встреча">Встреча</option>
                    <option value="Чат">Чат</option>
                    <option value="Событие">Событие</option>
                </select>
                <select id="date">
                    <option value="Сегодня">Сегодня</option>
                    <option value="Завтра">Завтра</option>
                    <option value="На неделе">На неделе</option>
                </select>
                <select id="gender">
                    <option value="Мужской">Мужской</option>
                    <option value="Женский">Женский</option>
                    <option value="Любой">Любой</option>
                </select>
                <input type="number" id="age" placeholder="Возраст" min="1" max="100">
                <button type="button" onclick="closeDialog('createAdDialog')">Закрыть</button>
                <button type="submit">Опубликовать</button>
            </form>
        </dialog>

        <dialog id="complaintDialog">
            <h2>Пожаловаться</h2>
            <form id="complaintForm">
                <textarea placeholder="Причина жалобы"></textarea>
                <button type="button" onclick="closeDialog('complaintDialog')">Отменить</button>
                <button type="submit">Отправить</button>
            </form>
        </dialog>

        <dialog id="cityFilterDialog">
            <h2>Выберите город</h2>
            <div>
                <button onclick="applyFilter('cityFilter', 'Москва')">Москва</button>
                <button onclick="applyFilter('cityFilter', 'Санкт-Петербург')">Санкт-Петербург</button>
                <button onclick="applyFilter('cityFilter', 'Казань')">Казань</button>
            </div>
            <button onclick="closeDialog('cityFilterDialog')">Отменить</button>
            <button onclick="closeDialog('cityFilterDialog')">Применить</button>
        </dialog>

        <dialog id="typeFilterDialog">
            <h2>Выберите вид</h2>
            <div>
                <button onclick="applyFilter('typeFilter', 'Встреча')">Встреча</button>
                <button onclick="applyFilter('typeFilter', 'Чат')">Чат</button>
                <button onclick="applyFilter('typeFilter', 'Событие')">Событие</button>
            </div>
            <button onclick="closeDialog('typeFilterDialog')">Отменить</button>
            <button onclick="closeDialog('typeFilterDialog')">Применить</button>
        </dialog>

        <dialog id="dateFilterDialog">
            <h2>Выберите дату</h2>
            <div>
                <button onclick="applyFilter('dateFilter', 'Сегодня')">Сегодня</button>
                <button onclick="applyFilter('dateFilter', 'Завтра')">Завтра</button>
                <button onclick="applyFilter('dateFilter', 'На неделе')">На неделе</button>
            </div>
            <button onclick="closeDialog('dateFilterDialog')">Отменить</button>
            <button onclick="closeDialog('dateFilterDialog')">Применить</button>
        </dialog>

        <dialog id="genderFilterDialog">
            <h2>Выберите пол</h2>
            <div>
                <button onclick="applyFilter('genderFilter', 'Мужской')">Мужской</button>
                <button onclick="applyFilter('genderFilter', 'Женский')">Женский</button>
                <button onclick="applyFilter('genderFilter', 'Любой')">Любой</button>
            </div>
            <button onclick="closeDialog('genderFilterDialog')">Отменить</button>
            <button onclick="closeDialog('genderFilterDialog')">Применить</button>
        </dialog>

        <dialog id="favoritesDialog">
            <h2>Избранное</h2>
            <section id="favoritesList"></section>
            <button onclick="resetFavorites()">Сбросить</button>
            <button onclick="closeDialog('favoritesDialog')">Закрыть</button>
        </dialog>

        <div id="notification" class="notification"></div>
    </main>

    <script>
        // Централизованное состояние
        const state = {
            ads: [],
            hiddenAds: JSON.parse(localStorage.getItem('hiddenAds') || '[]'),
            favorites: JSON.parse(localStorage.getItem('favorites') || '[]'),
            likesDislikes: JSON.parse(localStorage.getItem('likesDislikes') || '{}'),
            participants: JSON.parse(localStorage.getItem('participants') || '{}'),
            userId: 'user-1',
            userName: 'Пользователь'
        };

        // Утилитные функции
        function createElement(tag, attributes = {}, children = []) {
            try {
                const element = document.createElement(tag);
                Object.assign(element, attributes);
                if (Array.isArray(children)) {
                    children.forEach(child => {
                        if (typeof child === 'string') {
                            element.appendChild(document.createTextNode(child));
                        } else if (child) {
                            element.appendChild(child);
                        }
                    });
                } else if (children) {
                    element.appendChild(typeof children === 'string' ? document.createTextNode(children) : children);
                }
                return element;
            } catch (error) {
                console.error(`Ошибка создания элемента ${tag}:`, error);
                return document.createElement('div');
            }
        }

        function showNotification(message) {
            try {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 2000);
            } catch (error) {
                console.error('Ошибка отображения уведомления:', error);
            }
        }

        function openDialog(dialogId) {
            try {
                document.getElementById(dialogId).showModal();
            } catch (error) {
                console.error(`Ошибка открытия диалога ${dialogId}:`, error);
                showNotification('Не удалось открыть диалог');
            }
        }

        function closeDialog(dialogId) {
            try {
                document.getElementById(dialogId).close();
            } catch (error) {
                console.error(`Ошибка закрытия диалога ${dialogId}:`, error);
                showNotification('Не удалось закрыть диалог');
            }
        }

        function applyFilter(filterId, value) {
            try {
                document.getElementById(filterId).value = value;
                renderAds();
                closeDialog(`${filterId}Dialog`);
            } catch (error) {
                console.error(`Ошибка применения фильтра ${filterId}:`, error);
                showNotification('Ошибка при применении фильтра');
            }
        }

        // Модуль рендеринга объявлений
        const adRenderer = {
            createAdElement: (ad) => {
                try {
                    const isLiked = state.likesDislikes[ad.id]?.likes?.includes(state.userId) || false;
                    const isDisliked = state.likesDislikes[ad.id]?.dislikes?.includes(state.userId) || false;
                    const isFavorited = state.favorites.includes(ad.id);
                    const rating = (state.likesDislikes[ad.id]?.likes?.length || 0) - (state.likesDislikes[ad.id]?.dislikes?.length || 0);
                    const participantCount = state.participants[ad.id]?.length || 0;

                    let participantAvatarsHtml = '';
                    state.participants[ad.id]?.forEach((pUserId, pIndex) => {
                        const pAvatarSrc = pUserId === state.userId
                            ? 'https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/51174a180992325.6514258f750ff.jpg'
                            : 'https://mir-s3-cdn-cf.behance.net/project_modules/fs/90e60f125956251.6123f46744b17.jpg';
                        participantAvatarsHtml += `<img class="participant-avatar" src="${pAvatarSrc}" alt="Аватар участника ${pUserId}" style="z-index: ${pIndex}; transform: translateX(${pIndex * -8}px);">`;
                    });

                    return createElement('article', {
                        className: `ad-item ${ad.userId === state.userId ? 'own' : ''}`,
                        'data-ad-id': ad.id,
                        'aria-label': `Объявление от ${ad.userName || 'Аноним'}`,
                        style: 'opacity: 0; transform: translateY(50px);'
                    }, [
                        createElement('h3', { onclick: () => toggleAdExpansion(ad.id) }, ad.title),
                        createElement('div', { className: 'ad-content' }, [
                            createElement('p', { className: 'description' }, ad.description),
                            createElement('p', { className: 'tags' }, `<small>Город: ${ad.city} | Вид: ${ad.type} | Дата: ${ad.date} | Пол: ${ad.gender} | ${new Date(ad.createdAt).toLocaleDateString()}</small>`),
                            createElement('div', { className: 'creator-container' }, [
                                createElement('img', {
                                    className: 'ad-avatar',
                                    src: ad.userId === state.userId
                                        ? 'https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/51174a180992325.6514258f750ff.jpg'
                                        : 'https://mir-s3-cdn-cf.behance.net/project_modules/fs/90e60f125956251.6123f46744b17.jpg',
                                    alt: `Аватар ${ad.userName || 'Аноним'}`,
                                    onclick: () => openTelegramProfile(ad.userId)
                                }),
                                createElement('div', {
                                    className: 'join-btn',
                                    onclick: () => joinEvent(ad.id),
                                    style: `width: calc(48px + ${participantCount * 24}px)`
                                }, [
                                    createElement('span', { className: 'participant-count' }, participantCount.toString()),
                                    createElement('div', { className: 'participant-avatars', innerHTML: participantAvatarsHtml })
                                ])
                            ])
                        ]),
                        createElement('div', { className: 'user' }, [
                            createElement('div', { className: 'user-info' }, [
                                createElement('span', { className: 'name', onclick: () => openTelegramProfile(ad.userId) }, ad.userName || 'Аноним'),
                                createElement('span', { className: 'age' }, ad.age || 'Не указан')
                            ]),
                            createElement('div', { className: 'ad-actions' }, [
                                createElement('span', { className: 'counter' }, rating.toString()),
                                createElement('span', {
                                    className: 'action share',
                                    onclick: () => shareAd(ad.id)
                                }, `<img src="https://uno5512.github.io/FrendsHub/5.png" alt="Поделиться">`),
                                createElement('span', {
                                    className: `action favorite ${isFavorited ? 'favorited' : ''}`,
                                    onclick: () => toggleFavorite(ad.id)
                                }, `<img src="https://uno5512.github.io/FrendsHub/4.png" alt="Избранное">`),
                                createElement('span', {
                                    className: `action like ${isLiked ? 'liked' : ''}`,
                                    onclick: () => toggleLike(ad.id)
                                }, `<img src="https://uno5512.github.io/FrendsHub/2.png" alt="Лайк">`),
                                createElement('span', {
                                    className: `action dislike ${isDisliked ? 'disliked' : ''}`,
                                    onclick: () => toggleDislike(ad.id)
                                }, `<img src="https://uno5512.github.io/FrendsHub/1.png" alt="Дизлайк">`),
                                createElement('span', {
                                    className: 'menu',
                                    onclick: () => toggleMenu(ad.id)
                                }, '•••')
                            ])
                        ]),
                        createElement('div', { className: 'menu-options', id: `menu-${ad.id}` }, [
                            ...(ad.userId === state.userId ? [
                                createElement('button', { onclick: () => editAd(ad.id) }, 'Редактировать'),
                                createElement('button', { onclick: () => deleteAd(ad.id) }, 'Удалить')
                            ] : [
                                createElement('button', { onclick: () => hideAd(ad.id) }, 'Не показывать'),
                                createElement('button', { onclick: () => openComplaintDialog(ad.id) }, 'Пожаловаться')
                            ])
                        ])
                    ]);
                } catch (error) {
                    console.error(`Ошибка рендеринга объявления ${ad.id}:`, error);
                    showNotification('Ошибка при отображении объявления');
                    return createElement('div', {}, 'Ошибка отображения');
                }
            },

            renderAdBatch: (filteredAds, adList) => {
                try {
                    adList.innerHTML = '';
                    filteredAds.forEach((ad, index) => {
                        const adElement = adRenderer.createAdElement(ad);
                        adList.appendChild(adElement);
                        setTimeout(() => {
                            adElement.style.opacity = '1';
                            adElement.style.transform = 'translateY(0)';
                        }, index * 100);
                    });
                } catch (error) {
                    console.error('Ошибка рендеринга списка объявлений:', error);
                    showNotification('Не удалось отобразить объявления');
                }
            },

            updateAdActions: (adId) => {
                try {
                    const adItem = document.querySelector(`.ad-item[data-ad-id="${adId}"]`);
                    if (!adItem) return;

                    const isLiked = state.likesDislikes[adId]?.likes?.includes(state.userId) || false;
                    const isDisliked = state.likesDislikes[adId]?.dislikes?.includes(state.userId) || false;
                    const isFavorited = state.favorites.includes(adId);
                    const rating = (state.likesDislikes[adId]?.likes?.length || 0) - (state.likesDislikes[adId]?.dislikes?.length || 0);

                    const likeButton = adItem.querySelector('.action.like');
                    const dislikeButton = adItem.querySelector('.action.dislike');
                    const favoriteButton = adItem.querySelector('.action.favorite');
                    const counter = adItem.querySelector('.counter');

                    likeButton.classList.toggle('liked', isLiked);
                    dislikeButton.classList.toggle('disliked', isDisliked);
                    favoriteButton.classList.toggle('favorited', isFavorited);
                    counter.textContent = rating.toString();
                } catch (error) {
                    console.error(`Ошибка обновления действий для объявления ${adId}:`, error);
                    showNotification('Ошибка при обновлении действий');
                }
            }
        };

        // Загрузка данных
        async function loadCloudData() {
            try {
                const [ads, likesDislikes] = await Promise.all([
                    Promise.resolve([]), // Заменить на реальный запрос
                    Promise.resolve({})
                ]);
                state.ads = ads;
                state.likesDislikes = likesDislikes;
                localStorage.setItem('ads', JSON.stringify(ads));
                localStorage.setItem('likesDislikes', JSON.stringify(likesDislikes));
                renderAds();
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                showNotification('Не удалось загрузить данные. Используются локальные данные.');
                state.ads = JSON.parse(localStorage.getItem('ads') || '[]');
                state.likesDislikes = JSON.parse(localStorage.getItem('likesDislikes') || '{}');
                renderAds();
            }
        }

        // Рендеринг объявлений
	function renderAds() {
	    const container = document.querySelector('.favorites-list');
	    const existingAds = new Map([...container.children].map(el => [el.dataset.id, el]));
	    const filteredAds = applyFilters(ads); // Предполагаемая функция фильтрации
	
	    // Удаляем отсутствующие объявления
	    existingAds.forEach((el, id) => {
	        if (!filteredAds.some(ad => ad.id === id)) {
	            el.remove();
	        }
	    });
	
	    // Добавляем или обновляем объявления
	    filteredAds.forEach(ad => {
	        let el = existingAds.get(ad.id);
	        if (!el) {
	            el = document.createElement('div');
	            el.dataset.id = ad.id;
	            el.className = 'ad';
	            container.appendChild(el);
	        }
	        el.innerHTML = `${ad.name}, ${ad.age} <button class="favorite-btn" data-id="${ad.id}">★</button>`;
	    });
	}

        // Фильтрация
        function filterAds(ads) {
            try {
                const search = document.getElementById('searchFilter').value.toLowerCase();
                const city = document.getElementById('cityFilter').value;
                const type = document.getElementById('typeFilter').value;
                const date = document.getElementById('dateFilter').value;
                const gender = document.getElementById('genderFilter').value;
                const sort = document.getElementById('sort').value;

                let filtered = ads.filter(ad => 
                    (!search || ad.title.toLowerCase().includes(search) || ad.description.toLowerCase().includes(search)) &&
                    (!city || ad.city === city) &&
                    (!type || ad.type === type) &&
                    (!date || ad.date === date) &&
                    (!gender || ad.gender === gender)
                );

                if (sort === 'new') {
                    filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                } else if (sort === 'old') {
                    filtered.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                } else if (sort === '') {
                    filtered.sort((a, b) => {
                        const ratingA = (state.likesDislikes[a.id]?.likes?.length || 0) - (state.likesDislikes[a.id]?.dislikes?.length || 0);
                        const ratingB = (state.likesDislikes[b.id]?.likes?.length || 0) - (state.likesDislikes[b.id]?.dislikes?.length || 0);
                        return ratingB - ratingA;
                    });
                }

                return filtered;
            } catch (error) {
                console.error('Ошибка фильтрации:', error);
                showNotification('Ошибка при фильтрации объявлений');
                return ads;
            }
        }

	let ads = [
	    { id: '1', name: 'TONI', age: 15, city: 'Москва', type: 'Встреча' },
	    // Другие объявления
	];
	let favorites = [];
	
	function toggleFavorite(adId) {
	    // Иммутабельное обновление
	    favorites = favorites.includes(adId)
	        ? favorites.filter(id => id !== adId)
	        : [...favorites, adId];
	    console.log('Favorites updated:', favorites);
	    renderAds();
	}
	
	function applyFilters(ads) {
	    // Пример фильтрации (добавьте реальную логику)
	    return ads.filter(ad => favorites.includes(ad.id) || ad.city === 'Москва');
	}

        // Обработчики действий
        function toggleAdExpansion(adId) {
            try {
                const adItem = document.querySelector(`.ad-item[data-ad-id="${adId}"]`);
                const content = adItem.querySelector('.ad-content');
                content.classList.toggle('expanded');
            } catch (error) {
                console.error(`Ошибка развертывания ${adId}:`, error);
                showNotification('Ошибка при развертывании объявления');
            }
        }

        function openTelegramProfile(userId) {
            try {
                console.log(`Открыть профиль ${userId}`); // Реализовать переход в Telegram
            } catch (error) {
                console.error(`Ошибка открытия профиля ${userId}:`, error);
                showNotification('Ошибка при открытии профиля');
            }
        }

	function toggleFavorite(adId) {
	    console.log('Before:', ads, favorites);
	    favorites = favorites.includes(adId) ? favorites.filter(id => id !== adId) : [...favorites, adId];
	    console.log('After:', ads, favorites);
	    renderAds();
	}

        function shareAd(adId) {
            try {
                console.log(`Поделиться объявлением ${adId}`); // Реализовать шаринг
                showNotification('Ссылка скопирована');
            } catch (error) {
                console.error(`Ошибка шаринга ${adId}:`, error);
                showNotification('Ошибка при шаринге');
            }
        }

        function toggleFavorite(adId) {
            try {
                const index = state.favorites.indexOf(adId);
                if (index === -1) {
                    state.favorites.push(adId);
                } else {
                    state.favorites.splice(index, 1);
                }

                localStorage.setItem('favorites', JSON.stringify(state.favorites));
                adRenderer.updateAdActions(adId);
                renderFavorites();
            } catch (error) {
                console.error(`Ошибка избранного ${adId}:`, error);
                showNotification('Ошибка при добавлении в избранное');
            }
        }

        function toggleLike(adId) {
            try {
                state.likesDislikes[adId] = state.likesDislikes[adId] || { likes: [], dislikes: [] };
                const likes = state.likesDislikes[adId].likes;
                if (likes.includes(state.userId)) {
                    likes.splice(likes.indexOf(state.userId), 1);
                } else {
                    likes.push(state.userId);
                    state.likesDislikes[adId].dislikes = state.likesDislikes[adId].dislikes.filter(id => id !== state.userId);
                }
                localStorage.setItem('likesDislikes', JSON.stringify(state.likesDislikes));
                adRenderer.updateAdActions(adId);
                if (document.getElementById('sort').value === '') {
                    renderAds();
                }
            } catch (error) {
                console.error(`Ошибка лайка ${adId}:`, error);
                showNotification('Ошибка при установке лайка');
            }
        }

        function toggleDislike(adId) {
            try {
                state.likesDislikes[adId] = state.likesDislikes[adId] || { likes: [], dislikes: [] };
                const dislikes = state.likesDislikes[adId].dislikes;
                if (dislikes.includes(state.userId)) {
                    dislikes.splice(dislikes.indexOf(state.userId), 1);
                } else {
                    dislikes.push(state.userId);
                    state.likesDislikes[adId].likes = state.likesDislikes[adId].likes.filter(id => id !== state.userId);
                }
                localStorage.setItem('likesDislikes', JSON.stringify(state.likesDislikes));
                adRenderer.updateAdActions(adId);
                if (document.getElementById('sort').value === '') {
                    renderAds();
                }
            } catch (error) {
                console.error(`Ошибка дизлайка ${adId}:`, error);
                showNotification('Ошибка при установке дизлайка');
            }
        }

        function toggleMenu(adId) {
            try {
                const menu = document.getElementById(`menu-${adId}`);
                menu.classList.toggle('show');
            } catch (error) {
                console.error(`Ошибка меню ${adId}:`, error);
                showNotification('Ошибка при открытии меню');
            }
        }

        function editAd(adId) {
            try {
                const ad = state.ads.find(ad => ad.id === adId);
                if (!ad) return;
                openDialog('createAdDialog');
                document.getElementById('title').value = ad.title;
                document.getElementById('description').value = ad.description;
                document.getElementById('city').value = ad.city;
                document.getElementById('type').value = ad.type;
                document.getElementById('date').value = ad.date;
                document.getElementById('gender').value = ad.gender;
                document.getElementById('age').value = ad.age || '';
                const form = document.getElementById('createAdForm');
                form.onsubmit = (e) => updateAd(e, adId);
            } catch (error) {
                console.error(`Ошибка редактирования ${adId}:`, error);
                showNotification('Ошибка при редактировании');
            }
        }

        function updateAd(e, adId) {
            try {
                e.preventDefault();
                const adIndex = state.ads.findIndex(ad => ad.id === adId);
                if (adIndex === -1) return;
                state.ads[adIndex] = {
                    ...state.ads[adIndex],
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    city: document.getElementById('city').value,
                    type: document.getElementById('type').value,
                    date: document.getElementById('date').value,
                    gender: document.getElementById('gender').value,
                    age: document.getElementById('age').value,
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('ads', JSON.stringify(state.ads));
                closeDialog('createAdDialog');
                renderAds();
                document.getElementById('createAdForm').onsubmit = createAd;
            } catch (error) {
                console.error(`Ошибка обновления ${adId}:`, error);
                showNotification('Ошибка при сохранении изменений');
            }
        }

        function deleteAd(adId) {
            try {
                state.ads = state.ads.filter(ad => ad.id !== adId);
                state.favorites = state.favorites.filter(id => id !== adId);
                delete state.likesDislikes[adId];
                delete state.participants[adId];
                localStorage.setItem('ads', JSON.stringify(state.ads));
                localStorage.setItem('favorites', JSON.stringify(state.favorites));
                localStorage.setItem('likesDislikes', JSON.stringify(state.likesDislikes));
                localStorage.setItem('participants', JSON.stringify(state.participants));
                renderAds();
                renderFavorites();
            } catch (error) {
                console.error(`Ошибка удаления ${adId}:`, error);
                showNotification('Ошибка при удалении');
            }
        }

        function hideAd(adId) {
            try {
                if (!state.hiddenAds.includes(adId)) {
                    state.hiddenAds.push(adId);
                    localStorage.setItem('hiddenAds', JSON.stringify(state.hiddenAds));
                    renderAds();
                }
            } catch (error) {
                console.error(`Ошибка скрытия ${adId}:`, error);
                showNotification('Ошибка при скрытии объявления');
            }
        }

        function openComplaintDialog(adId) {
            try {
                openDialog('complaintDialog');
                document.getElementById('complaintForm').onsubmit = (e) => submitComplaint(e, adId);
            } catch (error) {
                console.error(`Ошибка открытия жалобы ${adId}:`, error);
                showNotification('Ошибка при открытии формы жалобы');
            }
        }

        function submitComplaint(e, adId) {
            try {
                e.preventDefault();
                const reason = document.getElementById('complaintForm').querySelector('textarea').value;
                console.log(`Жалоба на ${adId}: ${reason}`);
                showNotification('Жалоба отправлена');
                closeDialog('complaintDialog');
            } catch (error) {
                console.error(`Ошибка отправки жалобы ${adId}:`, error);
                showNotification('Ошибка при отправке жалобы');
            }
        }

        function joinEvent(adId) {
            try {
                state.participants[adId] = state.participants[adId] || [];
                if (!state.participants[adId].includes(state.userId)) {
                    state.participants[adId].push(state.userId);
                    localStorage.setItem('participants', JSON.stringify(state.participants));
                    renderAds();
                }
            } catch (error) {
                console.error(`Ошибка участия ${adId}:`, error);
                showNotification('Ошибка при присоединении к событию');
            }
        }

        function resetFavorites() {
            try {
                state.favorites = [];
                localStorage.setItem('favorites', JSON.stringify(state.favorites));
                renderFavorites();
                renderAds();
            } catch (error) {
                console.error('Ошибка сброса избранного:', error);
                showNotification('Ошибка при сбросе избранного');
            }
        }

        function renderFavorites() {
            try {
                const favoritesList = document.getElementById('favoritesList');
                favoritesList.innerHTML = '';
                state.favorites.forEach(adId => {
                    const ad = state.ads.find(ad => ad.id === adId);
                    if (!ad) return;
                    const isLiked = state.likesDislikes[ad.id]?.likes?.includes(state.userId) || false;
                    const adElement = createElement('article', { className: 'ad-item' }, [
                        createElement('h3', {}, ad.userName || 'Аноним'),
                        createElement('p', {}, ad.age ? `${ad.age} лет` : 'Возраст не указан'),
                        createElement('div', { className: 'ad-actions' }, [
                            createElement('span', {
                                className: 'action share',
                                onclick: () => shareAd(ad.id)
                            }, `<img src="https://uno5512.github.io/FrendsHub/5.png" alt="Поделиться">`),
                            createElement('span', {
                                className: `action favorite favorited`,
                                onclick: () => toggleFavorite(ad.id)
                            }, `<img src="https://uno5512.github.io/FrendsHub/4.png" alt="Избранное">`),
                            createElement('span', {
                                className: `action like ${isLiked ? 'liked' : ''}`,
                                onclick: () => toggleLike(ad.id)
                            }, `<img src="https://uno5512.github.io/FrendsHub/2.png" alt="Лайк">`)
                        ])
                    ]);
                    favoritesList.appendChild(adElement);
                });
            } catch (error) {
                console.error('Ошибка рендеринга избранного:', error);
                showNotification('Ошибка при отображении избранного');
            }
        }

        // Создание объявления
        function createAd(e) {
            try {
                e.preventDefault();
                const newAd = {
                    id: Date.now().toString(),
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    city: document.getElementById('city').value,
                    type: document.getElementById('type').value,
                    date: document.getElementById('date').value,
                    gender: document.getElementById('gender').value,
                    age: document.getElementById('age').value,
                    userId: state.userId,
                    userName: state.userName,
                    createdAt: new Date().toISOString()
                };
                state.ads.push(newAd);
                localStorage.setItem('ads', JSON.stringify(state.ads));
                closeDialog('createAdDialog');
                renderAds();
            } catch (error) {
                console.error('Ошибка создания объявления:', error);
                showNotification('Ошибка при создании объявления');
            }
        }

        // Обработчики событий
        document.getElementById('createAdBtn').addEventListener('click', () => openDialog('createAdDialog'));
        document.getElementById('createAdForm').addEventListener('submit', createAd);
        document.getElementById('searchFilter').addEventListener('input', renderAds);
        document.getElementById('cityFilter').addEventListener('change', renderAds);
        document.getElementById('typeFilter').addEventListener('change', renderAds);
        document.getElementById('dateFilter').addEventListener('change', renderAds);
        document.getElementById('genderFilter').addEventListener('change', renderAds);
        document.getElementById('sort').addEventListener('change', renderAds);

        // Инициализация
        loadCloudData();
    </script>
</body>
</html>
