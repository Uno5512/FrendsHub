<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fibonacci Poetry</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/react@18.3.1/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.3.1/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.26.9/babel.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="data:application/manifest+json,{}">
  <style>
    body {
      font-family: 'Rubik', sans-serif;
    }
    .modal-backdrop {
      backdrop-filter: blur(5px);
      background-color: rgba(0, 0, 0, 0.5);
    }
    .announcement-expanded, .profile-expanded {
      transition: max-height 0.3s ease-in-out;
    }
    .like-dislike-img {
      width: 24px;
      height: 24px;
    }
    .announcement-title, .profile-about {
      word-break: break-word;
      hyphens: auto;
    }
    .announcement-description, .profile-description {
      word-break: break-word;
      hyphens: auto;
    }
    .accordion-content {
      transition: max-height 0.3s ease-in-out;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <template id="city-options">
    <option value="">Любой город</option>
    <option value="Москва">Москва</option>
    <option value="Казань">Казань</option>
    <option value="Санкт-Петербург">Санкт-Петербург</option>
  </template>
  <template id="type-options">
    <option value="">Любой тип</option>
    <option value="Прогулка">Прогулка</option>
    <option value="Общение">Общение</option>
    <option value="Игры">Игры</option>
  </template>
  <template id="date-options">
    <option value="">Любая дата</option>
    <option value="Сегодня">Сегодня</option>
    <option value="Завтра">Завтра</option>
    <option value="На неделе">На неделе</option>
  </template>
  <template id="gender-options">
    <option value="">Любой пол</option>
    <option value="Мужской">Мужской</option>
    <option value="Женский">Женский</option>
    <option value="Не важно">Не важно</option>
  </template>
  <template id="sort-options">
    <option value="По рейтингу">По рейтингу</option>
    <option value="Верифицированные">Верифицированные</option>
    <option value="Новые">Новые</option>
    <option value="Старые">Старые</option>
  </template>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Modal Component
    function Modal({ children, onClose }) {
      return (
        <div className="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-3xl shadow-lg max-w-md w-full">
            {children}
            <button onClick={onClose} className="mt-4 text-gray-500 hover:text-gray-700">Закрыть</button>
          </div>
        </div>
      );
    }

    // Registration Modal
    function RegistrationModal({ onRegister }) {
      const [name, setName] = useState('');
      const [birthdate, setBirthdate] = useState('');
      const [gender, setGender] = useState('Не важно');
      const [about, setAbout] = useState('');
      const [avatar, setAvatar] = useState('https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/cf5343120913219.60bb24ccb2f89.jpg');
      const [error, setError] = useState('');

      const handleNext = () => {
        if (!name || !birthdate || !about) {
          setError('Пожалуйста, заполните все обязательные поля');
          return;
        }
        onRegister({ name, birthdate, gender, about, avatar });
      };

      return (
        <Modal onClose={() => {}}>
          <h2 className="text-xl font-bold mb-4">Регистрация</h2>
          <div className="flex flex-col gap-4">
            <div className="flex gap-4">
              <img src={avatar} alt="Аватар" className="w-16 h-16 rounded-full" loading="lazy" />
              <input
                type="text"
                placeholder="Имя *"
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="p-2 rounded-lg border"
                required
                aria-label="Имя"
              />
            </div>
            <input
              type="date"
              value={birthdate}
              onChange={(e) => setBirthdate(e.target.value)}
              className="p-2 rounded-lg border"
              required
              aria-label="Дата рождения"
            />
            <select
              value={gender}
              onChange={(e) => setGender(e.target.value)}
              className="p-2 rounded-lg border"
              aria-label="Пол"
            >
              <option value="Мужской">Мужской</option>
              <option value="Женский">Женский</option>
              <option value="Не важно">Не важно</option>
            </select>
            <textarea
              placeholder="О себе *"
              value={about}
              onChange={(e) => setAbout(e.target.value)}
              className="p-2 rounded-lg border w-full"
              required
              aria-label="О себе"
            />
            {error && <p className="text-red-500">{error}</p>}
            <div className="flex gap-4">
              <button className="bg-gray-300 px-4 py-2 rounded-lg">Отмена</button>
              <button onClick={handleNext} className="bg-blue-500 text-white px-4 py-2 rounded-lg">Далее</button>
            </div>
          </div>
        </Modal>
      );
    }

    // Edit Profile Modal (New)
    function EditProfileModal({ user, onSave, onClose }) {
      const [name, setName] = useState(user.name);
      const [birthdate, setBirthdate] = useState(user.birthdate);
      const [gender, setGender] = useState(user.gender);
      const [about, setAbout] = useState(user.about);
      const [avatar, setAvatar] = useState(user.avatar);
      const [error, setError] = useState('');

      const handleSave = () => {
        if (!name || !birthdate || !about) {
          setError('Пожалуйста, заполните все обязательные поля');
          return;
        }
        onSave({ ...user, name, birthdate, gender, about, avatar });
        onClose();
      };

      return (
        <Modal onClose={onClose}>
          <h2 className="text-xl font-bold mb-4">Редактировать профиль</h2>
          <div className="flex flex-col gap-4">
            <div className="flex gap-4">
              <img src={avatar} alt="Аватар" className="w-16 h-16 rounded-full" loading="lazy" />
              <input
                type="text"
                placeholder="Имя *"
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="p-2 rounded-lg border"
                required
                aria-label="Имя"
              />
            </div>
            <input
              type="date"
              value={birthdate}
              onChange={(e) => setBirthdate(e.target.value)}
              className="p-2 rounded-lg border"
              required
              aria-label="Дата рождения"
            />
            <select
              value={gender}
              onChange={(e) => setGender(e.target.value)}
              className="p-2 rounded-lg border"
              aria-label="Пол"
            >
              <option value="Мужской">Мужской</option>
              <option value="Женский">Женский</option>
              <option value="Не важно">Не важно</option>
            </select>
            <textarea
              placeholder="О себе *"
              value={about}
              onChange={(e) => setAbout(e.target.value)}
              className="p-2 rounded-lg border w-full"
              required
              aria-label="О себе"
            />
            {error && <p className="text-red-500">{error}</p>}
            <div className="flex gap-4">
              <button onClick={onClose} className="bg-gray-300 px-4 py-2 rounded-lg">Отмена</button>
              <button onClick={handleSave} className="bg-blue-500 text-white px-4 py-2 rounded-lg">Сохранить</button>
            </div>
          </div>
        </Modal>
      );
    }

    // Search Bar Component
    function SearchBar({ onSearch, mode, onModeChange }) {
      const [query, setQuery] = useState('');
      const [filters, setFilters] = useState({
        city: '',
        type: '',
        date: '',
        gender: '',
        sort: 'По рейтингу'
      });

      const handleFilterChange = (e) => {
        const { name, value } = e.target;
        setFilters(prevFilters => {
          const updatedFilters = { ...prevFilters, [name]: value };
          onSearch(query, updatedFilters, mode);
          return updatedFilters;
        });
      };

      const handleSearchChange = (e) => {
        const newQuery = e.target.value;
        setQuery(newQuery);
        onSearch(newQuery, filters, mode);
      };

      const handleModeChange = (e) => {
        const newMode = e.target.value;
        onModeChange(newMode);
        const updatedFilters = {
          ...filters,
          type: newMode === 'friends' ? '' : filters.type,
          date: newMode === 'friends' ? '' : filters.date
        };
        setFilters(updatedFilters);
        onSearch(query, updatedFilters, newMode);
      };

      return (
        <section className="p-4">
          <input
            type="search"
            placeholder={mode === 'events' ? 'Поиск событий...' : 'Поиск друзей...'}
            value={query}
            onChange={handleSearchChange}
            className="w-full p-2 mb-4 rounded-[22px] border"
            aria-label={mode === 'events' ? 'Поиск событий' : 'Поиск друзей'}
          />
          <div className="flex flex-wrap gap-2 mb-4">
            <select
              name="mode"
              value={mode}
              onChange={handleModeChange}
              className="p-2 rounded-lg border"
              aria-label="Режим"
            >
              <option value="events">События</option>
              <option value="friends">Друзья</option>
            </select>
          </div>
          <fieldset className="flex flex-wrap gap-2">
            <legend className="sr-only">Фильтры</legend>
            <select name="city" value={filters.city} onChange={handleFilterChange} className="p-2 rounded-lg border" aria-label="Город">
              <option value="">Любой город</option>
              <option value="Москва">Москва</option>
              <option value="Казань">Казань</option>
              <option value="Санкт-Петербург">Санкт-Петербург</option>
            </select>
            {mode === 'events' && (
              <>
                <select name="type" value={filters.type} onChange={handleFilterChange} className="p-2 rounded-lg border" aria-label="Вид">
                  <option value="">Любой тип</option>
                  <option value="Прогулка">Прогулка</option>
                  <option value="Общение">Общение</option>
                  <option value="Игры">Игры</option>
                </select>
                <select name="date" value={filters.date} onChange={handleFilterChange} className="p-2 rounded-lg border" aria-label="Дата">
                  <option value="">Любая дата</option>
                  <option value="Сегодня">Сегодня</option>
                  <option value="Завтра">Завтра</option>
                  <option value="На неделе">На неделе</option>
                </select>
              </>
            )}
            <select name="gender" value={filters.gender} onChange={handleFilterChange} className="p-2 rounded-lg border" aria-label="Пол">
              <option value="">Любой пол</option>
              <option value="Мужской">Мужской</option>
              <option value="Женский">Женский</option>
              <option value="Не важно">Не важно</option>
            </select>
            <select name="sort" value={filters.sort} onChange={handleFilterChange} className="p-2 rounded-lg border" aria-label="Сортировка">
              <option value="По рейтингу">По рейтингу</option>
              <option value="Верифицированные">Верифицированные</option>
              <option value="Новые">Новые</option>
              <option value="Старые">Старые</option>
            </select>
          </fieldset>
        </section>
      );
    }

    // Announcement Component
    function Announcement({ data, isOwn, isFavorite, isHidden, onLike, onDislike, onShowParticipants, onEdit, onDelete, activeMenuId, openMenu, closeMenu, userActions, onViewProfile, onAddToFavorites, onRemoveFromFavorites, onHide, onShowAgain, onReport }) {
      const [expanded, setExpanded] = useState(false);
      const [menuPosition, setMenuPosition] = useState({ top: 0, left: 0, direction: 'below' });
      const buttonRef = useRef(null);
      const showOptions = activeMenuId === data.id;

      const updateMenuPosition = () => {
        if (buttonRef.current && showOptions) {
          const rect = buttonRef.current.getBoundingClientRect();
          const menuHeight = 120;
          const viewportHeight = window.innerHeight;
          const spaceBelow = viewportHeight - rect.bottom;
          const direction = spaceBelow < menuHeight ? 'above' : 'below';

          setMenuPosition({
            top: direction === 'below' ? rect.bottom + window.scrollY + 4 : rect.top + window.scrollY - menuHeight - 4,
            left: rect.right + window.scrollX - 120,
            direction
          });
        }
      };

      useEffect(() => {
        updateMenuPosition();
        if (showOptions) {
          const interval = setInterval(updateMenuPosition, 50);
          return () => clearInterval(interval);
        }
      }, [expanded, showOptions]);

      useEffect(() => {
        const handleOutsideClick = (e) => {
          if (buttonRef.current && !buttonRef.current.contains(e.target) && !e.target.closest('.options-menu')) {
            closeMenu();
          }
        };
        document.addEventListener('click', handleOutsideClick);
        return () => document.removeEventListener('click', handleOutsideClick);
      }, [closeMenu]);

      const handleOptionsClick = (e) => {
        e.stopPropagation();
        if (showOptions) {
          closeMenu();
        } else {
          openMenu(data.id);
          updateMenuPosition();
        }
      };

      const handleShare = async () => {
        const shareData = {
          title: data.title,
          text: data.description,
          url: `https://app.example.com/announcement/${data.id}`
        };
        try {
          if (navigator.share) {
            await navigator.share(shareData);
          } else {
            await navigator.clipboard.writeText(shareData.url);
            alert('Ссылка скопирована в буфер обмена');
          }
        } catch (err) {
          console.error('Ошибка при попытке поделиться:', err);
        }
        closeMenu();
      };

      return (
        <>
          <article
            onClick={(e) => {
              if (!e.target.closest('button') && !e.target.closest('a')) setExpanded(!expanded);
            }}
            className={`p-4 rounded-[22px] border ${isOwn ? 'border-blue-500' : 'border-gray-300'} bg-white cursor-pointer announcement-expanded w-full`}
            style={{ maxHeight: expanded ? '500px' : '150px', overflow: 'hidden' }}
          >
            <h3 className="font-bold announcement-title">{data.title}</h3>
            {expanded && (
              <div className="mt-2">
                <p className="announcement-description">{data.description}</p>
                <div className="text-sm text-gray-500">{data.metatags.join(', ')} • {data.createdAt}</div>
                <div className="flex items-center gap-2 mt-2">
                  <button onClick={() => onViewProfile(data.creatorId)} className="focus:outline-none">
                    <img src={data.creatorAvatar} alt="Аватар создателя" className="w-8 h-8 rounded-full" loading="lazy" />
                  </button>
                  <button
                    onClick={() => onShowParticipants(data.id, data.title)}
                    className="bg-blue-500 text-white px-2 py-1 rounded ml-2"
                    aria-label="Участники"
                  >
                    Участники ({data.participants})
                  </button>
                </div>
              </div>
            )}
            <div className="flex justify-between items-center mt-2">
              <div className="flex items-center gap-1">
                <button onClick={() => onViewProfile(data.creatorId)} className="text-blue-500 focus:outline-none">{data.creatorName}</button>
                {data.age && <span className="ml-1">{data.age} лет</span>}
              </div>
              <div className="flex gap-2 items-center">
                <span>{data.participants}</span>
                <button onClick={() => onLike(data.id)} className="p-1" aria-label="Лайк">
                  <img src="https://raw.githubusercontent.com/Uno5512/FrendsHub/main/2.png" alt="Лайк" className="like-dislike-img" />
                </button>
                <button onClick={() => onDislike(data.id)} className="p-1" aria-label="Дизлайк">
                  <img src="https://raw.githubusercontent.com/Uno5512/FrendsHub/main/1.png" alt="Дизлайк" className="like-dislike-img" />
                </button>
                <button
                  ref={buttonRef}
                  onClick={handleOptionsClick}
                  className="text-gray-500"
                  aria-label="Опции"
                >
                  ⋯
                </button>
              </div>
            </div>
          </article>
          {showOptions && (
            <div
              className="fixed bg-white border rounded shadow-lg p-2 w-32 z-50 options-menu"
              style={{ top: `${menuPosition.top}px`, left: `${menuPosition.left}px` }}
            >
              {isOwn ? (
                <>
                  <button onClick={() => { onEdit(data); closeMenu(); }} className="block w-full text-left hover:bg-gray-100 p-1">Редактировать</button>
                  <button onClick={() => { onDelete(data.id); closeMenu(); }} className="block w-full text-left hover:bg-gray-100 p-1">Удалить</button>
                  <button onClick={handleShare} className="block w-full text-left hover:bg-gray-100 p-1">Поделиться</button>
                </>
              ) : isFavorite ? (
                <>
                  <button onClick={handleShare} className="block w-full text-left hover:bg-gray-100 p-1">Поделиться</button>
                  <button onClick={() => { onRemoveFromFavorites(data.id); closeMenu(); }} className="block w-full text-left hover:bg-gray-100 p-1">Убрать из избранного</button>
                </>
              ) : isHidden ? (
                <>
                  <button onClick={handleShare} className="block w-full text-left hover:bg-gray-100 p-1">Поделиться</button>
                  <button onClick={() => { onShowAgain(data.id); closeMenu(); }} className="block w-full text-left hover:bg-gray-100 p-1">Показывать заново</button>
                </>
              ) : (
                <>
                  <button onClick={handleShare} className="block w-full text-left hover:bg-gray-100 p-1">Поделиться</button>
                  <button onClick={() => { onAddToFavorites(data.id); closeMenu(); }} className="block w-full text-left hover:bg-gray-100 p-1">В избранное</button>
                  <button onClick={() => { onHide(data.id); closeMenu(); }} className="block w-full text-left hover:bg-gray-100 p-1">Не показывать</button>
                  <button onClick={() => { onReport(data.id); closeMenu(); }} className="block w-full text-left hover:bg-gray-100 p-1">Пожаловаться</button>
                </>
              )}
            </div>
          )}
        </>
      );
    }

    // Report Modal
    function ReportModal({ onClose, onSubmit }) {
      const [reportText, setReportText] = useState('');
      const maxLength = 200;

      const handleSubmit = () => {
        console.log('Жалоба отправлена:', reportText);
        onSubmit(reportText);
        onClose();
      };

      return (
        <Modal onClose={onClose}>
          <h2 className="text-xl font-bold mb-4">Пожаловаться</h2>
          <div className="relative mb-4">
            <textarea
              placeholder="Опишите причину жалобы"
              value={reportText}
              onChange={(e) => setReportText(e.target.value)}
              maxLength={maxLength}
              className="p-2 rounded-lg border w-full"
              aria-label="Текст жалобы"
            />
            <span className="absolute right-2 bottom-2 text-sm text-gray-500">
              {maxLength - reportText.length}
            </span>
          </div>
          <div className="flex gap-4">
            <button onClick={onClose} className="bg-gray-300 px-4 py-2 rounded-lg">Закрыть</button>
            <button onClick={handleSubmit} className="bg-blue-500 text-white px-4 py-2 rounded-lg">Отправить</button>
          </div>
        </Modal>
      );
    }

    // Send Contacts Modal
    function SendContactsModal({ onClose, onSubmit, announcementTitle }) {
      const [phone, setPhone] = useState('');
      const [telegram, setTelegram] = useState('');

      const handleSubmit = () => {
        if (!phone || !telegram) {
          alert('Пожалуйста, заполните все поля');
          return;
        }
        onSubmit({ phone, telegram });
        onClose();
      };

      return (
        <Modal onClose={onClose}>
          <h2 className="text-xl font-bold mb-4">Отправить контакты для: {announcementTitle}</h2>
          <div className="flex flex-col gap-4">
            <input
              type="tel"
              placeholder="Номер телефона"
              value={phone}
              onChange={(e) => setPhone(e.target.value)}
              className="p-2 rounded-lg border"
              aria-label="Номер телефона"
            />
            <input
              type="text"
              placeholder="Ник в Telegram (@username)"
              value={telegram}
              onChange={(e) => setTelegram(e.target.value)}
              className="p-2 rounded-lg border"
              aria-label="Ник в Telegram"
            />
            <div className="flex gap-4">
              <button onClick={onClose} className="bg-gray-300 px-4 py-2 rounded-lg">Отмена</button>
              <button onClick={handleSubmit} className="bg-blue-500 text-white px-4 py-2 rounded-lg">Отправить</button>
            </div>
          </div>
        </Modal>
      );
    }

    // Invite Modal (New)
    function InviteModal({ ownAnnouncements, recipientId, recipientName, onSendContacts, onCreateAnnouncement, onClose }) {
      return (
        <Modal onClose={onClose}>
          <h2 className="text-xl font-bold mb-4">Пригласить: {recipientName}</h2>
          <div className="max-h-64 overflow-y-auto space-y-2">
            {ownAnnouncements.length > 0 ? (
              ownAnnouncements.map(ann => (
                <div key={ann.id} className="flex justify-between items-center p-2 border-b">
                  <span>{ann.title}</span>
                  <button
                    onClick={() => onSendContacts(ann.id, ann.title, [recipientId])}
                    className="bg-blue-500 text-white px-2 py-1 rounded"
                  >
                    Отправить контакты
                  </button>
                </div>
              ))
            ) : (
              <div className="text-gray-500 text-center">
                <p>Нет созданных объявлений</p>
                <button
                  onClick={onCreateAnnouncement}
                  className="bg-blue-500 text-white px-4 py-2 rounded-lg mt-2"
                >
                  Создать объявление
                </button>
              </div>
            )}
          </div>
        </Modal>
      );
    }

    // Profile Modal
    function ProfileModal({ user, currentUser, announcements, onClose, onLike, onDislike, onShowParticipants, onAddToFavorites, onRemoveFromFavorites, onHide, onShowAgain, onReport, onViewProfile, userActions, activeMenuId, openMenu, closeMenu }) {
      const [isAnnouncementsOpen, setIsAnnouncementsOpen] = useState(false);
      const userAnnouncements = announcements.filter(a => a.creatorId === user.id);

      const handleShareProfile = async () => {
        const shareData = {
          title: `Профиль ${user.name}`,
          text: user.about,
          url: `https://app.example.com/profile/${user.id}`
        };
        try {
          if (navigator.share) {
            await navigator.share(shareData);
          } else {
            await navigator.clipboard.writeText(shareData.url);
            alert('Ссылка на профиль скопирована в буфер обмена');
          }
        } catch (err) {
          console.error('Ошибка при попытке поделиться:', err);
        }
      };

      return (
        <Modal onClose={onClose}>
          <h2 className="text-xl font-bold mb-4">Профиль: {user.name}</h2>
          <div className="flex flex-col gap-4">
            <img src={user.avatar} alt="Аватар" className="w-16 h-16 rounded-full" loading="lazy" />
            <p><strong>Имя:</strong> {user.name}</p>
            {user.birthdate && <p><strong>Дата рождения:</strong> {user.birthdate}</p>}
            <p><strong>Пол:</strong> {user.gender}</p>
            <p><strong>О себе:</strong> {user.about}</p>
            <button onClick={handleShareProfile} className="bg-blue-500 text-white px-4 py-2 rounded-lg">Поделиться профилем</button>
            <h3
              className="font-bold cursor-pointer flex items-center"
              onClick={() => setIsAnnouncementsOpen(!isAnnouncementsOpen)}
            >
              Объявления {isAnnouncementsOpen ? '↑' : '↓'}
            </h3>
            <div
              className="accordion-content"
              style={{ maxHeight: isAnnouncementsOpen ? '400px' : '0' }}
            >
              <div className="space-y-4 max-h-64 overflow-y-auto">
                {userAnnouncements.length > 0 ? (
                  userAnnouncements.map(a => (
                    <Announcement
                      key={a.id}
                      data={a}
                      isOwn={a.creatorId === currentUser.id}
                      isFavorite={false}
                      isHidden={false}
                      onLike={onLike}
                      onDislike={onDislike}
                      onShowParticipants={onShowParticipants}
                      onEdit={() => {}}
                      onDelete={() => {}}
                      activeMenuId={activeMenuId}
                      openMenu={openMenu}
                      closeMenu={closeMenu}
                      userActions={userActions}
                      onViewProfile={onViewProfile}
                      onAddToFavorites={onAddToFavorites}
                      onRemoveFromFavorites={onRemoveFromFavorites}
                      onHide={onHide}
                      onShowAgain={onShowAgain}
                      onReport={onReport}
                    />
                  ))
                ) : (
                  <p className="text-gray-500">Нет объявлений</p>
                )}
              </div>
            </div>
          </div>
        </Modal>
      );
    }

    // Participants Modal (Updated)
    function ParticipantsModal({ announcementId, announcementTitle, participants, isOwn, onClose }) {
      return (
        <Modal onClose={onClose}>
          <h2 className="text-xl font-bold mb-4">Участники: {announcementTitle}</h2>
          <div className="max-h-64 overflow-y-auto space-y-2">
            {participants.length > 0 ? (
              participants.map(p => (
                <div key={p.id} className="flex items-center gap-2 p-2 border-b">
                  <img src={p.avatar} alt="Участник" className="w-8 h-8 rounded-full" loading="lazy" />
                  <span>{p.name}</span>
                </div>
              ))
            ) : (
              <p className="text-gray-500">Нет участников</p>
            )}
          </div>
        </Modal>
      );
    }

    // Account Modal (Updated)
    function AccountModal({ user, announcements, applications, favorites, hiddenAnnouncements, invitations, onClose, onLike, onDislike, onShowParticipants, onAddToFavorites, onRemoveFromFavorites, onHide, onShowAgain, onReport, onViewProfile, userActions, activeMenuId, openMenu, closeMenu, onEditProfile }) {
      const [isFavoritesOpen, setIsFavoritesOpen] = useState(false);
      const [isApplicationsOpen, setIsApplicationsOpen] = useState(false);
      const [isHiddenOpen, setIsHiddenOpen] = useState(false);
      const [isInvitationsOpen, setIsInvitationsOpen] = useState(false);
      const ownAnnouncements = announcements.filter(a => a.creatorId === user.id);
      const favoriteAnnouncements = announcements.filter(a => favorites.includes(a.id));
      const hiddenAnnouncementsList = announcements.filter(a => hiddenAnnouncements.includes(a.id));
      const userInvitations = invitations.filter(i => i.recipientId === user.id);

      return (
        <Modal onClose={onClose}>
          <h2 className="text-xl font-bold mb-4">Аккаунт</h2>
          <div className="flex flex-col gap-4">
            <img src={user.avatar} alt="Аватар" className="w-16 h-16 rounded-full" loading="lazy" />
            <p><strong>Имя:</strong> {user.name}</p>
            {user.birthdate && <p><strong>Дата рождения:</strong> {user.birthdate}</p>}
            <p><strong>Пол:</strong> {user.gender}</p>
            <p><strong>О себе:</strong> {user.about}</p>
            <button onClick={onEditProfile} className="bg-blue-500 text-white px-4 py-2 rounded-lg">Изменить</button>
            <h3
              className="font-bold cursor-pointer flex items-center"
              onClick={() => setIsFavoritesOpen(!isFavoritesOpen)}
            >
              Избранное {isFavoritesOpen ? '↑' : '↓'}
            </h3>
            <div
              className="accordion-content"
              style={{ maxHeight: isFavoritesOpen ? '400px' : '0' }}
            >
              <div className="space-y-4 max-h-64 overflow-y-auto">
                {favoriteAnnouncements.length > 0 ? (
                  favoriteAnnouncements.map(a => (
                    <Announcement
                      key={a.id}
                      data={a}
                      isOwn={a.creatorId === user.id}
                      isFavorite={true}
                      isHidden={false}
                      onLike={onLike}
                      onDislike={onDislike}
                      onShowParticipants={onShowParticipants}
                      onEdit={() => {}}
                      onDelete={() => {}}
                      activeMenuId={activeMenuId}
                      openMenu={openMenu}
                      closeMenu={closeMenu}
                      userActions={userActions}
                      onViewProfile={onViewProfile}
                      onAddToFavorites={onAddToFavorites}
                      onRemoveFromFavorites={onRemoveFromFavorites}
                      onHide={onHide}
                      onShowAgain={onShowAgain}
                      onReport={onReport}
                    />
                  ))
                ) : (
                  <p className="text-gray-500">Нет избранных объявлений</p>
                )}
              </div>
            </div>
            <h3
              className="font-bold cursor-pointer flex items-center"
              onClick={() => setIsApplicationsOpen(!isApplicationsOpen)}
            >
              Заявки {isApplicationsOpen ? '↑' : '↓'}
            </h3>
            <div
              className="accordion-content"
              style={{ maxHeight: isApplicationsOpen ? '400px' : '0' }}
            >
              <div className="space-y-4 max-h-64 overflow-y-auto">
                {ownAnnouncements.length > 0 ? (
                  ownAnnouncements.map(a => (
                    <Announcement
                      key={a.id}
                      data={a}
                      isOwn={true}
                      isFavorite={false}
                      isHidden={false}
                      onLike={onLike}
                      onDislike={onDislike}
                      onShowParticipants={onShowParticipants}
                      onEdit={() => {}}
                      onDelete={() => {}}
                      activeMenuId={activeMenuId}
                      openMenu={openMenu}
                      closeMenu={closeMenu}
                      userActions={userActions}
                      onViewProfile={onViewProfile}
                      onAddToFavorites={onAddToFavorites}
                      onRemoveFromFavorites={onRemoveFromFavorites}
                      onHide={onHide}
                      onShowAgain={onShowAgain}
                      onReport={onReport}
                    />
                  ))
                ) : (
                  <p className="text-gray-500">Нет созданных объявлений</p>
                )}
              </div>
            </div>
            <h3
              className="font-bold cursor-pointer flex items-center"
              onClick={() => setIsHiddenOpen(!isHiddenOpen)}
            >
              Скрытые объявления {isHiddenOpen ? '↑' : '↓'}
            </h3>
            <div
              className="accordion-content"
              style={{ maxHeight: isHiddenOpen ? '400px' : '0' }}
            >
              <div className="space-y-4 max-h-64 overflow-y-auto">
                {hiddenAnnouncementsList.length > 0 ? (
                  hiddenAnnouncementsList.map(a => (
                    <Announcement
                      key={a.id}
                      data={a}
                      isOwn={a.creatorId === user.id}
                      isFavorite={false}
                      isHidden={true}
                      onLike={onLike}
                      onDislike={onDislike}
                      onShowParticipants={onShowParticipants}
                      onEdit={() => {}}
                      onDelete={() => {}}
                      activeMenuId={activeMenuId}
                      openMenu={openMenu}
                      closeMenu={closeMenu}
                      userActions={userActions}
                      onViewProfile={onViewProfile}
                      onAddToFavorites={onAddToFavorites}
                      onRemoveFromFavorites={onRemoveFromFavorites}
                      onHide={onHide}
                      onShowAgain={onShowAgain}
                      onReport={onReport}
                    />
                  ))
                ) : (
                  <p className="text-gray-500">Нет скрытых объявлений</p>
                )}
              </div>
            </div>
            <h3
              className="font-bold cursor-pointer flex items-center"
              onClick={() => setIsInvitationsOpen(!isInvitationsOpen)}
            >
              Приглашения {isInvitationsOpen ? '↑' : '↓'}
            </h3>
            <div
              className="accordion-content"
              style={{ maxHeight: isInvitationsOpen ? '400px' : '0' }}
            >
              <div className="space-y-4 max-h-64 overflow-y-auto">
                {userInvitations.length > 0 ? (
                  userInvitations.map((inv, index) => (
                    <div key={index} className="p-4 rounded-[22px] border border-gray-300 bg-white">
                      <p><strong>От:</strong> {inv.senderName}</p>
                      <p><strong>Событие:</strong> {inv.isPersonal ? 'Личное приглашение' : inv.announcementTitle}</p>
                      <p><strong>Телефон:</strong> {inv.phone}</p>
                      <p><strong>Telegram:</strong> {inv.telegram}</p>
                    </div>
                  ))
                ) : (
                  <p className="text-gray-500">Нет приглашений</p>
                )}
              </div>
            </div>
          </div>
        </Modal>
      );
    }

    // Create Announcement Modal
    function CreateAnnouncementModal({ onCreate, onClose }) {
      const [title, setTitle] = useState('');
      const [description, setDescription] = useState('');
      const [filters, setFilters] = useState({ city: 'Москва', type: 'Прогулка', date: 'Сегодня', gender: 'Не важно' });
      const titleMaxLength = 64;
      const descriptionMaxLength = 400;

      return (
        <Modal onClose={onClose}>
          <h2 className="text-xl font-bold mb-4">Создать объявление</h2>
          <div className="relative mb-4">
            <input
              type="text"
              placeholder="Заголовок"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              maxLength={titleMaxLength}
              className="p-2 rounded-lg border w-full"
              aria-label="Заголовок"
            />
            <span className="absolute right-2 top-2 text-sm text-gray-500">
              {titleMaxLength - title.length}
            </span>
          </div>
          <div className="relative mb-4">
            <textarea
              placeholder="Описание"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              maxLength={descriptionMaxLength}
              className="p-2 rounded-lg border w-full"
              aria-label="Описание"
            />
            <span className="absolute right-2 bottom-2 text-sm text-gray-500">
              {descriptionMaxLength - description.length}
            </span>
          </div>
          <div className="flex flex-wrap gap-2">
            <select name="city" onChange={(e) => setFilters(f => ({ ...f, city: e.target.value }))} className="p-2 rounded-lg border" aria-label="Город">
              <option value="Москва">Москва</option>
              <option value="Казань">Казань</option>
              <option value="Санкт-Петербург">Санкт-Петербург</option>
            </select>
            <select name="type" onChange={(e) => setFilters(f => ({ ...f, type: e.target.value }))} className="p-2 rounded-lg border" aria-label="Вид">
              <option value="Прогулка">Прогулка</option>
              <option value="Общение">Общение</option>
              <option value="Игры">Игры</option>
            </select>
            <select name="date" onChange={(e) => setFilters(f => ({ ...f, date: e.target.value }))} className="p-2 rounded-lg border" aria-label="Дата">
              <option value="Сегодня">Сегодня</option>
              <option value="Завтра">Завтра</option>
              <option value="На неделе">На неделе</option>
            </select>
            <select name="gender" onChange={(e) => setFilters(f => ({ ...f, gender: e.target.value }))} className="p-2 rounded-lg border" aria-label="Пол">
              <option value="Мужской">Мужской</option>
              <option value="Женский">Женский</option>
              <option value="Не важно">Не важно</option>
            </select>
          </div>
          <div className="flex gap-4 mt-4">
            <button onClick={onClose} className="bg-gray-300 px-4 py-2 rounded-lg">Отмена</button>
            <button onClick={() => { onCreate({ title, description, metatags: Object.values(filters) }); onClose(); }} className="bg-blue-500 text-white px-4 py-2 rounded-lg">Отправить</button>
          </div>
        </Modal>
      );
    }

    // Profile Card Component (Updated)
    function ProfileCard({ user, onViewProfile, onLike, onDislike, userActions, activeMenuId, openMenu, closeMenu, onReport, onInvite }) {
      const [expanded, setExpanded] = useState(false);
      const [menuPosition, setMenuPosition] = useState({ top: 0, left: 0, direction: 'below' });
      const buttonRef = useRef(null);
      const showOptions = activeMenuId === `profile-${user.id}`;

      const age = user.birthdate ? (() => {
        const today = new Date('2025-05-19');
        const birth = new Date(user.birthdate);
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
          age--;
        }
        return age >= 6 ? age : null;
      })() : null;

      const updateMenuPosition = () => {
        if (buttonRef.current && showOptions) {
          const rect = buttonRef.current.getBoundingClientRect();
          const menuHeight = 80;
          const viewportHeight = window.innerHeight;
          const spaceBelow = viewportHeight - rect.bottom;
          const direction = spaceBelow < menuHeight ? 'above' : 'below';

          setMenuPosition({
            top: direction === 'below' ? rect.bottom + window.scrollY + 4 : rect.top + window.scrollY - menuHeight - 4,
            left: rect.right + window.scrollX - 120,
            direction
          });
        }
      };

      useEffect(() => {
        updateMenuPosition();
        if (showOptions) {
          const interval = setInterval(updateMenuPosition, 50);
          return () => clearInterval(interval);
        }
      }, [expanded, showOptions]);

      useEffect(() => {
        const handleOutsideClick = (e) => {
          if (buttonRef.current && !buttonRef.current.contains(e.target) && !e.target.closest('.options-menu')) {
            closeMenu();
          }
        };
        document.addEventListener('click', handleOutsideClick);
        return () => document.removeEventListener('click', handleOutsideClick);
      }, [closeMenu]);

      const handleOptionsClick = (e) => {
        e.stopPropagation();
        if (showOptions) {
          closeMenu();
        } else {
          openMenu(`profile-${user.id}`);
          updateMenuPosition();
        }
      };

      const handleShare = async () => {
        const shareData = {
          title: `Профиль ${user.name}`,
          text: user.about,
          url: `https://app.example.com/profile/${user.id}`
        };
        try {
          if (navigator.share) {
            await navigator.share(shareData);
          } else {
            await navigator.clipboard.writeText(shareData.url);
            alert('Ссылка на профиль скопирована в буфер обмена');
          }
        } catch (err) {
          console.error('Ошибка при попытке поделиться:', err);
        }
        closeMenu();
      };

      return (
        <>
          <article
            onClick={(e) => {
              if (!e.target.closest('button') && !e.target.closest('a')) setExpanded(!expanded);
            }}
            className="p-4 rounded-[22px] border border-gray-300 bg-white cursor-pointer profile-expanded w-full"
            style={{ maxHeight: expanded ? '300px' : '120px', overflow: 'hidden' }}
          >
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-2">
                <button onClick={() => onViewProfile(user.id)} className="focus:outline-none">
                  <img src={user.avatar} alt="Аватар" className="w-8 h-8 rounded-full" loading="lazy" />
                </button>
                <button onClick={() => onViewProfile(user.id)} className="text-blue-500 focus:outline-none">{user.name}</button>
                {age && <span className="ml-1">{age} лет</span>}
              </div>
              <div className="flex gap-2 items-center">
                <button onClick={() => onLike(user.id)} className="p-1" aria-label="Лайк">
                  <img src="https://raw.githubusercontent.com/Uno5512/FrendsHub/main/2.png" alt="Лайк" className="like-dislike-img" />
                </button>
                <button onClick={() => onDislike(user.id)} className="p-1" aria-label="Дизлайк">
                  <img src="https://raw.githubusercontent.com/Uno5512/FrendsHub/main/1.png" alt="Дизлайк" className="like-dislike-img" />
                </button>
                <button
                  ref={buttonRef}
                  onClick={handleOptionsClick}
                  className="text-gray-500"
                  aria-label="Опции"
                >
                  ⋯
                </button>
                <button
                  onClick={() => onInvite(user.id, user.name)}
                  className="bg-blue-500 text-white px-2 py-1 rounded"
                  aria-label="Пригласить"
                >
                  Пригласить
                </button>
              </div>
            </div>
            <p className="mt-2 profile-description">{user.about}</p>
            {expanded && (
              <div className="text-sm text-gray-500 mt-1">{user.gender}, {user.city || 'Город не указан'}</div>
            )}
          </article>
          {showOptions && (
            <div
              className="fixed bg-white border rounded shadow-lg p-2 w-32 z-50 options-menu"
              style={{ top: `${menuPosition.top}px`, left: `${menuPosition.left}px` }}
            >
              <button onClick={handleShare} className="block w-full text-left hover:bg-gray-100 p-1">Поделиться</button>
              <button onClick={() => { onReport(user.id); closeMenu(); }} className="block w-full text-left hover:bg-gray-100 p-1">Пожаловаться</button>
            </div>
          )}
        </>
      );
    }

    // Main App Component (Updated)
    function App() {
      const [user, setUser] = useState(null);
      const [isSynced, setIsSynced] = useState(null);
      const [users, setUsers] = useState([]);
      const [announcements, setAnnouncements] = useState([]);
      const [filteredAnnouncements, setFilteredAnnouncements] = useState([]);
      const [filteredUsers, setFilteredUsers] = useState([]);
      const [showAccount, setShowAccount] = useState(false);
      const [showCreate, setShowCreate] = useState(false);
      const [showProfile, setShowProfile] = useState(null);
      const [showReportModal, setShowReportModal] = useState(null);
      const [showParticipantsModal, setShowParticipantsModal] = useState(null);
      const [showSendContactsModal, setShowSendContactsModal] = useState(null);
      const [showEditProfile, setShowEditProfile] = useState(false);
      const [showInviteModal, setShowInviteModal] = useState(null);
      const [applications, setApplications] = useState([]);
      const [favorites, setFavorites] = useState([]);
      const [hiddenAnnouncements, setHiddenAnnouncements] = useState([]);
      const [invitations, setInvitations] = useState([]);
      const [currentFilters, setCurrentFilters] = useState({ query: '', filters: { city: '', type: '', date: '', gender: '', sort: 'По рейтингу' } });
      const [activeMenuId, setActiveMenuId] = useState(null);
      const [userActions, setUserActions] = useState({});
      const [mode, setMode] = useState('events');

      // Load data from localStorage
      useEffect(() => {
        const savedUser = localStorage.getItem('user');
        const savedUsers = localStorage.getItem('users');
        const savedAnnouncements = localStorage.getItem('announcements');
        const savedApplications = localStorage.getItem('applications');
        const savedFavorites = localStorage.getItem('favorites');
        const savedHiddenAnnouncements = localStorage.getItem('hiddenAnnouncements');
        const savedUserActions = localStorage.getItem('userActions');
        const savedInvitations = localStorage.getItem('invitations');

        if (savedUser) setUser(JSON.parse(savedUser));
        if (savedUsers) setUsers(JSON.parse(savedUsers));
        if (savedAnnouncements) setAnnouncements(JSON.parse(savedAnnouncements));
        if (savedApplications) setApplications(JSON.parse(savedApplications));
        if (savedFavorites) setFavorites(JSON.parse(savedFavorites));
        if (savedHiddenAnnouncements) setHiddenAnnouncements(JSON.parse(savedHiddenAnnouncements));
        if (savedUserActions) setUserActions(JSON.parse(savedUserActions));
        if (savedInvitations) setInvitations(JSON.parse(savedInvitations));

        // Initialize with default data if no user is saved
        if (!savedUser && !savedUsers) {
          const defaultUsers = [
            {
              id: 1,
              name: 'Алексей',
              birthdate: '1998-03-15',
              gender: 'Мужской',
              about: 'Люблю прогулки и настольные игры.',
              avatar: 'https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/cf5343120913219.60bb24ccb2f89.jpg',
              city: 'Москва',
              likes: 0,
              dislikes: 0
            }
          ];
          const defaultAnnouncements = [
            {
              id: 1,
              title: 'Прогулка в парке',
              description: 'Присоединяйтесь к прогулке!',
              metatags: ['Москва', 'Прогулка', 'Сегодня', 'Не важно'],
              creatorId: 1,
              creatorName: 'Алексей',
              creatorAvatar: 'https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/cf5343120913219.60bb24ccb2f89.jpg',
              age: 27,
              participants: 3,
              likes: 5,
              dislikes: 2,
              createdAt: '01.11.2023'
            }
          ];
          setUsers(defaultUsers);
          setAnnouncements(defaultAnnouncements);
          setFilteredUsers(defaultUsers);
          setFilteredAnnouncements(defaultAnnouncements);
        } else {
          setFilteredUsers(JSON.parse(savedUsers || '[]'));
          setFilteredAnnouncements(JSON.parse(savedAnnouncements || '[]').filter(a => !JSON.parse(savedHiddenAnnouncements || '[]').includes(a.id)));
        }

        if (window.Telegram && window.Telegram.WebApp) {
          window.Telegram.WebApp.ready();
          setIsSynced(window.Telegram.WebApp.isVersionAtLeast('6.0'));
        } else {
          setTimeout(() => setIsSynced(savedUser ? true : false), 1000);
        }
      }, []);

      // Save data to localStorage
      useEffect(() => {
        if (user) localStorage.setItem('user', JSON.stringify(user));
        localStorage.setItem('users', JSON.stringify(users));
        localStorage.setItem('announcements', JSON.stringify(announcements));
        localStorage.setItem('applications', JSON.stringify(applications));
        localStorage.setItem('favorites', JSON.stringify(favorites));
        localStorage.setItem('hiddenAnnouncements', JSON.stringify(hiddenAnnouncements));
        localStorage.setItem('userActions', JSON.stringify(userActions));
        localStorage.setItem('invitations', JSON.stringify(invitations));
      }, [user, users, announcements, applications, favorites, hiddenAnnouncements, userActions, invitations]);

      const openMenu = (id) => {
        setActiveMenuId(id);
      };

      const closeMenu = () => {
        setActiveMenuId(null);
      };

      const calculateAge = (birthdate) => {
        if (!birthdate) return null;
        const today = new Date('2025-05-19');
        const birth = new Date(birthdate);
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
          age--;
        }
        return age >= 6 ? age : null;
      };

      const handleRegister = (userData) => {
        const newUser = {
          ...userData,
          id: Date.now(),
          city: 'Москва',
          likes: 0,
          dislikes: 0
        };
        setUser(newUser);
        setUsers(prev => [...prev, newUser]);
        setFilteredUsers(prev => [...prev, newUser]);
        setIsSynced(true);
      };

      const handleEditProfile = (updatedUser) => {
        setUser(updatedUser);
        setUsers(prev => prev.map(u => u.id === updatedUser.id ? updatedUser : u));
        setFilteredUsers(prev => prev.map(u => u.id === updatedUser.id ? updatedUser : u));
      };

      const handleSearch = (query, filters, searchMode, newAnnouncements = announcements, newUsers = users) => {
        setCurrentFilters({ query, filters });
        if (searchMode === 'events') {
          let result = [...newAnnouncements].filter(a => !hiddenAnnouncements.includes(a.id));

          if (query.trim()) {
            const lowerQuery = query.toLowerCase();
            result = result.filter(a =>
              a.title.toLowerCase().includes(lowerQuery) ||
              a.description.toLowerCase().includes(lowerQuery) ||
              a.metatags.some(tag => tag.toLowerCase().includes(lowerQuery))
            );
          }

          if (filters.city) {
            result = result.filter(a => a.metatags.includes(filters.city));
          }
          if (filters.type) {
            result = result.filter(a => a.metatags.includes(filters.type));
          }
          if (filters.date) {
            result = result.filter(a => a.metatags.includes(filters.date));
          }
          if (filters.gender) {
            result = result.filter(a => a.metatags.includes(filters.gender));
          }

          if (filters.sort === 'По рейтингу') {
            result.sort((a, b) => (b.likes - b.dislikes) - (a.likes - a.dislikes));
          } else if (filters.sort === 'Новые') {
            result.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          } else if (filters.sort === 'Старые') {
            result.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
          } else if (filters.sort === 'Верифицированные') {
            result.sort((a, b) => (b.likes - b.dislikes) - (a.likes - a.dislikes));
          }

          setFilteredAnnouncements(result);
        } else {
          let result = [...newUsers];

          if (query.trim()) {
            const lowerQuery = query.toLowerCase();
            result = result.filter(u =>
              u.name.toLowerCase().includes(lowerQuery) ||
              u.about.toLowerCase().includes(lowerQuery) ||
              (u.city && u.city.toLowerCase().includes(lowerQuery))
            );
          }

          if (filters.city) {
            result = result.filter(u => u.city === filters.city);
          }
          if (filters.gender) {
            result = result.filter(u => u.gender === filters.gender);
          }

          if (filters.sort === 'По рейтингу') {
            result.sort((a, b) => (b.likes - b.dislikes) - (a.likes - a.dislikes));
          } else if (filters.sort === 'Новые') {
            result.sort((a, b) => b.id - a.id);
          } else if (filters.sort === 'Старые') {
            result.sort((a, b) => a.id - b.id);
          }

          setFilteredUsers(result);
        }
      };

      const handleLike = (id, isProfile = false) => {
        if (isProfile) {
          setUsers(prev => {
            const currentAction = userActions[`profile-${id}`];
            let updatedUsers = [...prev];

            if (currentAction === 'like') {
              return prev;
            }

            if (currentAction === 'dislike') {
              updatedUsers = prev.map(u =>
                u.id === id ? { ...u, dislikes: u.dislikes - 1, likes: u.likes + 1 } : u
              );
            } else {
              updatedUsers = prev.map(u =>
                u.id === id ? { ...u, likes: u.likes + 1 } : u
              );
            }

            setUserActions(prev => ({ ...prev, [`profile-${id}`]: 'like' }));
            setFilteredUsers(updatedUsers);
            if (user.id === id) setUser(updatedUsers.find(u => u.id === id));
            return updatedUsers;
          });
        } else {
          setAnnouncements(prev => {
            const currentAction = userActions[id];
            let updatedAnnouncements = [...prev];

            if (currentAction === 'like') {
              return prev;
            }

            if (currentAction === 'dislike') {
              updatedAnnouncements = prev.map(a =>
                a.id === id ? { ...a, dislikes: a.dislikes - 1, likes: a.likes + 1 } : a
              );
            } else {
              updatedAnnouncements = prev.map(a =>
                a.id === id ? { ...a, likes: a.likes + 1 } : a
              );
            }

            setUserActions(prev => ({ ...prev, [id]: 'like' }));
            handleSearch(currentFilters.query, currentFilters.filters, mode, updatedAnnouncements);
            return updatedAnnouncements;
          });
        }
      };

      const handleDislike = (id, isProfile = false) => {
        if (isProfile) {
          setUsers(prev => {
            const currentAction = userActions[`profile-${id}`];
            let updatedUsers = [...prev];

            if (currentAction === 'dislike') {
              return prev;
            }

            if (currentAction === 'like') {
              updatedUsers = prev.map(u =>
                u.id === id ? { ...u, likes: u.likes - 1, dislikes: u.dislikes + 1 } : u
              );
            } else {
              updatedUsers = prev.map(u =>
                u.id === id ? { ...u, dislikes: u.dislikes + 1 } : u
              );
            }

            setUserActions(prev => ({ ...prev, [`profile-${id}`]: 'dislike' }));
            setFilteredUsers(updatedUsers);
            if (user.id === id) setUser(updatedUsers.find(u => u.id === id));
            return updatedUsers;
          });
        } else {
          setAnnouncements(prev => {
            const currentAction = userActions[id];
            let updatedAnnouncements = [...prev];

            if (currentAction === 'dislike') {
              return prev;
            }

            if (currentAction === 'like') {
              updatedAnnouncements = prev.map(a =>
                a.id === id ? { ...a, likes: a.likes - 1, dislikes: a.dislikes + 1 } : a
              );
            } else {
              updatedAnnouncements = prev.map(a =>
                a.id === id ? { ...a, dislikes: a.dislikes + 1 } : a
              );
            }

            setUserActions(prev => ({ ...prev, [id]: 'dislike' }));
            handleSearch(currentFilters.query, currentFilters.filters, mode, updatedAnnouncements);
            return updatedAnnouncements;
          });
        }
      };

      const handleParticipate = (id) => {
        setAnnouncements(prev => {
          const updated = prev.map(a =>
            a.id === id ? { ...a, participants: a.participants + 1 } : a
          );
          setFilteredAnnouncements(prevFiltered =>
            prevFiltered.map(a =>
              a.id === id ? { ...a, participants: a.participants + 1 } : a
            )
          );
          setApplications(prev => {
            const existingApp = prev.find(app => app.announcementId === id);
            if (existingApp) {
              return prev.map(app =>
                app.announcementId === id
                  ? {
                      ...app,
                      participants: [
                        ...app.participants,
                        { id: user.id, name: user.name, avatar: user.avatar }
                      ]
                    }
                  : app
              );
            }
            return [
              ...prev,
              {
                id: Date.now(),
                announcementId: id,
                announcementTitle: updated.find(a => a.id === id).title,
                participants: [{ id: user.id, name: user.name, avatar: user.avatar }]
              }
            ];
          });
          handleSearch(currentFilters.query, currentFilters.filters, mode, updated);
          return updated;
        });
      };

      const handleShowParticipants = (id, title) => {
        setShowParticipantsModal({ id, title });
      };

      const handleSendContacts = (announcementId, announcementTitle, selectedParticipantIds, isPersonal = false) => {
        setShowSendContactsModal({ announcementId, announcementTitle, selectedParticipantIds, isPersonal });
      };

      const handleSubmitContacts = ({ phone, telegram }, { announcementId, announcementTitle, selectedParticipantIds, isPersonal }) => {
        const newInvitations = selectedParticipantIds.map(recipientId => ({
          id: Date.now() + recipientId,
          senderId: user.id,
          senderName: user.name,
          phone,
          telegram,
          announcementId,
          announcementTitle,
          recipientId,
          isPersonal
        }));
        setInvitations(prev => [...prev, ...newInvitations]);
      };

      const handleInvite = (recipientId, recipientName) => {
        setShowInviteModal({ recipientId, recipientName });
      };

      const handleCreate = (data) => {
        const newAnnouncement = {
          ...data,
          id: Date.now(),
          creatorId: user.id,
          creatorName: user.name,
          creatorAvatar: user.avatar,
          age: calculateAge(user.birthdate),
          participants: 0,
          likes: 0,
          dislikes: 0,
          createdAt: new Date().toLocaleDateString()
        };
        setAnnouncements(prev => {
          const updated = [...prev, newAnnouncement];
          if (mode === 'events') {
            setFilteredAnnouncements(prevFiltered => {
              let result = [...prevFiltered, newAnnouncement].filter(a => !hiddenAnnouncements.includes(a.id));
              if (currentFilters.query.trim()) {
                const lowerQuery = currentFilters.query.toLowerCase();
                result = result.filter(a =>
                  a.title.toLowerCase().includes(lowerQuery) ||
                  a.description.toLowerCase().includes(lowerQuery) ||
                  a.metatags.some(tag => tag.toLowerCase().includes(lowerQuery))
                );
              }
              if (currentFilters.filters.city) {
                result = result.filter(a => a.metatags.includes(currentFilters.filters.city));
              }
              if (currentFilters.filters.type) {
                result = result.filter(a => a.metatags.includes(currentFilters.filters.type));
              }
              if (currentFilters.filters.date) {
                result = result.filter(a => a.metatags.includes(currentFilters.filters.date));
              }
              if (currentFilters.filters.gender) {
                result = result.filter(a => a.metatags.includes(currentFilters.filters.gender));
              }
              if (currentFilters.filters.sort === 'По рейтингу') {
                result.sort((a, b) => (b.likes - b.dislikes) - (a.likes - a.dislikes));
              } else if (currentFilters.filters.sort === 'Новые') {
                result.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
              } else if (currentFilters.filters.sort === 'Старые') {
                result.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
              }
              return result;
            });
          }
          return updated;
        });
      };

      const handleDelete = (id) => {
        setAnnouncements(prev => {
          const updated = prev.filter(a => a.id !== id);
          handleSearch(currentFilters.query, currentFilters.filters, mode, updated);
          return updated;
        });
        setUserActions(prev => {
          const updated = { ...prev };
          delete updated[id];
          return updated;
        });
        setFavorites(prev => prev.filter(favId => favId !== id));
        setHiddenAnnouncements(prev => prev.filter(hidId => hidId !== id));
        setApplications(prev => prev.filter(app => app.announcementId !== id));
        setInvitations(prev => prev.filter(inv => inv.announcementId !== id));
      };

      const handleAddToFavorites = (id) => {
        setFavorites(prev => prev.includes(id) ? prev : [...prev, id]);
      };

      const handleRemoveFromFavorites = (id) => {
        setFavorites(prev => prev.filter(favId => favId !== id));
      };

      const handleHide = (id) => {
        setHiddenAnnouncements(prev => [...prev, id]);
        handleSearch(currentFilters.query, currentFilters.filters, mode);
      };

      const handleShowAgain = (id) => {
        setHiddenAnnouncements(prev => prev.filter(hidId => hidId !== id));
        handleSearch(currentFilters.query, currentFilters.filters, mode);
      };

      const handleReport = (id, isProfile = false) => {
        setShowReportModal({ id, isProfile });
      };

      const handleSubmitReport = (text) => {
        // Placeholder for report submission
      };

      const handleViewProfile = (userId) => {
        if (userId === user?.id) {
          setShowAccount(true);
        } else {
          setShowProfile(userId);
        }
      };

      const handleModeChange = (newMode) => {
        setMode(newMode);
        handleSearch(currentFilters.query, currentFilters.filters, newMode);
      };

      if (!isSynced) {
        return <RegistrationModal onRegister={handleRegister} />;
      }

      return (
        <div className="min-h-screen bg-gray-100">
          {showEditProfileModal && (
            <EditProfileModal
              user={user}
              onSave={handleEditProfile}
              onClose={() => setShowEditProfileModal(false)}
            />
          )}
          {showProfile && (
            <ProfileModal
              user={users.find(u => u.id === showProfile)}
              currentUser={user}
              announcements={announcements}
              onClose={() => setShowProfile(null)}
              onLike={handleLike}
              onDislike={handleDislike}
              onShowParticipants={handleShowParticipants}
              onAddToFavorites={handleAddToFavorites}
              onRemoveFromFavorites={handleRemoveFromFavorites}
              onHide={handleHide}
              onShowAgain={handleShowAgain}
              onReport={handleReport}
              onViewProfile={handleViewProfile}
              userActions={userActions}
              activeMenuId={activeMenuId}
              openMenu={openMenu}
              closeMenu={closeMenu}
            />
          )}
          {showParticipantsModal && (
            <ParticipantsModal
              announcementId={showParticipantsModal.id}
              announcementTitle={showParticipantsModal.title}
              participants={
                applications
                  .find(app => app.announcementId === showParticipantsModal.id)
                  ?.participants || []
              }
              isOwn={announcements.find(a => a.id === showParticipantsModal.id)?.creatorId === user.id}
              currentUser={user}
              onClose={() => setShowParticipantsModal(null)}
            />
          )}
          {showAccount && (
            <AccountModal
              user={user}
              announcements={announcements}
              applications={applications}
              favorites={favorites}
              hiddenAnnouncements={hiddenAnnouncements}
              invitations={invitations}
              favoriteProfiles={favoriteProfiles}
              hiddenProfiles={hiddenProfiles}
              onClose={() => setShowAccount(false)}
              onLike={handleLike}
              onDislike={handleDislike}
              onShowParticipants={handleShowParticipants}
              onAddToFavorites={handleAddToFavorites}
              onRemoveFromFavorites={handleRemoveFromFavorites}
              onHide={handleHide}
              onShowAgain={handleShowAgain}
              onReport={handleReport}
              onViewProfile={handleViewProfile}
              userActions={userActions}
              activeMenuId={activeMenuId}
              openMenu={openMenu}
              closeMenu={closeMenu}
              onEditProfile={() => setShowEditProfileModal(true)}
            />
          )}
          {showCreate && (
            <CreateAnnouncementModal
              onCreate={handleCreate}
              onClose={() => setShowCreate(false)}
            />
          )}
          {showReportModal && (
            <ReportModal
              onClose={() => setShowReportModal(null)}
              onSubmit={handleSubmitReport}
            />
          )}
          {showSendContactsModal && (
            <SendContactsModal
              onClose={() => setShowSendContactsModal(null)}
              onSubmit={(contacts) => handleSubmitContacts(contacts, showSendContactsModal)}
              announcementTitle={showSendContactsModal.announcementTitle}
            />
          )}
          {showInviteModal && (
            <InviteModal
              ownAnnouncements={announcements.filter(a => a.creatorId === user.id)}
              onSelectAnnouncement={(id, title) =>
                handleSelectAnnouncement(id, title, showInviteModal.recipientId, showInviteModal.recipientName)
              }
              onCreateAnnouncement={() => {
                setShowInviteModal(null);
                setShowCreate(true);
              }}
              onClose={() => setShowInviteModal(null)}
            />
          )}
          <header className="flex justify-between items-center p-4 bg-white shadow">
            <h1 className="text-xl font-bold">Fibonacci Poetry</h1>
            <button
              onClick={() => setShowAccount(true)}
              className="bg-blue-500 text-white px-4 py-2 rounded-lg"
            >
              Аккаунт
            </button>
          </header>
          <SearchBar
            onSearch={handleSearch}
            mode={mode}
            onModeChange={handleModeChange}
          />
          <main className="p-4 space-y-4">
            {mode === 'events' ? (
              <>
                <button
                  onClick={() => setShowCreate(true)}
                  className="bg-blue-500 text-white px-4 py-2 rounded-lg mb-4"
                >
                  Создать объявление
                </button>
                {filteredAnnouncements.length > 0 ? (
                  filteredAnnouncements.map(a => (
                    <Announcement
                      key={a.id}
                      data={a}
                      isOwn={a.creatorId === user.id}
                      isFavorite={favorites.includes(a.id)}
                      isHidden={hiddenAnnouncements.includes(a.id)}
                      onLike={handleLike}
                      onDislike={handleDislike}
                      onShowParticipants={handleShowParticipants}
                      onEdit={() => {}}
                      onDelete={() => {}}
                      activeMenuId={activeMenuId}
                      openMenu={openMenu}
                      closeMenu={closeMenu}
                      userActions={userActions}
                      onViewProfile={handleViewProfile}
                      onAddToFavorites={handleAddToFavorites}
                      onRemoveFromFavorites={handleRemoveFromFavorites}
                      onHide={handleHide}
                      onShowAgain={handleShowAgain}
                      onReport={handleReport}
                    />
                  ))
                ) : (
                  <p className="text-gray-500">Нет объявлений</p>
                )}
              </>
            ) : (
              filteredUsers.length > 0 ? (
                filteredUsers.map(u => (
                  <ProfileCard
                    key={u.id}
                    user={u}
                    isOwn={u.id === user.id}
                    isFavorite={favoriteProfiles.includes(u.id)}
                    isHidden={hiddenProfiles.includes(u.id)}
                    onLike={() => handleLike(u.id, true)}
                    onDislike={() => handleDislike(u.id, true)}
                    onViewProfile={handleViewProfile}
                    onAddToFavorites={() => handleAddToFavorites(u.id, true)}
                    onRemoveFromFavorites={() => handleRemoveFromFavorites(u.id, true)}
                    onHide={() => handleHide(u.id, true)}
                    onShowAgain={() => handleShowAgain(u.id, true)}
                    onReport={() => handleReport(u.id, true)}
                    activeMenuId={activeMenuId}
                    openMenu={openMenu}
                    closeMenu={closeMenu}
                    userActions={userActions}
                    onInvite={handleInvite}
                  />
                ))
              ) : (
                <p className="text-gray-500">Нет профилей</p>
              )
            )}
          </main>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
